<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="写在前面这次是最后一次密码学实验，实现SM2国密算法。基本上参考的都是官方文档上的说明，一切以官方文档为主。我贴一下实验报告 实验目的（包括实验环境、实现目标等等）实现目标：SM2国密公钥算法实现 实验环境：Windows 10、Python 3.9.1、VScode 方案设计背景及原理：   有限域乘法群上离散对数问题，目前最好的求解算法称为指标计算法，是亚指数时间算法。就现在的计算能力，102">
<meta property="og:type" content="article">
<meta property="og:title" content="SM2国密算法实现">
<meta property="og:url" content="https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/index.html">
<meta property="og:site_name" content="RacerZ">
<meta property="og:description" content="写在前面这次是最后一次密码学实验，实现SM2国密算法。基本上参考的都是官方文档上的说明，一切以官方文档为主。我贴一下实验报告 实验目的（包括实验环境、实现目标等等）实现目标：SM2国密公钥算法实现 实验环境：Windows 10、Python 3.9.1、VScode 方案设计背景及原理：   有限域乘法群上离散对数问题，目前最好的求解算法称为指标计算法，是亚指数时间算法。就现在的计算能力，102">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps1.jpg">
<meta property="og:image" content="https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps2.jpg">
<meta property="og:image" content="https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps3.jpg">
<meta property="og:image" content="https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps4.jpg">
<meta property="og:image" content="https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps5.jpg">
<meta property="og:image" content="https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps6.jpg">
<meta property="og:image" content="https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps7.jpg">
<meta property="og:image" content="https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps8.jpg">
<meta property="og:image" content="https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps9.jpg">
<meta property="og:image" content="https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps10.jpg">
<meta property="og:image" content="https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps11.jpg">
<meta property="og:image" content="https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps12.jpg">
<meta property="og:image" content="https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps13.jpg">
<meta property="og:image" content="https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps14.jpg">
<meta property="og:image" content="https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps15.jpg">
<meta property="og:image" content="https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps16.jpg">
<meta property="og:image" content="https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps17.jpg">
<meta property="og:image" content="https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps18.jpg">
<meta property="og:image" content="https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps19.jpg">
<meta property="og:image" content="https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps20.jpg">
<meta property="og:image" content="https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps21.jpg">
<meta property="og:image" content="https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps22.jpg">
<meta property="og:image" content="https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps23.jpg">
<meta property="og:image" content="https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps24.jpg">
<meta property="og:image" content="https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps25.jpg">
<meta property="og:image" content="https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps26.jpg">
<meta property="og:image" content="https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps27.jpg">
<meta property="article:published_time" content="2022-12-06T16:00:00.000Z">
<meta property="article:modified_time" content="2022-12-07T02:40:26.346Z">
<meta property="article:author" content="RacerZ">
<meta property="article:tag" content="cryptography">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps1.jpg">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>SM2国密算法实现</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2022/12/12/%E6%9E%81%E8%87%B4CMS1.9.5%E5%88%86%E6%9E%90/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2022/12/06/OurPHP%E5%88%86%E6%9E%90/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/&text=SM2国密算法实现"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/&title=SM2国密算法实现"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/&is_video=false&description=SM2国密算法实现"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=SM2国密算法实现&body=Check out this article: https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/&title=SM2国密算法实现"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/&title=SM2国密算法实现"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/&title=SM2国密算法实现"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/&title=SM2国密算法实现"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/&name=SM2国密算法实现&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/&t=SM2国密算法实现"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2"><span class="toc-number">1.</span> <span class="toc-text">写在前面</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E7%9B%AE%E7%9A%84%EF%BC%88%E5%8C%85%E6%8B%AC%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83%E3%80%81%E5%AE%9E%E7%8E%B0%E7%9B%AE%E6%A0%87%E7%AD%89%E7%AD%89%EF%BC%89"><span class="toc-number">2.</span> <span class="toc-text">实验目的（包括实验环境、实现目标等等）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.</span> <span class="toc-text">方案设计</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.</span> <span class="toc-text">方案实现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90"><span class="toc-number">5.</span> <span class="toc-text">数据分析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%80%9D%E8%80%83%E4%B8%8E%E6%80%BB%E7%BB%93"><span class="toc-number">6.</span> <span class="toc-text">思考与总结</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        SM2国密算法实现
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">RacerZ</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-12-06T16:00:00.000Z" itemprop="datePublished">2022-12-07</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/cryptography/" rel="tag">cryptography</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h5 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h5><p>这次是最后一次密码学实验，实现SM2国密算法。基本上参考的都是官方文档上的说明，一切以官方文档为主。我贴一下实验报告</p>
<h5 id="实验目的（包括实验环境、实现目标等等）"><a href="#实验目的（包括实验环境、实现目标等等）" class="headerlink" title="实验目的（包括实验环境、实现目标等等）"></a>实验目的（包括实验环境、实现目标等等）</h5><p><strong>实现目标</strong>：SM2国密公钥算法实现</p>
<p><strong>实验环境</strong>：Windows 10、Python 3.9.1、VScode</p>
<h5 id="方案设计"><a href="#方案设计" class="headerlink" title="方案设计"></a>方案设计</h5><p><strong>背景及原理：</strong></p>
<blockquote>
<p> <strong>有限域乘法群上离散对数问题，目前最好的求解算法称为指标计算法，是亚指数时间算法。就现在的计算能力，1024比特规模阶数的有限域可以达到一定的安全性。人们试图寻找一个群，使得其上的离散对数问题没有亚指数算法。椭圆曲线加法群是非常好的候选对象。</strong></p>
</blockquote>
<p><strong>1.</strong> <strong>素域Fp的定义</strong></p>
<p><img src="/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps1.jpg" alt="img"> </p>
<p><strong>2.Fp上的椭圆曲线</strong></p>
<p>仿射坐标表示：</p>
<p><img src="/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps2.jpg" alt="img"> </p>
<p><img src="/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps3.jpg" alt="img"> </p>
<p><img src="/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps4.jpg" alt="img"> </p>
<p>射影坐标表示：</p>
<p><img src="/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps5.jpg" alt="img"> </p>
<p>加重射影坐标表示：</p>
<p><img src="/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps6.jpg" alt="img"> </p>
<p><strong>3. 二元扩域</strong></p>
<p><img src="/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps7.jpg" alt="img"> </p>
<p><strong>4.二元扩域下的椭圆曲线</strong></p>
<p>仿射坐标表示：</p>
<p><img src="/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps8.jpg" alt="img"> </p>
<p>射影坐标表示：</p>
<p><img src="/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps9.jpg" alt="img"> </p>
<p><img src="/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps10.jpg" alt="img"> </p>
<p>加重射影坐标表示：</p>
<p><img src="/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps11.jpg" alt="img"> </p>
<p><strong>算法步骤：</strong></p>
<p><strong>1. 加密步骤：</strong></p>
<p><img src="/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps12.jpg" alt="img"> </p>
<p><strong>2. 解密步骤：</strong></p>
<p><img src="/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps13.jpg" alt="img"> </p>
<p><img src="/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps14.jpg" alt="img"> </p>
<h5 id="方案实现"><a href="#方案实现" class="headerlink" title="方案实现"></a>方案实现</h5><p><strong>算法流程图：</strong></p>
<p><strong>加密流程</strong></p>
<p><img src="/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps15.jpg" alt="img"> </p>
<p><strong>解密流程</strong></p>
<p><img src="/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps16.jpg" alt="img"> </p>
<p><strong>参数说明：</strong></p>
<p>首先说明我这里域的选择主要是大素数域而非二次扩域，其他参数均为SM2椭圆曲线公钥算法的推荐参数，因此其中有一步骤的余因子可以直接指定为1，在检验时省去了倍点运算的一步操作，相关参数如下所示：</p>
<p><img src="/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps17.jpg" alt="img"> </p>
<p><strong>中间设计数据类型和形式上的转换：</strong></p>
<p><img src="/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps18.jpg" alt="img"> </p>
<p>首先在这儿其中最重要的就是各种数据类型的转换，我结合了文档上针对每种类型转换的描述以及Python语言本身提供的一些特性函数，针对转换做出了实现：</p>
<p>对于整数到字节串的转换，我这里用了两种方式：</p>
<ol>
<li><p><code>bytes([&lt;integer&gt;])</code></p>
</li>
<li><p><code>bytes.fromhex(&lt;hex format string&gt;)</code></p>
</li>
</ol>
<p>对于字节串转换成整数，我只要先将字节串转换成十六进制的形式，然后利用int函数</p>
<p><code>int(binascii.hexlify(&lt;byte string&gt;), 16)</code></p>
<p>对于比特串到字节串我这里并没有特别进行实现，因为在所有函数当中需要使用比特串的时候，也对应有直接用字节串的实现方式，只有在特别需要比特串某一位时，我用bin函数来使用。</p>
<p>域元素与整数间的相互转换由于我选择的是大素数域，因此两者一致</p>
<p>对于<strong>点到字节串的转换</strong>，严格按照下图所示：</p>
<p><img src="/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps19.jpg" alt="img"> </p>
<p> 实现代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_byte_to_point</span>(<span class="params">self, C, mode</span>):</span><br><span class="line">        l = math.ceil(gmpy2.log2(<span class="built_in">int</span>(self.ecc_param[<span class="string">&#x27;p&#x27;</span>], <span class="number">16</span>))/<span class="number">8</span>)</span><br><span class="line">        l = <span class="built_in">int</span>(l)</span><br><span class="line"></span><br><span class="line">        PC = binascii.hexlify(<span class="built_in">bytes</span>([C[<span class="number">0</span>]]))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># print(binascii.hexlify(C))</span></span><br><span class="line">        xp = <span class="built_in">int</span>(binascii.hexlify(C[<span class="number">1</span>:l+<span class="number">1</span>]), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># print(binascii.hexlify(xp))</span></span><br><span class="line">        <span class="comment"># print(&quot;PC: &quot;, PC)</span></span><br><span class="line">        <span class="keyword">if</span> mode == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">if</span> PC != <span class="string">b&quot;02&quot;</span> <span class="keyword">or</span> PC != <span class="string">b&quot;03&quot;</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;[+] Something Error during decrypting...&quot;</span>)</span><br><span class="line">                exit(-<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">if</span> PC == <span class="string">b&quot;02&quot;</span>:</span><br><span class="line">                    yp = <span class="string">&#x27;0&#x27;</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    yp = <span class="string">&#x27;1&#x27;</span></span><br><span class="line">            alpha = (<span class="built_in">pow</span>(xp, <span class="number">3</span>) + <span class="built_in">int</span>(self.ecc_param[<span class="string">&#x27;a&#x27;</span>], <span class="number">16</span>)*xp + <span class="built_in">int</span>(</span><br><span class="line">                self.ecc_param[<span class="string">&#x27;b&#x27;</span>], <span class="number">16</span>)) % <span class="built_in">int</span>(self.ecc_param[<span class="string">&#x27;p&#x27;</span>], <span class="number">16</span>)</span><br><span class="line">            beta, has_root = gmpy2.iroot(alpha, <span class="built_in">int</span>(self.ecc_param[<span class="string">&#x27;p&#x27;</span>], <span class="number">16</span>))</span><br><span class="line">            <span class="keyword">if</span> has_root:</span><br><span class="line">                <span class="keyword">if</span> yp == <span class="built_in">bin</span>(beta)[-<span class="number">1</span>]:</span><br><span class="line">                    yp = beta</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    yp = <span class="built_in">int</span>(self.ecc_param[<span class="string">&#x27;p&#x27;</span>], <span class="number">16</span>) - beta</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;[+] Something Error during decrypting...&quot;</span>)</span><br><span class="line">        <span class="keyword">elif</span> mode == <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">if</span> PC != <span class="string">b&quot;04&quot;</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;[+] Something Error during decrypting...&quot;</span>)</span><br><span class="line">                exit</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                yp = <span class="built_in">int</span>(binascii.hexlify(C[l+<span class="number">1</span>:<span class="number">2</span>*l+<span class="number">1</span>]), <span class="number">16</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> PC != <span class="string">b&quot;06&quot;</span> <span class="keyword">or</span> PC != <span class="string">b&quot;07&quot;</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;[+] Something Error during decrypting...&quot;</span>)</span><br><span class="line">                exit(-<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                yp = <span class="built_in">int</span>(binascii.hexlify(C[l+<span class="number">1</span>:<span class="number">2</span>*l+<span class="number">1</span>]), <span class="number">16</span>)</span><br><span class="line">        <span class="comment"># verify xp and yp</span></span><br><span class="line">        <span class="keyword">if</span> gmpy2.powmod(yp, <span class="number">2</span>, <span class="built_in">int</span>(self.ecc_param[<span class="string">&#x27;p&#x27;</span>], <span class="number">16</span>)) == ((gmpy2.powmod(xp, <span class="number">3</span>, <span class="built_in">int</span>(self.ecc_param[<span class="string">&#x27;p&#x27;</span>], <span class="number">16</span>)) + <span class="built_in">int</span>(self.ecc_param[<span class="string">&#x27;a&#x27;</span>], <span class="number">16</span>)*xp + <span class="built_in">int</span>(self.ecc_param[<span class="string">&#x27;b&#x27;</span>], <span class="number">16</span>)) % <span class="built_in">int</span>(self.ecc_param[<span class="string">&#x27;p&#x27;</span>], <span class="number">16</span>)):</span><br><span class="line">            <span class="keyword">return</span> (xp, yp)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[+] Something Error during decrypting...&quot;</span>)</span><br><span class="line">            exit(-<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>对于字节串到点的转换，也按如下步骤实现：</p>
<p><img src="/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps20.jpg" alt="img"> </p>
<p>代码实现如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">point_to_byte</span>(<span class="params">self, P, mode</span>):</span><br><span class="line">        PC = <span class="literal">None</span></span><br><span class="line">        <span class="comment"># 域元素xP转换成长度为l的字节串X1</span></span><br><span class="line">        X1 = self._field_to_byte(P[<span class="number">0</span>])</span><br><span class="line">        <span class="comment"># 1.压缩 2.未压缩 3.混合</span></span><br><span class="line">        <span class="keyword">if</span> mode == <span class="number">1</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;[+] representation: compressed&#x27;</span>)</span><br><span class="line">            <span class="comment"># 计算比特y˜P</span></span><br><span class="line">            yp = <span class="built_in">bin</span>(P[<span class="number">1</span>])[-<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">if</span> yp == <span class="string">&#x27;0&#x27;</span>:</span><br><span class="line">                PC = <span class="string">&#x27;02&#x27;</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                PC = <span class="string">&#x27;03&#x27;</span></span><br><span class="line">            <span class="keyword">return</span> PC + X1</span><br><span class="line">        <span class="keyword">elif</span> mode == <span class="number">2</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;[+] representation: uncompressed&#x27;</span>)</span><br><span class="line">            Y1 = self._field_to_byte(P[<span class="number">1</span>])</span><br><span class="line">            PC = <span class="string">&#x27;04&#x27;</span></span><br><span class="line">            <span class="keyword">return</span> PC + X1 + Y1</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;[+] representation: mixed&#x27;</span>)</span><br><span class="line">            Y1 = self._field_to_byte(P[<span class="number">1</span>])</span><br><span class="line">            yp = <span class="built_in">bin</span>(P[<span class="number">1</span>])[-<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">if</span> yp == <span class="string">&#x27;0&#x27;</span>:</span><br><span class="line">                PC = <span class="string">&#x27;06&#x27;</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                PC = <span class="string">&#x27;07&#x27;</span></span><br><span class="line">            <span class="keyword">return</span> PC + X1 + Y1</span><br></pre></td></tr></table></figure>
<p><strong>运算规则部分实现：</strong></p>
<ol>
<li><strong>加法规则</strong></li>
</ol>
<p><img src="/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps21.jpg" alt="img"> </p>
<p>里面针对 $\lambda$ 的除法，我转换成了乘以模拟的操作。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_add_point</span>(<span class="params">self, P1, P2</span>):</span><br><span class="line">        p = <span class="built_in">int</span>(self.ecc_param[<span class="string">&#x27;p&#x27;</span>], <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">        P1_x, P1_y = P1[<span class="number">0</span>], P1[<span class="number">1</span>]</span><br><span class="line">        P2_x, P2_y = P2[<span class="number">0</span>], P2[<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">if</span> P1_x == <span class="number">0</span> <span class="keyword">and</span> P1_y == <span class="number">0</span> <span class="keyword">and</span> P2_x == <span class="number">0</span> <span class="keyword">and</span> P2_y == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> P1_x == P2_x <span class="keyword">and</span> P1_y == P2_y:</span><br><span class="line">            lbd = (<span class="number">3</span>*<span class="built_in">pow</span>(P1_x, <span class="number">2</span>) +</span><br><span class="line">                   <span class="built_in">int</span>(self.ecc_param[<span class="string">&#x27;a&#x27;</span>], <span class="number">16</span>))*gmpy2.invert((<span class="number">2</span>*P1_y), p) % p</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> (P1 == (<span class="number">0</span>, <span class="number">0</span>)) <span class="keyword">or</span> (P2 == (<span class="number">0</span>, <span class="number">0</span>)):</span><br><span class="line">                <span class="keyword">return</span> P1 <span class="keyword">if</span> P1 != (<span class="number">0</span>, <span class="number">0</span>) <span class="keyword">else</span> P2</span><br><span class="line">            lbd = (P2_y-P1_y)*gmpy2.invert(P2_x-P1_x, p) % p</span><br><span class="line"></span><br><span class="line">        P3_x = (<span class="built_in">pow</span>(lbd, <span class="number">2</span>) - P1_x - P2_x) % p</span><br><span class="line">        P3_y = (lbd*(P1_x - P3_x) - P1_y) % p</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> P3_x, P3_y</span><br></pre></td></tr></table></figure>
<ol>
<li><strong>倍点运算规则</strong></li>
</ol>
<p>倍点运算我这里利用二进制展开法进行的实现</p>
<p><img src="/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps22.jpg" alt="img"> </p>
<p><img src="/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps23.jpg" alt="img"> </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_mutiply_p</span>(<span class="params">self, multi, P</span>):</span><br><span class="line">        product = (<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">bin</span>(multi):</span><br><span class="line">            product = self._add_point(product, product)</span><br><span class="line">            <span class="keyword">if</span> i == <span class="string">&#x27;1&#x27;</span>:</span><br><span class="line">                product = self._add_point(product, P)</span><br><span class="line">        <span class="keyword">return</span> product</span><br></pre></td></tr></table></figure>
<p><strong>密钥派生部分</strong></p>
<p><img src="/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps24.jpg" alt="img"> </p>
<p>代码实现如下，其中需要注意的是klen长度是比特长度，而我们的类型中还包括整数的长度、字节长度，这里传参时要进行相应的转换：</p>
 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_KDF</span>(<span class="params">self, bit_string, klen</span>):</span><br><span class="line">        klen = <span class="built_in">int</span>(klen)</span><br><span class="line">        ct = <span class="number">0x00000001</span></span><br><span class="line">        rcnt = math.ceil(klen/<span class="number">32</span>)</span><br><span class="line">        zin = [i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">bytes</span>.fromhex(bit_string.decode())]</span><br><span class="line">        ha = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(rcnt):</span><br><span class="line">            msg = zin + \</span><br><span class="line">                [i <span class="keyword">for</span> i <span class="keyword">in</span> binascii.a2b_hex((<span class="string">&#x27;%08x&#x27;</span> % ct).encode())]</span><br><span class="line">            ha = ha + sm3.sm3_hash(msg)</span><br><span class="line">            ct += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> ha[<span class="number">0</span>: klen * <span class="number">2</span>]</span><br></pre></td></tr></table></figure>
<p>最终汇总起来，按照加密流程实现加密函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt</span>(<span class="params">self, M, mode</span>):</span><br><span class="line">        k = randint(<span class="number">1</span>, <span class="built_in">int</span>(self.ecc_param[<span class="string">&#x27;n&#x27;</span>], <span class="number">16</span>)-<span class="number">1</span>)</span><br><span class="line">        public_key = self.public_key</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;[+] random number k:&#x27;</span>, k)</span><br><span class="line">        <span class="comment"># 实际上是随机值</span></span><br><span class="line">        <span class="comment"># k = int(&#x27;4C62EEFD6ECFC2B95B92FD6C3D9575148AFA17425546D49018E5388D49DD7B4F&#x27;, 16)</span></span><br><span class="line"></span><br><span class="line">        l = <span class="built_in">len</span>(self.ecc_param[<span class="string">&#x27;n&#x27;</span>])</span><br><span class="line">        g = (<span class="built_in">int</span>(self.ecc_param[<span class="string">&#x27;g&#x27;</span>][<span class="number">0</span>: l], <span class="number">16</span>),</span><br><span class="line">             <span class="built_in">int</span>(self.ecc_param[<span class="string">&#x27;g&#x27;</span>][l:], <span class="number">16</span>))</span><br><span class="line">        result = self._mutiply_p(k, g)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># mode = 2    需要用户传参提供</span></span><br><span class="line">        C1 = self.point_to_byte(result, mode)</span><br><span class="line"></span><br><span class="line">        xy = self._mutiply_p(k, public_key)</span><br><span class="line"></span><br><span class="line">        klen = <span class="built_in">len</span>(M)*<span class="number">4</span>  <span class="comment"># 十六进制下</span></span><br><span class="line">        <span class="comment"># 比特长度</span></span><br><span class="line">        result = self._KDF(</span><br><span class="line">            (<span class="built_in">hex</span>(xy[<span class="number">0</span>])[<span class="number">2</span>:]+<span class="built_in">hex</span>(xy[<span class="number">1</span>])[<span class="number">2</span>:]).encode(), klen/<span class="number">8</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">int</span>(result, <span class="number">16</span>) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># M = &#x27;656E6372797074696F6E207374616E64617264&#x27;</span></span><br><span class="line">            C2 = <span class="built_in">hex</span>(<span class="built_in">int</span>(M, <span class="number">16</span>) ^ <span class="built_in">int</span>(result, <span class="number">16</span>))[<span class="number">2</span>:]</span><br><span class="line"></span><br><span class="line">        C3 = sm3.sm3_hash([</span><br><span class="line">            i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">bytes</span>.fromhex(<span class="string">&#x27;%s%s%s&#x27;</span> % (<span class="built_in">hex</span>(xy[<span class="number">0</span>])[<span class="number">2</span>:], M, <span class="built_in">hex</span>(xy[<span class="number">1</span>])[<span class="number">2</span>:]))</span><br><span class="line">        ])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bytes</span>.fromhex(<span class="string">&#x27;%s%s%s&#x27;</span> % (C1, C2, C3))</span><br></pre></td></tr></table></figure>
<p>按照解密流程实现解密函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">self, C, mode</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        mode:</span></span><br><span class="line"><span class="string">            1. 压缩 2. 未压缩 3. 混合</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        l = math.ceil(gmpy2.log2(<span class="built_in">int</span>(self.ecc_param[<span class="string">&#x27;p&#x27;</span>], <span class="number">16</span>))/<span class="number">8</span>)</span><br><span class="line">        l = <span class="built_in">int</span>(l)</span><br><span class="line">        <span class="comment"># 字节长度</span></span><br><span class="line">        lengthOfS = <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> mode == <span class="number">1</span>:</span><br><span class="line">            lengthOfS = l+<span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            lengthOfS = <span class="number">2</span>*l+<span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># C2比特长度</span></span><br><span class="line">        klen = (<span class="built_in">len</span>(C) - lengthOfS - <span class="number">32</span>)</span><br><span class="line">        C2 = <span class="built_in">int</span>(binascii.hexlify(C[lengthOfS:lengthOfS+klen]), <span class="number">16</span>)</span><br><span class="line">        C3 = C[lengthOfS+klen:]</span><br><span class="line"></span><br><span class="line">        C1 = C[<span class="number">0</span>:lengthOfS]</span><br><span class="line">        C1 = self._byte_to_point(C1, mode)</span><br><span class="line">        C1 = self._mutiply_p(self.private_key, C1)</span><br><span class="line"></span><br><span class="line">        bytestring = <span class="built_in">bytes</span>.fromhex(<span class="string">&#x27;%s%s&#x27;</span> % (<span class="built_in">hex</span>(C1[<span class="number">0</span>])[<span class="number">2</span>:], <span class="built_in">hex</span>(C1[<span class="number">1</span>])[<span class="number">2</span>:]))</span><br><span class="line"></span><br><span class="line">        t = self._KDF(binascii.hexlify(bytestring), klen)</span><br><span class="line">        iM = C2 ^ <span class="built_in">int</span>(t, <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">        u = sm3.sm3_hash([</span><br><span class="line">            i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">bytes</span>.fromhex(<span class="string">&#x27;%s%s%s&#x27;</span> % (<span class="built_in">hex</span>(C1[<span class="number">0</span>])[<span class="number">2</span>:], <span class="built_in">hex</span>(iM)[<span class="number">2</span>:], <span class="built_in">hex</span>(C1[<span class="number">1</span>])[<span class="number">2</span>:]))</span><br><span class="line">        ])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> binascii.hexlify(C3).decode() == u:</span><br><span class="line">            <span class="keyword">return</span> binascii.a2b_hex(<span class="built_in">hex</span>(iM)[<span class="number">2</span>:]).decode()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[+] Something Error during decrypting...&quot;</span>)</span><br><span class="line">            exit(-<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<h5 id="数据分析"><a href="#数据分析" class="headerlink" title="数据分析"></a>数据分析</h5><p><strong>输入数据1:</strong> </p>
<p>One is always on a strange road, watching strange scenery and listening to strange music. Then one day, you will find that the things you try hard to forget are already gone.</p>
<p><strong>运行结果如下:</strong></p>
<p>首先可以看到一系列初始化操作以及输入的明文，由随机数生成器产生的随机数。</p>
<p>这里针对加密明文的表现形式选择了非压缩模式，密文结果由16进制表示。</p>
<p>当解密时会有验证Hash的操作，当Hash验证成功且解密的密文与输入明文数据相同时，会输出“<strong>[+] You have successfully decrypted</strong>”，由此可以看到加密解密成功</p>
<p><img src="/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps25.jpg" alt="img"> </p>
<p><strong>输入数据2：</strong></p>
<p>Most of us compare ourselves with anyone we think is happier — a relative, someone we know a lot, or someone we hardly know. As a result, what we do remember is anything that makes others happy, anything that makes ourselves unhappy, totally forgetting that there is something happy in our own life.</p>
<p><strong>运行结果：</strong></p>
<p><img src="/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps26.jpg" alt="img"> </p>
<p><strong>输入数据3：</strong></p>
<p>Happiness is not about being immortal nor having food or rights in one’s hand. It’s about having each tiny wish come true, or having something to eat when you are hungry or having someone’s love when you need love.</p>
<p><strong>运行结果：</strong></p>
<p><img src="/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/wps27.jpg" alt="img"> </p>
<h5 id="思考与总结"><a href="#思考与总结" class="headerlink" title="思考与总结"></a>思考与总结</h5><ol>
<li>实验过程中遇到了什么问题，如何解决的？</li>
</ol>
<p>其实刚开始就遇到了很多问题，像加法和倍点运算出现错误，刚开始我直接使用的除法运算，会碰到除0错误。倍点运算一开始直接采用循环相加的实现，导致运算时间过长，后来仔细看了一遍文档针对不同实现算法的说明后，重新构建思路，解决了此类运算问题。其次一个问题就是对于数据类型转换的问题，文档上提供的说明有的只是一系列公式比较抽象，结合对于Python相关函数的查询，我了解到了binascii库以及bin、hex、int、bytes等相关函数的使用场景，相结合之后实现了转换的问题。</p>
<ol>
<li>通过该实验有何收获和感想？</li>
</ol>
<p>这是最后一次密码学实验了，感觉收获相比于之前几次都很大。首先是课堂上老师讲的给出了一个整体的轮廓，但是具体的实现细节都需要自己去结合官方文档以及查阅资料来去了解明白。无论是从编程能力，还是对密码学分组密码的理解上都有了很大的提升。</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2"><span class="toc-number">1.</span> <span class="toc-text">写在前面</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E7%9B%AE%E7%9A%84%EF%BC%88%E5%8C%85%E6%8B%AC%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83%E3%80%81%E5%AE%9E%E7%8E%B0%E7%9B%AE%E6%A0%87%E7%AD%89%E7%AD%89%EF%BC%89"><span class="toc-number">2.</span> <span class="toc-text">实验目的（包括实验环境、实现目标等等）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.</span> <span class="toc-text">方案设计</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.</span> <span class="toc-text">方案实现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90"><span class="toc-number">5.</span> <span class="toc-text">数据分析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%80%9D%E8%80%83%E4%B8%8E%E6%80%BB%E7%BB%93"><span class="toc-number">6.</span> <span class="toc-text">思考与总结</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/&text=SM2国密算法实现"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/&title=SM2国密算法实现"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/&is_video=false&description=SM2国密算法实现"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=SM2国密算法实现&body=Check out this article: https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/&title=SM2国密算法实现"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/&title=SM2国密算法实现"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/&title=SM2国密算法实现"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/&title=SM2国密算法实现"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/&name=SM2国密算法实现&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://racerz-fighting.github.io/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/&t=SM2国密算法实现"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2023
    RacerZ
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
