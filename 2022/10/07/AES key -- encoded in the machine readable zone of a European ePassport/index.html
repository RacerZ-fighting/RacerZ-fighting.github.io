<!DOCTYPE html><html lang="en" theme-mode="auto"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>AES key -- encoded in the machine readable zone of a European ePassport | RacerZ</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.6.1/MathJax.js"></script><script>MathJax.Hub.Config({
 menuSettings: {
   zoom: "None"
 },
 showMathMenu: false,
 jax: ["input/TeX","output/CommonHTML"],
 extensions: ["tex2jax.js"],
 TeX: {
   extensions: ["AMSmath.js","AMSsymbols.js"],
   equationNumbers: {
     autoNumber: "AMS"
   }
 },
 tex2jax: {
   inlineMath: [["\\(", "\\)"]],
   displayMath: [["\\[", "\\]"]]
 }
});</script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light' || window.matchMedia('(prefers-color-scheme:light)').matches) document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark' || window.matchMedia('(prefers-color-scheme:dark)').matches) document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg');
  --light-background: url('/img/bk.jpg');
}</style><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.1.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav></header><div id="shadow-header"></div><article><div id="post-bg"><div id="post-title"><h1>AES key -- encoded in the machine readable zone of a European ePassport</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2022-10-06T16:00:00.000Z" id="date"> 2022-10-07</time></div></span><br><span>Last Update: <div class="control"><time datetime="2022-10-06T18:40:18.727Z" id="updated"> 2022-10-07</time></div></span></div></div><hr><div id="post-content"><h2 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h2><ul>
<li><code>An AES encrypted message has been forwarded to you (CBC mode with zero initialization vector and 01-00 padding). Additionally, you have received the corresponding key 一 unfortunately not quite complete -in a form like a machine readable zone (MRZ) on an identity document as it is used e.g. with ePassports in Europe</code></li>
<li>这里呈现给你了一个通过AES加密的信息（加密模式为CBC，其中iv值为全0，通过01-00填充）。另外，你还收到了对应的密钥，可惜并不完整。这种传递形式一般出现在身份文件中机器可识别区域，例如欧洲护照</li>
<li><code>It is the objective to find the plaintext of the following base64-encoded message.9MgYwmuPrjiecPMx61O6zluy3MtlXQQ0E59T3xB6u0GyflgYs2i3K9Jx aa0zj4gTMazJuApwd6+jdyel5iGHvhQyDHGVIAuYTgJrbFDrfB22Fpil2N fNnWFBTXyRSDI</code></li>
<li>我们的目标就是去解密下列经过base64编码的信息</li>
<li><code>For encryption a key Kenc based on the Basic Access Control (BAC) protocol has been generated and applied. For decryption the following characters have been transmitted from which Kenc can be derived (The kind of coding of these characters is described in [1])： 12345678&lt;8&lt;&lt;&lt;1110182&lt;1111167&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;4</code></li>
<li>在加密时所使用的密钥，我们基于基础访问协议来生成和使用。在解密时可以从下列传输的字符串中获得密钥（这种字符的编码描述在[1]）</li>
<li><code>Unfortunately, during transmission a character was lost and has been highlighted with a &quot;?&quot;. Nevertheless, you can make it visible again with the help of [2]. To be able to compute the key Kenc afterwards you can find an overview of the applied encoding protocols in [3], [4] and an example in [5].</code></li>
<li>不幸的是，在传输字符串时有一个字符丢失了并被以<code>?</code>高亮标记。然而，通过[2]的帮助，可以恢复。之后，通过浏览对应的编码协议[3]、[4]，便可以计算出密钥。在[5]中给出了一个例子</li>
</ul>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><ul>
<li>翻译完感觉有些模糊，因为里面有很多引用。但是总体思路已经给出：首先恢复字符串中丢失的字符，接着计算出密钥，然后最后解密即可。</li>
</ul>
<h3 id="恢复字符"><a href="#恢复字符" class="headerlink" title="恢复字符"></a>恢复字符</h3><p>参考文章2</p>
<p class='item-img' data-src='/2022/10/07/AES%20key%20--%20encoded%20in%20the%20machine%20readable%20zone%20of%20a%20European%20ePassport/image_1665071002953_0.png'><img src="/2022/10/07/AES%20key%20--%20encoded%20in%20the%20machine%20readable%20zone%20of%20a%20European%20ePassport/image_1665071002953_0.png" alt="image.png"></p>
<p class='item-img' data-src='/2022/10/07/AES%20key%20--%20encoded%20in%20the%20machine%20readable%20zone%20of%20a%20European%20ePassport/image_1665071015452_0.png'><img src="/2022/10/07/AES%20key%20--%20encoded%20in%20the%20machine%20readable%20zone%20of%20a%20European%20ePassport/image_1665071015452_0.png" alt="image.png"></p>
<ul>
<li>这里就直接定位到了我们要求的<code>?</code>是到期日的校验位，并且<code>&lt;</code>代表0</li>
</ul>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">s = <span class="hljs-string">&quot;111116&quot;</span><br>q = [<span class="hljs-number">3</span>,<span class="hljs-number">7</span>,<span class="hljs-number">1</span>]<br>result = <span class="hljs-number">0</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(s)):<br>    result += <span class="hljs-built_in">int</span>(s[i])*q[i%<span class="hljs-number">3</span>]<br><span class="hljs-built_in">print</span>(result % <span class="hljs-number">10</span>)<br></code></pre></td></tr></table></figure>
<p>  得到答案为7</p>
<h3 id="计算密钥key"><a href="#计算密钥key" class="headerlink" title="计算密钥key"></a>计算密钥key</h3><p>先给出参考引用</p>
<p class='item-img' data-src='/2022/10/07/AES%20key%20--%20encoded%20in%20the%20machine%20readable%20zone%20of%20a%20European%20ePassport/image_1665072883307_0.png'><img src="/2022/10/07/AES%20key%20--%20encoded%20in%20the%20machine%20readable%20zone%20of%20a%20European%20ePassport/image_1665072883307_0.png" alt="image.png"></p>
<p>这里首先通过证件号码、出生日期和到期日及其各自的校验位生成密钥种子</p>
<ul>
<li><ol>
<li>证件号码 <code>12345678&lt;8</code></li>
<li>出生日期<code>1110182</code></li>
<li>到期日 <code>1111167</code></li>
</ol>
</li>
<li><p>将其进行SHA-1哈希并取高16字节即可得到密钥种子</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># coding=gbk</span><br><br><span class="hljs-keyword">from</span> hashlib <span class="hljs-keyword">import</span> sha1<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">hash</span>(<span class="hljs-params">content</span>):<br>    h = sha1(content).hexdigest()<br>    <span class="hljs-keyword">return</span> h[:<span class="hljs-number">32</span>]<br><br>content = <span class="hljs-string">b&#x27;12345678&lt;811101821111167&#x27;</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hash</span>(content))<br><br><span class="hljs-comment"># a095f0fdfe51e6ab3bf5c777302c473e</span><br></code></pre></td></tr></table></figure>
<p>继续看参考引用</p>
<p class='item-img' data-src='/2022/10/07/AES%20key%20--%20encoded%20in%20the%20machine%20readable%20zone%20of%20a%20European%20ePassport/image_1665073694692_0.png'><img src="/2022/10/07/AES%20key%20--%20encoded%20in%20the%20machine%20readable%20zone%20of%20a%20European%20ePassport/image_1665073694692_0.png" alt="image.png"></p>
<p>还挺麻烦，也就是这里还要基于密钥种子生成两个DES密钥。有个计数器c需要利用，因为我们是要生成加密密钥，所以用第一个<code>0x 00 00 00 01</code></p>
<p>这里在最后还要计算一个奇偶校验位，也就是每八位都要加上一个校验位，最终形成密钥</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># coding=gbk</span><br><span class="hljs-keyword">from</span> hashlib <span class="hljs-keyword">import</span> sha1<br><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES<br><span class="hljs-keyword">from</span> base64 <span class="hljs-keyword">import</span> b64decode<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">hash</span>(<span class="hljs-params">content</span>):<br>    <span class="hljs-keyword">return</span> sha1(content).hexdigest()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">correct</span>(<span class="hljs-params">key</span>):<br>    result = []<br>    a = <span class="hljs-built_in">bin</span>(<span class="hljs-built_in">int</span>(key, <span class="hljs-number">16</span>))[<span class="hljs-number">2</span>:]<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(a), <span class="hljs-number">8</span>):<br>        <span class="hljs-keyword">if</span> a[i:i+<span class="hljs-number">7</span>].count(<span class="hljs-string">&quot;1&quot;</span>) % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>:<br>            result.append(a[i:i+<span class="hljs-number">7</span>])<br>            result.append(<span class="hljs-string">&quot;1&quot;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            result.append(a[i:i+<span class="hljs-number">7</span>])<br>            result.append(<span class="hljs-string">&quot;0&quot;</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">hex</span>(<span class="hljs-built_in">int</span>(<span class="hljs-string">&quot;&quot;</span>.join(result), <span class="hljs-number">2</span>))[<span class="hljs-number">2</span>:]<br><br>cipher = <span class="hljs-string">b&quot;9MgYwmuPrjiecPMx61O6zIuy3MtIXQQ0E59T3xB6u0Gyf1gYs2i3K9Jxaa0zj4gTMazJuApwd6+jdyeI5iGHvhQyDHGVlAuYTgJrbFDrfB22Fpil2NfNnWFBTXyf7SDI&quot;</span><br><br><br>c = <span class="hljs-string">&#x27;00&#x27;</span>*<span class="hljs-number">3</span> + <span class="hljs-string">&#x27;01&#x27;</span><br>seed = <span class="hljs-string">&#x27;a095f0fdfe51e6ab3bf5c777302c473e&#x27;</span><br>D = seed + c<br><span class="hljs-comment"># 这里要重新转换为字节数组，因为这里只是16进制表示str</span><br>H = <span class="hljs-built_in">hash</span>(<span class="hljs-built_in">bytes</span>.fromhex(D))[:<span class="hljs-number">32</span>]<br><br>ka, kb = H[:<span class="hljs-number">16</span>], H[<span class="hljs-number">16</span>:]<br><br>key = <span class="hljs-built_in">bytes</span>.fromhex(correct(ka)) + <span class="hljs-built_in">bytes</span>.fromhex(correct(kb))<br><span class="hljs-built_in">print</span>(key)<br><br><span class="hljs-comment"># b&#x27;\xea\x86E\xd9\x7f\xf7%\xa8\x98\x94*\xa2\x80\xc41y&#x27;</span><br><br></code></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="解密"><a href="#解密" class="headerlink" title="解密"></a>解密</h3><ul>
<li><p>这里就没啥可说的了，AES-CBC解密即可。除了要注意iv的值为ascii码的0值，而不是数字0</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">mode = AES.new(key, AES.MODE_CBC, iv=<span class="hljs-string">b&quot;\x00&quot;</span>*<span class="hljs-number">16</span>)<br>plain = mode.decrypt(b64decode(cipher))<br><span class="hljs-built_in">print</span>(plain)<br></code></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h3><p class='item-img' data-src='/2022/10/07/AES%20key%20--%20encoded%20in%20the%20machine%20readable%20zone%20of%20a%20European%20ePassport/image_1665077887614_0.png'><img src="/2022/10/07/AES%20key%20--%20encoded%20in%20the%20machine%20readable%20zone%20of%20a%20European%20ePassport/image_1665077887614_0.png" alt="image.png"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>题目整体不是很难，只要跟着说明一步步走即可。中间遇到了一些代码上的问题，比如说字节与16字符串之间的转换。也算是更加熟练了对python 密码相关库的使用</li>
<li>写了这么多道题，也学到了很多基于分组密码加密模式的小trick</li>
</ul>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2022/10/12/21%E5%B9%B4%E9%95%BF%E5%AE%89%E6%9D%AF%E7%94%B5%E5%AD%90%E6%95%B0%E6%8D%AE%E5%8F%96%E8%AF%81%E5%A4%8D%E7%8E%B0/">← Next 21年长安杯电子数据取证复现</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2022/10/06/CTF-SHOW%20PHP%E7%89%B9%E6%80%A7%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/">CTFSHOW-PHP特性 Prev →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧</a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">RacerZ</a></h1><div id="description"><p></p></div><div id="social-links"><a class="social" target="_blank" rel="noopener" href="https://github.com/RacerZ-fighting"><i class="fab fa-github" alt="GitHub"></i></a><a class="social" href="qiyizhang2002@foxmail.com"><i class="fa fa-envelope" alt="E-Mail"></i></a></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Description"><span class="toc-number">1.</span> <span class="toc-text">Description</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Solution"><span class="toc-number">2.</span> <span class="toc-text">Solution</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%81%A2%E5%A4%8D%E5%AD%97%E7%AC%A6"><span class="toc-number">2.1.</span> <span class="toc-text">恢复字符</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97%E5%AF%86%E9%92%A5key"><span class="toc-number">2.2.</span> <span class="toc-text">计算密钥key</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%AF%86"><span class="toc-number">2.3.</span> <span class="toc-text">解密</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C"><span class="toc-number">2.4.</span> <span class="toc-text">运行结果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">3.</span> <span class="toc-text">总结</span></a></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside><div id="shadow-aside"></div></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>