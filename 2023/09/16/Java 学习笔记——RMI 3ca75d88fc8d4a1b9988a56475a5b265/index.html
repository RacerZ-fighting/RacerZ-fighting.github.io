<!DOCTYPE html><html lang="en" theme-mode="auto"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Java Sec â€”â€” RMI | RacerZ</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.6.1/MathJax.js"></script><script>MathJax.Hub.Config({
 menuSettings: {
   zoom: "None"
 },
 showMathMenu: false,
 jax: ["input/TeX","output/CommonHTML"],
 extensions: ["tex2jax.js"],
 TeX: {
   extensions: ["AMSmath.js","AMSsymbols.js"],
   equationNumbers: {
     autoNumber: "AMS"
   }
 },
 tex2jax: {
   inlineMath: [["\\(", "\\)"]],
   displayMath: [["\\[", "\\]"]]
 }
});</script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light' || window.matchMedia('(prefers-color-scheme:light)').matches) document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark' || window.matchMedia('(prefers-color-scheme:dark)').matches) document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg');
  --light-background: url('/img/bk.jpg');
}</style><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.1.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav></header><div id="shadow-header"></div><article><div id="post-bg"><div id="post-title"><h1>Java Sec â€”â€” RMI</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2023-09-15T16:00:00.000Z" id="date"> 2023-09-16</time></div></span><br><span>Last Update: <div class="control"><time datetime="2023-09-17T10:34:13.360Z" id="updated"> 2023-09-17</time></div></span></div></div><hr><div id="post-content"><h1 id="Java-å­¦ä¹ ç¬”è®°â€”â€”RMI"><a href="#Java-å­¦ä¹ ç¬”è®°â€”â€”RMI" class="headerlink" title="Java å­¦ä¹ ç¬”è®°â€”â€”RMI"></a>Java å­¦ä¹ ç¬”è®°â€”â€”RMI</h1><h2 id="0x00-BackGround"><a href="#0x00-BackGround" class="headerlink" title="0x00. BackGround"></a>0x00. BackGround</h2><p>RMI (Remote Method Invocation) è¿œç¨‹æ–¹æ³•è°ƒç”¨</p>
<blockquote>
<p>RMI å¼•å…¥äº†ä¸¤ä¸ªæ¦‚å¿µï¼Œåˆ†åˆ«æ˜¯ Stubsï¼ˆå®¢æˆ·ç«¯å­˜æ ¹ï¼‰ ä»¥åŠ Skeletonsï¼ˆæœåŠ¡ç«¯éª¨æ¶ï¼‰ï¼Œå½“å®¢æˆ·ç«¯ï¼ˆClientï¼‰è¯•    å›¾è°ƒç”¨ä¸€ä¸ªåœ¨è¿œç«¯çš„ Object æ—¶ï¼Œå®é™…è°ƒç”¨çš„æ˜¯å®¢æˆ·ç«¯æœ¬åœ°çš„ä¸€ä¸ªä»£ç†ç±»ï¼ˆProxyï¼‰ï¼Œè¿™ä¸ªä»£ç†ç±»å°±ç§°ä¸º Stubï¼Œè€Œåœ¨è°ƒç”¨è¿œç«¯ï¼ˆServerï¼‰çš„ç›®æ ‡ç±»ä¹‹å‰ï¼Œä¹Ÿä¼šç»è¿‡ä¸€ä¸ªå¯¹åº”çš„è¿œç«¯ä»£ç†ç±»ï¼Œå°±æ˜¯ Skeletonï¼Œå®ƒä» Stub ä¸­æ¥æ”¶è¿œç¨‹æ–¹æ³•è°ƒç”¨å¹¶ä¼ é€’ç»™çœŸå®çš„ç›®æ ‡ç±»ã€‚</p>
</blockquote>
<p>å¯ä»¥çœ‹åˆ°ï¼ŒRMI æ•´ä¸ªé€šä¿¡æ–¹å¼ä¸é‚®ä»¶å‘é€ä¸æ¥æ”¶æ‰€ç»è¿‡çš„åè®®æµç¨‹ç±»ä¼¼</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled.png" alt="Untitled"></p>
<ul>
<li><p>RMI æ‰€æ”¯æŒçš„ç‰¹æ€§ï¼š</p>
<ol>
<li><p>åŠ¨æ€ç±»åŠ è½½</p>
<p> RMI æ”¯æŒåŠ¨æ€ç±»åŠ è½½ï¼Œå¦‚æœè®¾ç½®äº† <code>java.rmi.server.codebase</code>ï¼Œåˆ™ä¼šå°è¯•ä»å…¶ä¸­çš„åœ°å€è·å– <code>.class</code> å¹¶åŠ è½½åŠååºåˆ—åŒ–</p>
<p> <kbd><strong>è®¾ç½®æ–¹æ³•</strong>ï¼š</kbd></p>
<p> å¼€å¯ RMI å®‰å…¨ç­–ç•¥ç®¡ç†å¹¶é…ç½®å¯¹åº”çš„ç­–ç•¥æ–‡ä»¶</p>
<p> <code>System.setProperty(&quot;java.rmi.server.codebase&quot;,&quot;[http://127.0.0.1:9999/](http://127.0.0.1:9999/)&quot;);</code></p>
<p> ä½¿ç”¨å¯åŠ¨å‚æ•° <code>-Djava.rmi.server.codebase=&quot;http://127.0.0.1:9999/&quot;</code> è¿›è¡ŒæŒ‡å®š</p>
</li>
</ol>
</li>
</ul>
<h2 id="0x01-æºç è§£æ"><a href="#0x01-æºç è§£æ" class="headerlink" title="0x01. æºç è§£æ"></a>0x01. æºç è§£æ</h2><ul>
<li><p>æµ‹è¯• demo</p>
<ul>
<li><p>Java code for Server side</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RemoteServer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> RemoteException, MalformedURLException, AlreadyBoundException, InterruptedException &#123;<br>        startReg();<br><br>        <span class="hljs-comment">// åˆ›å»ºè¿œç¨‹å¯¹è±¡</span><br>        <span class="hljs-type">RemoteInterface</span> <span class="hljs-variable">remoteObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemoteObject</span>();<br>        <span class="hljs-comment">// ç»‘å®š</span><br>        Naming.bind(<span class="hljs-string">&quot;rmi://localhost:1099/Hello&quot;</span>, remoteObject);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startReg</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>            System.out.println(<span class="hljs-string">&quot;Server Start&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>Java code for Client side</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> RemoteException, NotBoundException &#123;<br><br>        <span class="hljs-comment">// sun.rmi.registry.RegistryImpl_Stub</span><br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.getRegistry(<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-number">1099</span>);<br><br>        System.out.println(Arrays.toString(registry.list()));<br><br>        <span class="hljs-comment">// lookup and call</span><br>        <span class="hljs-type">RemoteInterface</span> <span class="hljs-variable">stub</span> <span class="hljs-operator">=</span> (RemoteInterface) registry.lookup(<span class="hljs-string">&quot;Hello&quot;</span>);<br>        System.out.println(stub.sayHello());<br>        System.out.println(stub.sayGoodbye());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>Java code for Remote object Interface</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RemoteInterface</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(Object name)</span> <span class="hljs-keyword">throws</span> RemoteException;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayGoodbye</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>Java code for Remote object Implementation</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RemoteObject</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">UnicastRemoteObject</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RemoteInterface</span> &#123;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">RemoteObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hello My Friend&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(Object name)</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>        <span class="hljs-keyword">return</span> name.getClass().getName();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayGoodbye</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Bye&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>æµç¨‹åˆ†æ</p>
</li>
</ul>
<h2 id="æœåŠ¡æ³¨å†Œ"><a href="#æœåŠ¡æ³¨å†Œ" class="headerlink" title="æœåŠ¡æ³¨å†Œ"></a>æœåŠ¡æ³¨å†Œ</h2><h3 id="1-è¿œç¨‹å¯¹è±¡åˆ›å»º"><a href="#1-è¿œç¨‹å¯¹è±¡åˆ›å»º" class="headerlink" title="1. è¿œç¨‹å¯¹è±¡åˆ›å»º"></a>1. <strong>è¿œç¨‹å¯¹è±¡åˆ›å»º</strong></h3><p>èµ·å§‹äºï¼š<code>RemoteInterface remoteObject = new RemoteObject();</code></p>
<p>å…¶ç»§æ‰¿äºçˆ¶ç±» <code>UnicastRemoteObject</code> å› æ­¤åˆå§‹åŒ–æ—¶ä¼šè°ƒç”¨å…¶æ„é€ å‡½æ•°, port é»˜è®¤ä¸º 0ï¼Œå¹¶ç»§ç»­è°ƒç”¨ <code>exportObject</code> æ–¹æ³•</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%201.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%201.png" alt="Untitled"></p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%202.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%202.png" alt="Untitled"></p>
<p>è¿™é‡Œå¯ä»¥çœ‹åˆ°åœ¨ export è‡ªèº«çš„åŒæ—¶ï¼Œè¿˜ä¼šæ–°å»º UnicastServerRef å®ä¾‹ï¼Œè¿™ä¸ªä¸œè¥¿å†…éƒ¨ä¼šè¿›ä¸€æ­¥åˆ›å»ºä¸€ä¸ª LiveRef å¯¹è±¡ï¼Œç”±éšæœºæ•°+ç«¯å£è¿›è¡Œæ ‡è¯†</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%203.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%203.png" alt="Untitled"></p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%204.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%204.png" alt="Untitled"></p>
<p>è·Ÿè¿›å‘ç°ï¼Œå®ƒè¿˜ä¼šç»§ç»­è°ƒç”¨ <code>TCPEndpoint.getLocalEndpoint(var2)</code></p>
<p>å…¶ä¸­ä¼šåˆå§‹åŒ–ç½‘ç»œé€šä¿¡æ‰€éœ€çš„ host port ç­‰ä¿¡æ¯</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%205.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%205.png" alt="Untitled"></p>
<p>æœ€ç»ˆå°† TCPEndpoint å®ä¾‹èµ‹å€¼åˆ° LiveRef çš„ ep å­—æ®µä¸­</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%206.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%206.png" alt="Untitled"></p>
<p>å›åˆ°ä¸»çº¿ï¼ŒRemote å¯¹è±¡ä¼šè¿›ä¸€æ­¥é€šè¿‡ UnicastServerRef å®ä¾‹è¿›è¡Œ export</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%207.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%207.png" alt="Untitled"></p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%208.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%208.png" alt="Untitled"></p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%209.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%209.png" alt="Untitled"></p>
<p>å¯ä»¥çœ‹åˆ°è¯¥ <code>UnicastRef</code> å®ä¾‹æ‰€å­˜çš„å°±æ˜¯ä¹‹å‰ä¿å­˜äº†ç½‘ç»œé€šä¿¡ä¿¡æ¯çš„ <code>LiveRef</code></p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2010.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2010.png" alt="Untitled"></p>
<p>è·Ÿè¿›å¯ä»¥çœ‹åˆ°ï¼Œé¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªä»¥ â€œ_Stubâ€ ä¸ºåç¼€çš„ç±»å®ä¾‹ï¼ˆæ„é€ å‡½æ•°å‚æ•°ä¸ºåŒ…å«å·²åˆå§‹åŒ–<code>LiveRef</code> çš„ <code>UnicastRef</code> å®ä¾‹ï¼‰</p>
<p>å…¶æ¬¡ä¸º Remote å¯¹è±¡åˆ›å»ºäº†åŠ¨æ€ä»£ç†ï¼ˆåˆ©ç”¨ <code>RemoteObjectInvocationHandler</code>ï¼‰</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2011.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2011.png" alt="Untitled"></p>
<p>å¯¹äº <code>RemoteObjectInvocationHandler</code> å…¶ invoke æ–¹æ³•ï¼Œå½“å¾…è°ƒç”¨ä»£ç†æ–¹æ³•é Object å£°æ˜ï¼Œå¹¶ä¸”æ–¹æ³•åä¸æ˜¯ finalize æ—¶ï¼Œä¼šè°ƒç”¨ <code>invokeRemoteMethod</code></p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2012.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2012.png" alt="Untitled"></p>
<p>è¿™é‡Œå¯ä»¥çœ‹åˆ°å®é™…ä¸ŠçœŸæ­£è°ƒç”¨çš„æ˜¯ <code>sun.rmi.server.UnicastRef#invoke(java.rmi.Remote, java.lang.reflect.Method, java.lang.Object[], long)</code></p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2013.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2013.png" alt="Untitled"></p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2014.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2014.png" alt="Untitled"></p>
<p>è¯¥æ–¹æ³•ä¼šè·å– LiveRef å½“ä¸­çš„ç½‘ç»œé€šä¿¡ä¿¡æ¯ï¼Œåˆ›å»ºè¿æ¥ï¼Œæ‰§è¡Œè°ƒç”¨ï¼Œå¹¶è·å–ç»“æœæ‰§è¡Œ <code>unmarshalValue</code> è¿›ä¸€æ­¥æ‰§è¡ŒåŸç”Ÿååºåˆ—åŒ–</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2015.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2015.png" alt="Untitled"></p>
<p>å›åˆ° createProxy æ–¹æ³•ï¼Œï¼Œå°†åŠ¨æ€ä»£ç†å’Œ Remote å®ä¾‹å°è£…åˆ° Target ç±»å½“ä¸­ä¹‹åè°ƒç”¨ <code>sun.rmi.transport.LiveRef#exportObject</code> æ–¹æ³•ï¼Œå…¶ä¼šè¿›ä¸€æ­¥è°ƒç”¨ <code>TCPTransport#exportObject</code> æ¥ç›‘å¬ç«¯å£</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2016.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2016.png" alt="Untitled"></p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2017.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2017.png" alt="Untitled"></p>
<p>æ³¨æ„åˆ°ä¹‹åä¼šå°† Target å®ä¾‹é€šè¿‡ <code>sun.rmi.transport.Transport#exportObject</code> æ”¾åˆ° ObjectTable ä¸­</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2018.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2018.png" alt="Untitled"></p>
<p>è¯¥ ObjectTable å†…éƒ¨é€šè¿‡ HashMap ç®¡ç†æ‰€æœ‰ Target å®ä¾‹ï¼Œæ”¯æŒé€šè¿‡ ObjectEndpoint å’Œ WeakRef è¿›è¡Œç´¢å¼•</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2019.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2019.png" alt="Untitled"></p>
<h3 id="2-æ³¨å†Œä¸­å¿ƒåˆ›å»º"><a href="#2-æ³¨å†Œä¸­å¿ƒåˆ›å»º" class="headerlink" title="2. æ³¨å†Œä¸­å¿ƒåˆ›å»º"></a>2. <strong>æ³¨å†Œä¸­å¿ƒåˆ›å»º</strong></h3><p>èµ·å§‹äº <code>LocateRegistry.createRegistry(1099);</code></p>
<p>é¦–å…ˆè°ƒç”¨ RegistryImpl æ„é€ å‡½æ•°ï¼Œæ ¹æ®ç«¯å£æ˜¯å¦æŒ‡å®š 1099 è¿›å…¥ä¸åŒæ§åˆ¶åˆ†æ”¯ï¼Œä½†éƒ½ä¼šåˆ›å»º LiveRef é€šè®¯å®ä¾‹ä»¥åŠ UnicastServerRef å¯¹è±¡ã€‚æ¥ä¸‹æ¥è°ƒç”¨ setup æ–¹æ³•</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2020.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2020.png" alt="Untitled"></p>
<p>åè€…è·Ÿè¿› <code>UnicastServerRef#exportObject</code> ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå½“å‰ç±»å®ä¾‹ RegistryImpl</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2021.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2021.png" alt="Untitled"></p>
<p>åç»­æµç¨‹åŒæ ·èµ°åˆ° <code>sun.rmi.server.Util#createProxy</code> ä¸åŒç‚¹åœ¨äºè¿™é‡Œ stubClassExists æ–¹æ³• <em><code>withoutStubs</code></em> map æ˜¯ç©ºçš„ï¼Œå› æ­¤ä¼šæˆåŠŸåˆ›å»º <code>RegistryImpl_Stub</code> å®ä¾‹å¹¶è¿”å›ï¼Œä¸å†è¿›ä¸€æ­¥å‘ä¸‹åˆ›å»ºåŠ¨æ€ä»£ç†</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2022.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2022.png" alt="Untitled"></p>
<p><code>RegistryImpl_Stub</code> ç±»ç»§æ‰¿äº <code>RemoteStub</code> å¹¶å®ç°äº†ä¸€ç³»åˆ— bind list lookup ç­‰æœåŠ¡æ“ä½œ API</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2023.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2023.png" alt="Untitled"></p>
<p>ä¸æœåŠ¡æ³¨å†Œæ—¶ä½¿ç”¨çš„ <code>RemoteObjectInvocationHandler</code> ç±»ä¼¼ï¼Œå…¶é€šä¿¡æ—¶æ•°æ®ä¼ è¾“ä¹Ÿæ˜¯é€šè¿‡ç›´æ¥åºåˆ—åŒ–å®ç°</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2024.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2024.png" alt="Untitled"></p>
<p>åç»­æ³¨å†Œä¸­å¿ƒå°±ä¼šè°ƒç”¨ <code>setSkeleton</code> æ–¹æ³•è®¾ç½®æœåŠ¡ç«¯ skeletonï¼Œå¯ä»¥çœ‹åˆ°å®é™…ä¼šé€šè¿‡åå°„åˆ›å»º <code>RegistryImpl_Skel</code> å®ä¾‹ï¼Œè®¾ç½®åˆ° UnicastServerRef çš„ <code>skel</code> å­—æ®µä¸Š</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2025.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2025.png" alt="Untitled"></p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2026.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2026.png" alt="Untitled"></p>
<p>åç»­æµç¨‹ä¸åˆ›å»ºè¿œç¨‹æœåŠ¡å¯¹è±¡ä¸€è‡´ï¼Œåˆ›å»º Targetï¼Œå¹¶è®¾ç½®åˆ° ObjectTable ä¸­</p>
<h3 id="3-æœåŠ¡æ³¨å†Œ"><a href="#3-æœåŠ¡æ³¨å†Œ" class="headerlink" title="3. æœåŠ¡æ³¨å†Œ"></a>3. <strong>æœåŠ¡æ³¨å†Œ</strong></h3><p>é€šç”¨æ–¹æ³•æ˜¯ <code>registry.bind</code> </p>
<h2 id="æœåŠ¡å‘ç°"><a href="#æœåŠ¡å‘ç°" class="headerlink" title="æœåŠ¡å‘ç°"></a>æœåŠ¡å‘ç°</h2><h3 id="è¯·æ±‚æ³¨å†Œä¸­å¿ƒ"><a href="#è¯·æ±‚æ³¨å†Œä¸­å¿ƒ" class="headerlink" title="è¯·æ±‚æ³¨å†Œä¸­å¿ƒ"></a>è¯·æ±‚æ³¨å†Œä¸­å¿ƒ</h3><p>ä½“ç°åœ¨ <code>LocateRegistry.getRegistry()</code></p>
<p><strong>ã€ŒæœåŠ¡ç«¯è¡Œä¸ºã€</strong>ï¼š</p>
<p>é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªåŒ…å«æ³¨å†Œä¸­å¿ƒé€šä¿¡åœ°å€çš„ RegistryImpl_Stub å¯¹è±¡ï¼›</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2027.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2027.png" alt="Untitled"></p>
<p>æ¥ä¸‹æ¥è°ƒç”¨ bind æ–¹æ³•è¿›è¡ŒæœåŠ¡å¯¹è±¡å’Œå‘½åç»‘å®šæ—¶å®é™…ä¼šè°ƒç”¨ <code>sun.rmi.registry.RegistryImpl_Stub#bind</code> æ–¹æ³•ï¼Œé¦–å…ˆé€šè¿‡çˆ¶ç±» UnicastRef ä¸Šè®¾ç½®å¥½é€šè®¯åœ°å€çš„ ref å­—æ®µæ¥è°ƒç”¨ <code>sun.rmi.server.UnicastRef#newCall</code></p>
<p>è¿™é‡Œå°±æ˜¯ç®€å•é€šè¿‡ UnicastRef#newCall ä¸æ³¨å†Œä¸­å¿ƒå»ºç«‹è¿æ¥ï¼Œåç»­ç›´æ¥å†™å…¥è¾“å‡ºæµï¼Œå†™å…¥æ–¹æ³•åå’Œè¿œç¨‹å®ä¾‹</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2028.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2028.png" alt="Untitled"></p>
<p><aside><br>ğŸ’¡ è¿™é‡Œå­˜åœ¨ç–‘é—®ç‚¹ï¼šä¸ su18 å¸ˆå‚…æåˆ°çš„è°ƒç”¨æ–¹æ³•å­˜åœ¨å‡ºå…¥ï¼Œå®é™…å†™å…¥çš„åº”è¯¥æ˜¯æœåŠ¡ç«¯ä¹‹å‰å·²ç»ä¿å­˜åœ¨ ObjectTable å½“ä¸­çš„ <code>RemoteObjectInvocationHandler</code> åŠ¨æ€ä»£ç†ï¼ˆæ ¹æ® Remote å®ä¾‹æ¥ç´¢å¼•ï¼‰<br>ã€Œå¯èƒ½çš„è§£é‡Šã€ï¼šRegistry ç«¯ä¸æœåŠ¡ç«¯åœ¨åŒä¸€ä½ç½®ä¸Šï¼Œä¸¤è€…ä¹‹å‰çš„é€šè®¯ä¿¡æ¯å¹¶éé€šè¿‡TCPTransport ï¼Œæ— æ³•å¤ç°å‡º su18 å¸ˆå‚…çš„ä¿¡æ¯ï¼Œè¿™é‡Œä»”ç»†çœ‹ä»–çš„å†…å®¹è§£é‡Š</aside></p>
<h2 id="æœåŠ¡è°ƒç”¨"><a href="#æœåŠ¡è°ƒç”¨" class="headerlink" title="æœåŠ¡è°ƒç”¨"></a>æœåŠ¡è°ƒç”¨</h2><p>ä»¥å®¢æˆ·ç«¯è·å–åˆ°æ³¨å†Œä¸­å¿ƒåï¼Œè°ƒç”¨ lookup å¯»æ‰¾æŒ‡å®šå‘½åçš„ RMI æœåŠ¡ä¸ºä¾‹</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2029.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2029.png" alt="Untitled"></p>
<p>è¿‡ç¨‹å¾ˆç®€å•ï¼Œå»ºç«‹è¿æ¥ã€åºåˆ—åŒ–æœåŠ¡åç§°å¹¶å†™å…¥è¾“å‡ºæµã€è·å–åˆ°è¾“å…¥æµå¹¶æ‰§è¡Œååºåˆ—åŒ–</p>
<p>Registry ç«¯/æœåŠ¡ç«¯è¡¨ç°ä½äº <code>RegistryImpl_Skel</code> çš„ dispatch æ–¹æ³•</p>
<h2 id="æ•´ä½“æµç¨‹æ¡†æ¶"><a href="#æ•´ä½“æµç¨‹æ¡†æ¶" class="headerlink" title="æ•´ä½“æµç¨‹æ¡†æ¶"></a>æ•´ä½“æµç¨‹æ¡†æ¶</h2><p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2030.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2030.png" alt="Untitled"></p>
<h2 id="0x02-Attack"><a href="#0x02-Attack" class="headerlink" title="0x02. Attack"></a>0x02. Attack</h2><h3 id="1-æ”»å‡»-Server-ç«¯"><a href="#1-æ”»å‡»-Server-ç«¯" class="headerlink" title="1. æ”»å‡» Server ç«¯"></a>1. <strong>æ”»å‡» Server ç«¯</strong></h3><ul>
<li><p>æ¶æ„æœåŠ¡å‚æ•°</p>
<p>  å‘ç”Ÿåœ¨å®¢æˆ·ç«¯è°ƒç”¨è¿œç¨‹æœåŠ¡å¯¹è±¡çš„æ–¹æ³•æ—¶ï¼Œé€šè¿‡è·å–åˆ°çš„è¿œç¨‹ä»£ç†ï¼Œä¼ è¾“åºåˆ—åŒ–çš„æ–¹æ³•åï¼ˆ<em>SHA1 based hash</em>ï¼‰åŠå‚æ•°</p>
<p>  ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ<strong>è‹¥è¿œç¨‹æœåŠ¡æ¥å£å¯¹åº”çš„æ–¹æ³•å‚æ•°ç±»å‹ä¸º Object</strong>ï¼Œåˆ™å¯ä»¥ç›´æ¥æ„é€ ä»»æ„çš„åºåˆ—åŒ–æ•°æ®é€ æˆ RCE Attack</p>
<p>  ä½†æ˜¯è‹¥ä¸çŸ¥é“æ–¹æ³•å‚æ•°å…·ä½“ç±»å‹ï¼Œä»æƒ³è¦ä¼ è¾“ä»»æ„ç±»å‹çš„åºåˆ—åŒ–æ•°æ®ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2031.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2031.png" alt="Untitled"></p>
<p>  <strong>TODO</strong> ğŸ“­</p>
<p>  åŸºæœ¬æ€è·¯å°±æ˜¯åˆ©ç”¨ agent ç­‰æ–¹å¼ï¼Œhook ä½ RemoteObjectInvocationHandler çš„ <code>invokeRemoteMethod</code> æ–¹æ³•æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯å®¢æˆ·ç«¯åœ¨åˆ©ç”¨ä»£ç†ï¼Œè°ƒç”¨æœåŠ¡ç«¯å¯¹è±¡æ–¹æ³•æ—¶ï¼Œå‚æ•°ç±»å‹ä¼ é€’æ—¶åŠ¨æ€ä¿®æ”¹ä¸ºæŒ‡å®šè¦æ±‚çš„ç±»å‹å³å¯</p>
</li>
<li><p>åŠ¨æ€ç±»åŠ è½½</p>
<p>  ==ã€Œé€‚ç”¨ç‰ˆæœ¬ã€==6u45/7u21</p>
<p>  <strong>æ¡ä»¶</strong>ï¼šSecurityManager + <code>java.rmi.server.useCodebaseOnly=false</code></p>
<p>  <strong>position</strong>: ååºåˆ—åŒ–æ“ä½œå‘ç”Ÿåœ¨æœåŠ¡ç«¯æ¥æ”¶å“åº”å®¢æˆ·ç«¯å‘æ¥çš„ç½‘ç»œè¯·æ±‚æ—¶ï¼Œè°ƒç”¨çš„ <code>sun.rmi.server.UnicastServerRef#dispatch</code> æ–¹æ³•ï¼Œåºåˆ—åŒ–è¾“å…¥æµç”± <code>MarshalInputStream</code> å°è£…ï¼ŒæœŸé—´æ‰§è¡Œ resolveClass æ£€æŸ¥åºåˆ—åŒ–æ•°æ®</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2032.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2032.png" alt="Untitled"></p>
<p>  å…¶ var5 ååºåˆ—åŒ–å¾—åˆ°æŒ‡å®š codebase url åœ°å€ï¼ŒåŒæ—¶æƒ³è¦çœŸæ­£æ‰§è¡Œç±»åŠ è½½ï¼Œè¿˜éœ€è¦æ»¡è¶³ useCodebaseOnly ä¸º falseï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå­˜åœ¨ç‰ˆæœ¬é™åˆ¶ï¼ˆ6u45/7u21 é»˜è®¤ä¸º false)</p>
<p>  é‡ç‚¹åœ¨äº codebase åœ°å€å¯ä»¥è¢«åŒæ–¹æ§åˆ¶</p>
</li>
</ul>
<h3 id="2-æ”»å‡»-Registry-ç«¯"><a href="#2-æ”»å‡»-Registry-ç«¯" class="headerlink" title="2. æ”»å‡» Registry ç«¯"></a>2. æ”»å‡» Registry ç«¯</h3><p>ä»¥ bind ä¸ºä¾‹ï¼Œæ³¨å†Œç«¯çŸ¥é“ä¼šä½¿ç”¨ <code>sun.rmi.registry.RegistryImpl_Skel#dispatch</code> æ¥æ¥æ”¶æœåŠ¡ç«¯å‘æ¥çš„åºåˆ—åŒ–çš„æœåŠ¡åç§°ä»¥åŠè¿œç¨‹ä»£ç†å¯¹è±¡ï¼Œå¹¶é€šè¿‡ <code>RegistryImpl</code> çš„ bind æ–¹æ³•ä¿å­˜åœ¨ bindings HashTable ä¸­</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2033.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2033.png" alt="Untitled"></p>
<p>å› æ­¤è¿™é‡Œå¯ä»¥ç›´æ¥ä¼ é€’æ¶æ„çš„åºåˆ—åŒ–è¿œç¨‹ä»£ç†ç±»ï¼Œåœ¨æ³¨å†Œç«¯ååºåˆ—åŒ–æ—¶ RCE</p>
<p>å…·ä½“çš„å®è·µï¼šyso_RMIRegistryExploit</p>
<p>yso ä¸­ä»¥ CC1 ä¸ºä¾‹ï¼Œè·å–åˆ° CC1 æ¶æ„ gadget åï¼Œåˆ›å»º Remote ä»£ç†(åˆ©ç”¨çš„ handler æ˜¯ AnnotationInvocationHandlerï¼Œå°† payload è®¾ç½®åˆ° handler çš„ map ä¸­ï¼Œååºåˆ—åŒ–æ—¶ä¼´éšç€è§¦å‘)ï¼Œä¹‹åé€šè¿‡ bind åºåˆ—åŒ–ä¼ é€’</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2034.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2034.png" alt="Untitled"></p>
<h3 id="3-æ”»å‡»-DGC"><a href="#3-æ”»å‡»-DGC" class="headerlink" title="3. æ”»å‡» DGC"></a>3. æ”»å‡» DGC</h3><blockquote>
<p>Server ç«¯å¯åŠ¨ DGCImplï¼Œåœ¨ Registry ç«¯æ³¨å†Œ DGCImpl_Stub ï¼ŒClient ç«¯è·å–åˆ° DGCImpl_Stubï¼Œé€šè¿‡å…¶ä¸ Server ç«¯é€šä¿¡ï¼ŒServer ç«¯ä½¿ç”¨ RegistryImpl_Skel æ¥å¤„ç†ã€‚</p>
</blockquote>
<p>DGC åœ¨å®¢æˆ·ç«¯æ¥æ”¶æœåŠ¡ç«¯è¿”å›çš„è¿œç¨‹å¯¹è±¡è°ƒç”¨åŒæ—¶ï¼Œä¼šåˆ›å»º DGCImpl_Stub ä»¥åŠ DCGImpl_Skel æ¥ç»´æŠ¤è¿œç¨‹å¯¹è±¡çš„å¼•ç”¨</p>
<p>==ã€ŒDCGImpl_Skel#dispatchã€==ï¼šç›‘å¬è¯·æ±‚</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2035.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2035.png" alt="Untitled"></p>
<p>==ã€ŒDGCImpl_Stub#dirty/clean æ›´æ–°/å›æ”¶å¼•ç”¨å¯¹è±¡ã€==ï¼š</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2036.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2036.png" alt="Untitled"></p>
<h3 id="æ­¦å™¨åŒ–Exploit-ysoserial-â€”â€”-JRMP"><a href="#æ­¦å™¨åŒ–Exploit-ysoserial-â€”â€”-JRMP" class="headerlink" title="æ­¦å™¨åŒ–Exploit: ysoserial â€”â€” JRMP"></a>æ­¦å™¨åŒ–Exploit: ysoserial â€”â€” JRMP</h3><ul>
<li><p>JRMP Listener module</p>
<p>  æœ¬è´¨æ˜¯ä¸€æ¡ååºåˆ—åŒ– Gadget ï¼Œå¯ä»¥è¾¾åˆ°åœ¨æœ¬åœ°æŒ‡å®šç«¯å£å¼€å¯ JRMP åè®®çš„æ•ˆæœ</p>
  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Gadget chain:</span><br><span class="hljs-comment"> * UnicastRemoteObject.readObject(ObjectInputStream) line: 235</span><br><span class="hljs-comment"> * UnicastRemoteObject.reexport() line: 266</span><br><span class="hljs-comment"> * UnicastRemoteObject.exportObject(Remote, int) line: 320</span><br><span class="hljs-comment"> * UnicastRemoteObject.exportObject(Remote, UnicastServerRef) line: 383</span><br><span class="hljs-comment"> * UnicastServerRef.exportObject(Remote, Object, boolean) line: 208</span><br><span class="hljs-comment"> * LiveRef.exportObject(Target) line: 147</span><br><span class="hljs-comment"> * TCPEndpoint.exportObject(Target) line: 411</span><br><span class="hljs-comment"> * TCPTransport.exportObject(Target) line: 249</span><br><span class="hljs-comment"> * TCPTransport.listen() line: 319</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Requires:</span><br><span class="hljs-comment"> * - JavaSE</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Argument:</span><br><span class="hljs-comment"> * - Port number to open listener to</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure>
<p>  ä½œç”¨å¤§è‡´å°±æ˜¯ç±»ä¼¼åè¿å¹³å°ï¼Œå¯ä»¥è‡ªåŠ¨å“åº”è¿æ¥è¯·æ±‚ï¼Œå¹¶è¿”å›æŒ‡å®šçš„åºåˆ—åŒ–æ•°æ®</p>
<p>  ==ã€ŒGadget æ„é€ ã€==ï¼š</p>
<p>  é¦–å…ˆçœ‹ä¸‹ç”¨åˆ°çš„ç±»ï¼Œé¦–å…ˆæ‹¿åˆ° <code>RemoteObject</code> çš„æ„é€ å‡½æ•°ï¼ˆå‚æ•°ç±»å‹ä¸º<code>RemoteRef</code>, å‚æ•°å®ä¾‹ä¼ é€’å­ç±» UnicastServerRefï¼Œå¹¶æŒ‡å®šç«¯å£ï¼‰</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2037.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2037.png" alt="Untitled"></p>
<p>  ä¹‹åä¼šè°ƒç”¨ <code>sun.reflect.ReflectionFactory#newConstructorForSerialization</code> ä¼ å…¥ var1 ä»£è¡¨ <code>ActivationGroupImpl</code> classï¼Œvar2 ä»£è¡¨æŒ‡å®š <code>RemoteObject</code> æ„é€ å™¨ï¼Œå½“ var2 çš„å£°æ˜ç±»é var1 æ—¶ï¼Œä¼šå»åˆ›å»ºåºåˆ—åŒ–æ„é€ å‡½æ•°ï¼ˆ<code>ActivationGroupImpl</code> ç±»ï¼‰</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2038.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2038.png" alt="Untitled"></p>
<p>  è¿™é‡Œçš„ä½œç”¨å®é™…åˆ›å»ºä¸€ä¸ªåºåˆ—åŒ–æ„é€ å‡½æ•°ï¼Œå…è®¸åœ¨ååºåˆ—åŒ–æ—¶è°ƒç”¨æ„é€ å‡½æ•°æ¥åˆ›å»ºæ–°çš„å¯¹è±¡å®ä¾‹</p>
<blockquote>
<p>å¦‚æœæƒ³åœ¨ååºåˆ—åŒ–æ—¶æ‰§è¡Œä¸€äº›ç‰¹æ®Šçš„åˆå§‹åŒ–æˆ–å¤„ç†æ­¥éª¤ï¼Œå¯ä»¥åœ¨ç±»ä¸­å®šä¹‰ä¸€ä¸ªç‰¹æ®Šçš„æ„é€ å‡½æ•°ï¼Œç„¶ååœ¨è¯¥æ„é€ å‡½æ•°ä¸­æ‰§è¡Œè¿™äº›æ“ä½œã€‚ä½†è¯·ç¡®ä¿è¿™ä¸ªæ„é€ å‡½æ•°æ˜¯ <strong><code>public</code></strong> çš„ä¸”æ²¡æœ‰å‚æ•°ã€‚</p>
</blockquote>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2039.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2039.png" alt="Untitled"></p>
<p>  æœ€ç»ˆè¿”å›çš„æ˜¯ <code>ActivationGroupImpl</code> å®ä¾‹ï¼Œå‘ä¸Šè½¬å‹ä¸º <code>UnicastRemoteObject</code>ï¼ˆå¥½ç¥å¥‡</p>
<p>  æœ€ååå°„è®¾ç½®å­—æ®µ <code>port</code> ä¸ºæŒ‡å®šç«¯å£</p>
<p>  ==ã€ŒGadget ååºåˆ—åŒ–åˆ†æã€==ï¼š</p>
<p>  å›å¿† <code>UnicastRemoteObject</code> çš„ä½œç”¨</p>
<blockquote>
<p><code>java.rmi.server.UnicastRemoteObject</code> ç±»é€šå¸¸æ˜¯è¿œç¨‹è°ƒç”¨æ¥å£å®ç°ç±»çš„çˆ¶ç±»ï¼Œæˆ–ç›´æ¥ä½¿ç”¨å…¶é™æ€æ–¹æ³• <code>exportObject</code> æ¥åˆ›å»ºåŠ¨æ€ä»£ç†å¹¶éšæœºç›‘å¬æœ¬æœºç«¯å£ä»¥æä¾›æœåŠ¡ã€‚</p>
</blockquote>
<p>  ä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨åˆ›å»ºè¿œç¨‹æœåŠ¡å¯¹è±¡æ—¶å£°æ˜å…¶ä¸ºçˆ¶ç±»çš„é‚£ä¸ª</p>
<p>  readObject æ–¹æ³•ä¸­ä¼šæ‰§è¡Œ reexport() </p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2040.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2040.png" alt="Untitled"></p>
<p>  ä¹‹åæŒ‡å®šç«¯å£ exportObject</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2041.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2041.png" alt="Untitled"></p>
<p>  export è¿‡ç¨‹ä¸­åˆ›å»º UnicastServerRef ç½‘ç»œé€šä¿¡å®ä¾‹</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2042.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2042.png" alt="Untitled"></p>
<p>  ä¹‹åçš„åˆ†æä¸å‰é¢ä¸€è‡´äº†å°±ï¼ŒåŠ¿å¿…ä¼šæ‰“å¼€æŒ‡å®šç«¯å£çš„ JRMP åè®®ï¼Œç›‘å¬è¯·æ±‚ï¼ŒæœŸé—´çš„ç½‘ç»œä¼ è¾“æ•°æ®é‡‡ç”¨åºåˆ—åŒ–æ ¼å¼</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2043.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2043.png" alt="Untitled"></p>
<p>  é‚£ä¹ˆ <code>ActivationGroupImpl</code> åœ¨è¿™é‡Œçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p>  è¿™é‡Œä¸æ˜¯å¾ˆæ‡‚ï¼Œåº”è¯¥æ˜¯çˆ¶ç±» UnicastRemoteObject æ„é€ å‡½æ•°æ— æ³•ç›´æ¥æ„é€ ï¼Œæˆ–è€…ä½¿ç”¨ UnSafe æ¥æ„é€ ä¹Ÿå¯ä»¥</p>
</li>
<li><p>JRMP JRMPClient(payload)</p>
  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * UnicastRef.newCall(RemoteObject, Operation[], int, long)</span><br><span class="hljs-comment"> * DGCImpl_Stub.dirty(ObjID[], long, Lease)</span><br><span class="hljs-comment"> * DGCClient$EndpointEntry.makeDirtyCall(Set&lt;RefEntry&gt;, long)</span><br><span class="hljs-comment"> * DGCClient$EndpointEntry.registerRefs(List&lt;LiveRef&gt;)</span><br><span class="hljs-comment"> * DGCClient.registerRefs(Endpoint, List&lt;LiveRef&gt;)</span><br><span class="hljs-comment"> * LiveRef.read(ObjectInput, boolean)</span><br><span class="hljs-comment"> * UnicastRef.readExternal(ObjectInput)</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Thread.start()</span><br><span class="hljs-comment"> * DGCClient$EndpointEntry.&lt;init&gt;(Endpoint)</span><br><span class="hljs-comment"> * DGCClient$EndpointEntry.lookup(Endpoint)</span><br><span class="hljs-comment"> * DGCClient.registerRefs(Endpoint, List&lt;LiveRef&gt;)</span><br><span class="hljs-comment"> * LiveRef.read(ObjectInput, boolean)</span><br><span class="hljs-comment"> * UnicastRef.readExternal(ObjectInput)</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Requires:</span><br><span class="hljs-comment"> * - JavaSE</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Argument:</span><br><span class="hljs-comment"> * - host:port to connect to, host only chooses random port (DOS if repeated many times)</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Yields:</span><br><span class="hljs-comment"> * * an established JRMP connection to the endpoint (if reachable)</span><br><span class="hljs-comment"> * * a connected RMI Registry proxy</span><br><span class="hljs-comment"> * * one system thread per endpoint (DOS)</span><br></code></pre></td></tr></table></figure>
<p>  å…¥å£ç‚¹ä»ä»»æ„ä¸€ä¸ªç»§æ‰¿çˆ¶ç±» RemoteObject çš„å¯¹è±¡å¼€å§‹ï¼Œçˆ¶ç±»çš„ readObject æ–¹æ³•ä¼šè¿›ä¸€æ­¥è°ƒç”¨ ref å­—æ®µçš„ readExternal æ–¹æ³•</p>
<p>  <code>sun.rmi.server.UnicastRef#readExternal</code> è¿™é‡Œä¼šè°ƒç”¨ <code>[LiveRef.*read](http://LiveRef.read)</code>* æ¥æ¢å¤åˆ›å»º ref å­—æ®µçš„é€šä¿¡å®ä¾‹</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2044.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2044.png" alt="Untitled"></p>
<p>  åˆ›å»º TCPEndpoint ä¹‹åï¼Œä¼šè¿›ä¸€æ­¥è°ƒç”¨ <code>DGCClient.*registerRefs*</code></p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2045.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2045.png" alt="Untitled"></p>
<p>  å…¶ä¸­ä¼šå¾ªç¯è·å–æ‰€æœ‰é€šä¿¡èŠ‚ç‚¹ï¼Œè°ƒç”¨ <code>EndpointEntry#registerRefs</code> æœ€åè°ƒç”¨ <code>makeDirtyCall</code></p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2046.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2046.png" alt="Untitled"></p>
<p>  æœ€åè§¦å‘ DGC çš„ dirty æ“ä½œ</p>
<blockquote>
<p>å› æ­¤å¯ä»¥çœ‹å‡ºï¼Œåœ¨ UnicastRef è¿›è¡Œååºåˆ—åŒ–æ—¶ï¼Œä¼šè§¦å‘ DGC é€šä¿¡åŠ dirty æ–¹æ³•è°ƒç”¨ï¼Œæ­¤æ—¶å¦‚æœä¸ä¸€ä¸ªæ¶æ„æœåŠ¡é€šä¿¡ï¼Œè¿”å›æ¶æ„æ•°æ®æµï¼Œåˆ™ä¼šé€ æˆååºåˆ—åŒ–æ¼æ´ã€‚</p>
</blockquote>
<p>  yso é¡¹ç›®ä¸­ä½¿ç”¨çš„æ˜¯ <code>RemoteObjectInvocationHandler</code> ä½œä¸º handlerï¼Œå°è£…æˆ <code>Registry</code> çš„ä»£ç†ç±»</p>
<p>  åˆ©ç”¨ï¼šåˆ©ç”¨<code>JRMPClient</code>è¿™ä¸ªGadgetå»è°ƒç”¨<code>JRMPListener</code>,ç„¶å<code>JRMPListener</code>åˆ©ç”¨<code>CommonsCollections</code>è¿™ä¸ªGadgetæ¥å®ç°RCEã€‚</p>
</li>
<li><p>ç²¾ç®€ç‰ˆ</p>
<p>  å› ä¸º <code>RemoteObjectInvocationHandler</code> åŠ¨æ€ä»£ç† <code>Registry</code> æ¥å£å½¢æˆçš„è¿™ä¸ª Registry å·²ç»åç»­è¢«åˆ—å…¥é»‘åå•äº†ï¼Œå› æ­¤éœ€è¦ç»•è¿‡ã€‚</p>
<ul>
<li><p>ç¼©çŸ­é“¾å­</p>
<p>  æˆ‘ä»¬çŸ¥é“ä¸Šä¸€æ¡é“¾å­ä¸­ <code>UnicastRef</code> å®ç°äº† <code>Externalizable</code> æ¥å£ï¼Œå› æ­¤å¯ä»¥ç›´æ¥ååºåˆ—åŒ–å¹¶è°ƒç”¨é‡å†™ <code>readExternal</code> æ–¹æ³•ï¼Œè¿›è€Œè§¦å‘å’Œå‰è¿°ä¸€æ ·çš„åˆ©ç”¨é“¾</p>
<ul>
<li><p>Java Poc</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">(String command)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        String host;<br>        <span class="hljs-type">int</span> port;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">sep</span> <span class="hljs-operator">=</span> command.indexOf(<span class="hljs-string">&#x27;:&#x27;</span>);<br>        <span class="hljs-keyword">if</span> ( sep &lt; <span class="hljs-number">0</span> ) &#123;<br>            port = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>().nextInt(<span class="hljs-number">65535</span>);<br>            host = command;<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            host = command.substring(<span class="hljs-number">0</span>, sep);<br>            port = Integer.valueOf(command.substring(sep + <span class="hljs-number">1</span>));<br>        &#125;<br><br>        <span class="hljs-type">ObjID</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjID</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>().nextInt()); <span class="hljs-comment">// RMI registry</span><br>        <span class="hljs-type">TCPEndpoint</span> <span class="hljs-variable">te</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TCPEndpoint</span>(host, port);<br>        <span class="hljs-type">UnicastRef</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnicastRef</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LiveRef</span>(id, te, <span class="hljs-literal">false</span>));<br><br>        <span class="hljs-keyword">return</span> ref;<br>    &#125;<br></code></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>æ›´æ¢ä»£ç†æ¥å£</p>
</li>
</ul>
</li>
</ul>
<h2 id="0x03-JEP-290"><a href="#0x03-JEP-290" class="headerlink" title="0x03. JEP 290"></a>0x03. JEP 290</h2><hr>
<p>æä¾›çš„æœºåˆ¶å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>(1) æä¾›ä¸€ä¸ªé™åˆ¶ååºåˆ—åŒ–ç±»çš„æœºåˆ¶ï¼Œç™½åå•æˆ–è€…é»‘åå•</p>
<p>(2) é™åˆ¶ååºåˆ—åŒ–çš„æ·±åº¦å’Œå¤æ‚åº¦</p>
<p>(3) ä¸º RMI è¿œç¨‹è°ƒç”¨å¯¹è±¡(exportObject)æä¾›äº†ä¸€ä¸ª<strong>éªŒè¯ç±»</strong>çš„æœºåˆ¶</p>
<p>(4) å®šä¹‰ä¸€ä¸ªå¯é…ç½®çš„<strong>è¿‡æ»¤æœºåˆ¶</strong>ï¼Œæ¯”å¦‚å¯ä»¥é€šè¿‡é…ç½® properties æ–‡ä»¶çš„å½¢å¼æ¥å®šä¹‰è¿‡æ»¤å™¨</p>
</blockquote>
<p>ç‰ˆæœ¬ï¼š</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2047.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2047.png" alt="Untitled"></p>
<blockquote>
<p>JEP 290 ä¸»è¦æ˜¯åœ¨ <code>ObjectInputStream</code> ç±»ä¸­å¢åŠ äº†ä¸€ä¸ª<code>serialFilter</code>å±æ€§å’Œä¸€ä¸ª <code>filterChcek</code> å‡½æ•°ï¼Œå…¶ä¸­ <code>serialFilter</code>å°±å¯ä»¥ç†è§£ä¸ºè¿‡æ»¤å™¨ã€‚<br>åœ¨ <code>ObjectInputStream</code> å¯¹è±¡è¿›è¡Œ <code>readObject</code> çš„æ—¶å€™ï¼Œå†…éƒ¨ä¼šè°ƒç”¨ <code>filterChcek</code> æ–¹æ³•è¿›è¡Œæ£€æŸ¥ï¼Œ<code>filterCheck</code>æ–¹æ³•ä¸­ä¼šå¯¹ <code>`serialFilter</code>å±æ€§è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœä¸æ˜¯ <code>null</code> ,å°±ä¼šè°ƒç”¨ <code>serialFilter.checkInput</code> æ–¹æ³•è¿›è¡Œè¿‡æ»¤ã€‚<br>è®¾ç½®è¿‡æ»¤å™¨æœ¬è´¨å°±æ˜¯è®¾ç½® <code>ObjectInputStream</code> çš„ <code>serialFilter</code> å­—æ®µå€¼ï¼Œè®¾ç½®è¿‡æ»¤å™¨å¯ä»¥åˆ†ä¸ºè®¾ç½®å…¨å±€è¿‡æ»¤å™¨å’Œè®¾ç½®å±€éƒ¨è¿‡æ»¤å™¨ï¼š</p>
<ol>
<li>è®¾ç½®å…¨å±€è¿‡æ»¤å™¨æ˜¯æŒ‡ï¼Œé€šè¿‡ä¿®æ”¹ <code>Config.serialFilter</code>è¿™ä¸ªé™æ€å­—æ®µçš„å€¼æ¥è¾¾åˆ°è®¾ç½®æ‰€æœ‰ <code>ObjectInputStream</code>å¯¹è±¡çš„ <code>serialFilter</code>å€¼ ã€‚å…·ä½“åŸå› æ˜¯å› ä¸º <code>ObjectInputStream</code> çš„æ„é€ å‡½æ•°ä¼šè¯»å–<code>Config.serialFilter</code>çš„å€¼èµ‹å€¼åˆ°è‡ªå·±çš„<code>serialFilter</code>å­—æ®µä¸Šï¼Œæ‰€æœ‰å°±ä¼šå¯¼è‡´æ‰€æœ‰ <code>new</code> å‡ºæ¥çš„ <code>ObjectInputStream</code>å¯¹è±¡çš„ <code>serailFilter</code> éƒ½ä¸º<code>Config.serialFilter</code>çš„å€¼ã€‚</li>
<li>è®¾ç½®å±€éƒ¨è¿‡æ»¤å™¨æ˜¯æŒ‡ï¼Œåœ¨ <code>new</code> <code>ObjectInputStream</code> çš„ä¹‹åï¼Œå†ä¿®æ”¹å•ä¸ª <code>ObjectInputStream</code> å¯¹è±¡çš„ <code>serialFilter</code> å­—æ®µå€¼</li>
</ol>
</blockquote>
<p>JEP290 æœºåˆ¶ï¼Œå®é™…å¯ä»¥é€šè¿‡ JVM ç©¿å‚æ•°æˆ–è€…é…ç½®æ–‡ä»¶çš„æ–¹å¼æ¥è®¾ç½®é˜²å¾¡è§„åˆ™ï¼ŒRMI å¯é‡‡ç”¨é»˜è®¤ç™½åå•çš„é˜²å¾¡è§„åˆ™ã€‚è§„åˆ™ä¼ å…¥ä¸ºå­—ç¬¦ä¸²å½¢å¼ï¼Œåœ¨ <code>Global</code> ç±»çš„æ„é€ å‡½æ•°ä¸­è¿›è¡Œè§£æï¼Œå…·ä½“è§£æé€»è¾‘å¦‚ä¸‹æ‰€ç¤º</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2048.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2048.png" alt="Untitled"></p>
<p>è§£æä¹‹åè¿”å›å¹¶è®¾ç½®åˆ° ObjectInputFilter ç±»çš„ <em><code>configuredFilter</code></em> å­—æ®µä¸Šï¼Œå½“ ObjectInputStream åœ¨åˆå§‹åŒ–æ—¶ï¼Œä¾¿ä¼šè·å–åˆ° <em><code>configuredFilter</code></em> å­—æ®µä¸Šçš„å®ä¾‹ï¼Œå¹¶è®¾ç½®åˆ°è¾“å…¥æµçš„ serialFilter å­—æ®µä¹‹ä¸Šã€‚å½“è¿›è¡Œ readObject ä¹‹å‰ä¼šè‡ªåŠ¨è§¦å‘ <code>filterCheck</code> æ–¹æ³•ï¼Œè¿›è€Œ serialFilter éç©ºæ—¶è°ƒç”¨ <code>serialFilter.checkInput</code> æšä¸¾è¾“å…¥æµä¸­çš„ç±»ä¸è§„åˆ™è¿›è¡ŒåŒ¹é…ï¼Œè¿›è¡Œåˆæ³•æ€§æ ¡éªŒ</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2049.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2049.png" alt="Untitled"></p>
<p><strong>ã€ŒRMI ä¸­ JEP290 æœºåˆ¶çš„å®ç°ã€</strong>ï¼š</p>
<p>RegistryImpl åœ¨æ„é€ å‡½æ•°ä¸­ï¼Œä¼´éšç€ <code>UnicastServerRef2</code> çš„åˆå§‹åŒ–ï¼Œä¼šé€šè¿‡ lambda è¡¨è¾¾å¼ä»¥åŠæ–¹æ³•å¼•ç”¨çš„æ–¹å¼è®¾ç½® RMI çš„é»˜è®¤ JEP290 é˜²å¾¡è§„åˆ™</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2050.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2050.png" alt="Untitled"></p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2051.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2051.png" alt="Untitled"></p>
<p>ä¸Šå›¾æ˜¯ RegistryImpl çš„ <em><code>registryFilter</code></em> è¿™ä¸ªé™æ€å¸¸é‡å­—æ®µé€šè¿‡ JVM ä¼ å‚æˆ–è€…é…ç½®æ–‡ä»¶çš„æ–¹å¼æ¥è®¾ç½®è¿‡æ»¤å™¨</p>
<p>ä¸‹å›¾å¯ä»¥çœ‹åˆ°å¦‚æœ <em><code>registryFilter</code></em> ä¸ºç©ºï¼Œæˆ–è€… checkInput æ–¹æ³•è¿”å› Status.UNDECIDED å­—é¢é‡çš„è¯åˆ™ä¼šé‡‡ç”¨ RMI é»˜è®¤çš„ JEP é˜²å¾¡è§„åˆ™ã€‚</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2052.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2052.png" alt="Untitled"></p>
<p>åœ¨æœåŠ¡ç«¯åç»­å¤„ç†åºåˆ—åŒ–æ•°æ®è¯·æ±‚ï¼ˆåŒ¹é… RegistryImpl å¯¹åº”çš„ ObjIDï¼‰æ—¶ï¼Œå¯ä»¥çœ‹åˆ° RMI é€šè¿‡ Config.setObjectInputFilter çš„æ–¹å¼è®¾ç½® RMI å±€éƒ¨è¿‡æ»¤å™¨ï¼Œ</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2053.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2053.png" alt="Untitled"></p>
<p>DGCImpl ä¸ RegistryImpl è®¾ç½®è¿‡æ»¤å™¨çš„æ–¹å¼åŸºæœ¬ä¸€è‡´</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2054.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2054.png" alt="Untitled"></p>
<ul>
<li><p>RMI JEP290 ç»•è¿‡</p>
<p>  case1: <strong>å¦‚æœæœåŠ¡ç«¯â€ç»‘å®šâ€äº†ä¸€ä¸ªå¯¹è±¡ï¼Œä»–çš„æ–¹æ³•å‚æ•°ç±»å‹æ˜¯<code>Object</code> ç±»å‹çš„æ–¹æ³•æ—¶ï¼Œåˆ™å¯ä»¥ç»•è¿‡ JEP 290</strong></p>
<p>  æœ¬è´¨ï¼šæ™®é€šå¯¹è±¡åœ¨ exportRemoteObject æ—¶ï¼Œä¸ä¼šåƒ RegistryImpl å’Œ DGCImpl ä¸€æ ·ï¼Œæ³¨å†Œå¸¦æœ‰åˆå§‹åŒ–å¥½çš„ filter åˆ° UnicastServerRef ä¸Šï¼Œè¿›è€Œåœ¨å¯¼å‡ºå¹¶å°è£…åˆ° Target çš„è¿‡ç¨‹ä¸­ï¼Œ disp å®é™…æ—¶ filter å­—æ®µä¸º null çš„ UnicastServerRefã€‚</p>
<p>  å› æ­¤ï¼Œåç»­åœ¨æ ¹æ® ObjId ä» ObjectTable ä¸­è·å– Target å disp åï¼Œå†è¿›è¡Œ dispatch è¿‡ç¨‹ï¼Œä¸Šè¿°çš„ unmarshalCustomCallData æ–¹æ³•ç”±äº filter ä¸º null å› æ­¤ä¼šç›´æ¥è¿”å› null, è¿›è€Œè°ƒç”¨ unmarshalValue æ–¹æ³•è§¦å‘åŸç”Ÿååºåˆ—åŒ–çš„ sourceï¼Œä¸å†è¿›è¡Œ filterChcek ç­‰ç±»æ£€æŸ¥æ“ä½œï¼Œç»•è¿‡äº† JEP 290 é™åˆ¶</p>
<p>  case2: å¯¹äºæ–¹æ³•å‚æ•°ç±»å‹æ˜¯ç”± Object ç±»å‹å¼•ç”³ç±»å‹ï¼ˆå¦‚ Stringï¼‰ï¼Œå¯å¦‚ä¸‹æ“ä½œï¼š</p>
<blockquote>
<ol>
<li><p>å°† java.rmi è½¯ä»¶åŒ…çš„ä»£ç å¤åˆ¶åˆ°æ–°è½¯ä»¶åŒ…ï¼Œç„¶ååœ¨å…¶ä¸­æ›´æ”¹ä»£ç </p>
</li>
<li><p>å°†è°ƒè¯•å™¨é™„åŠ åˆ°æ­£åœ¨è¿è¡Œçš„å®¢æˆ·ç«¯ï¼Œå¹¶åœ¨åºåˆ—åŒ–å¯¹è±¡ä¹‹å‰æ›¿æ¢å¯¹è±¡</p>
</li>
<li><strong>ä½¿ç”¨ Javassist ä¹‹ç±»çš„å·¥å…·æ›´æ”¹å­—èŠ‚ç </strong></li>
<li>é€šè¿‡å®ç°ä»£ç†æ¥æ›¿æ¢ç½‘ç»œæµä¸Šå·²ç»åºåˆ—åŒ–çš„å¯¹è±¡</li>
</ol>
</blockquote>
</li>
</ul>
<h2 id="0x04-Extension"><a href="#0x04-Extension" class="headerlink" title="0x04. Extension"></a>0x04. Extension</h2><ul>
<li><p>Pentest</p>
<ul>
<li><p>Discovery</p>
<p>  nmap æœåŠ¡å‘ç°ï¼Œæ”¯æŒ RMI æ³¨å†Œç«¯å£æ¢æµ‹ã€æ¥å£æ¢æµ‹ä»¥åŠå…·ä½“ä»£ç†å®ç°çš„ä½ç½®æ¢æµ‹</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2055.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2055.png" alt="Untitled"></p>
</li>
</ul>
</li>
<li><p>easycve</p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2056.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2056.png" alt="Untitled"></p>
<p class='item-img' data-src='/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2057.png'><img src="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/Untitled%2057.png" alt="Untitled"></p>
</li>
</ul>
<p>æˆ‘ä»¬åœ¨è¿œç¨‹å¤ç°æ—¶ä¼šé‡åˆ°ä¸€ä¸ª trickï¼šRMI é»˜è®¤è·å–çš„ IP åœ°å€ä¸ºä¸»æœºç½‘å¡çš„åœ°å€ï¼Œè€Œéæµè§ˆå™¨ä¸Šæ˜¾ç¤ºçš„å…¬ç½‘åœ°å€ï¼Œå› æ­¤å¯èƒ½ä¼šå‡ºç°æœåŠ¡ç«¯å¯¹è±¡æ— æ³•è°ƒç”¨çš„æƒ…å†µï¼Œå¯ä»¥åˆ©ç”¨ debugger æˆ–è€…åå°„ä¿®æ”¹ä¸€ä¸‹ LiveRef å­—æ®µ ep å±æ€§ä¸­çš„ host å€¼</p>
<h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p>[1] <a target="_blank" rel="noopener" href="https://su18.org/post/rmi-attack/">https://su18.org/post/rmi-attack/</a></p>
<p>[2] <a target="_blank" rel="noopener" href="https://boogipop.com/2023/03/02/%E6%B5%85%E5%AD%A6RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/#Step4-%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%B7%E6%B1%82%E6%9C%8D%E5%8A%A1%E7%AB%AF-%E5%AE%A2%E6%88%B7%E7%AB%AF">æµ…å­¦RMIååºåˆ—åŒ– | Boogiepop Doesnâ€™t Laugh (boogipop.com</a></p>
<p>[3] <a target="_blank" rel="noopener" href="https://github.com/mogwailabs/rmi-deserialization">mogwailabs/rmi-deserialization: Slides/Demos from the BSides Munich 2019 talk â€œAttacking Java RMI in 2019â€ (github.com)</a></p>
<p>[4] <a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/5392">JRMPå®‰å…¨é—®é¢˜åˆ†æ-ä»CVEåˆ°CTF - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2077/07/07/paper/">â† Next paperæ¢³ç†</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/">Java Sec â€”â€” åŸç”Ÿååºåˆ—åŒ– Prev â†’</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">âˆ§</a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">â‰¡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">RacerZ</a></h1><div id="description"><p></p></div><div id="social-links"><a class="social" target="_blank" rel="noopener" href="https://github.com/RacerZ-fighting"><i class="fab fa-github" alt="GitHub"></i></a><a class="social" href="qiyizhang2002@foxmail.com"><i class="fa fa-envelope" alt="E-Mail"></i></a></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Java-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI"><span class="toc-number">1.</span> <span class="toc-text">Java å­¦ä¹ ç¬”è®°â€”â€”RMI</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00-BackGround"><span class="toc-number">1.1.</span> <span class="toc-text">0x00. BackGround</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="toc-number">1.2.</span> <span class="toc-text">0x01. æºç è§£æ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C"><span class="toc-number">1.3.</span> <span class="toc-text">æœåŠ¡æ³¨å†Œ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E8%BF%9C%E7%A8%8B%E5%AF%B9%E8%B1%A1%E5%88%9B%E5%BB%BA"><span class="toc-number">1.3.1.</span> <span class="toc-text">1. è¿œç¨‹å¯¹è±¡åˆ›å»º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%88%9B%E5%BB%BA"><span class="toc-number">1.3.2.</span> <span class="toc-text">2. æ³¨å†Œä¸­å¿ƒåˆ›å»º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C"><span class="toc-number">1.3.3.</span> <span class="toc-text">3. æœåŠ¡æ³¨å†Œ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"><span class="toc-number">1.4.</span> <span class="toc-text">æœåŠ¡å‘ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-number">1.4.1.</span> <span class="toc-text">è¯·æ±‚æ³¨å†Œä¸­å¿ƒ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8"><span class="toc-number">1.5.</span> <span class="toc-text">æœåŠ¡è°ƒç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B%E6%A1%86%E6%9E%B6"><span class="toc-number">1.6.</span> <span class="toc-text">æ•´ä½“æµç¨‹æ¡†æ¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-Attack"><span class="toc-number">1.7.</span> <span class="toc-text">0x02. Attack</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%94%BB%E5%87%BB-Server-%E7%AB%AF"><span class="toc-number">1.7.1.</span> <span class="toc-text">1. æ”»å‡» Server ç«¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%94%BB%E5%87%BB-Registry-%E7%AB%AF"><span class="toc-number">1.7.2.</span> <span class="toc-text">2. æ”»å‡» Registry ç«¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%94%BB%E5%87%BB-DGC"><span class="toc-number">1.7.3.</span> <span class="toc-text">3. æ”»å‡» DGC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A6%E5%99%A8%E5%8C%96Exploit-ysoserial-%E2%80%94%E2%80%94-JRMP"><span class="toc-number">1.7.4.</span> <span class="toc-text">æ­¦å™¨åŒ–Exploit: ysoserial â€”â€” JRMP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-JEP-290"><span class="toc-number">1.8.</span> <span class="toc-text">0x03. JEP 290</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-Extension"><span class="toc-number">1.9.</span> <span class="toc-text">0x04. Extension</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">1.10.</span> <span class="toc-text">å‚è€ƒé“¾æ¥</span></a></li></ol></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside><div id="shadow-aside"></div></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>